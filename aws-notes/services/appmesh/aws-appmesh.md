# Amazon App Mesh

## 概要

**App Mesh** は AWS が提供する「**サービスメッシュ (Service Mesh)**」のマネージドサービス。

マイクロサービスアーキテクチャにおける「サービス間通信」を制御・可視化する仕組みを提供。

## 主要機能

### 1. サービス間通信の可視化
- **モニタリング**: 各マイクロサービス間のリクエストの流れを監視
- **統合**: CloudWatch, X-Ray などと統合して「どのサービスが遅いか」を把握

### 2. 通信制御 (トラフィックシェーピング)
- **A/Bテスト**: サービスのバージョンを A/B テスト的に切り替え
- **Canaryリリース**: 一部のトラフィックだけ新バージョンに流す
- **ルーティング**: リクエストのルーティングを細かく制御

### 3. セキュアな通信
- **暗号化**: サービス間通信を mTLS (相互TLS) で暗号化
- **証明書管理**: IAM / ACM と連携して証明書管理

## 対応プラットフォーム

- **ECS**（EC2/Fargate）
- **EKS**（Kubernetes）
- **EC2ベースのマイクロサービス**

> 要は「マイクロサービスを AWS 上で動かすとき、その間の通信を一元管理できる」

## メリット（試験視点）

- **可観測性**: メトリクス、ログ、トレーシング
- **運用簡略化**: コード変更なしで通信制御
- **デプロイ容易化**: Canary / Blue-Green / トラフィック分割
- **セキュリティ**: mTLSによる通信暗号化

> **App Mesh** = マイクロサービスの通信を見える化＆制御するサービスメッシュ基盤

## サービス間通信の暗号化

### 背景
通常、マイクロサービス間の通信は VPC 内に閉じているとはいえ「平文のHTTP」でやりとりされがち。

セキュリティ要件（金融・医療・大規模サービスなど）では、内部通信も暗号化して相互認証が必要なケースがある。

> そこで使うのが **mTLS (Mutual TLS, 相互TLS)**

### mTLS (相互TLS) とは？

| 種類 | 認証方式 |
|------|----------|
| **通常の TLS (HTTPS)** | クライアントがサーバーの証明書を検証するだけ |
| **mTLS** | クライアントもサーバーもお互いに証明書を提示・検証 |

#### 結果
- **通信の暗号化**
- **両者の認証（なりすまし防止）**

> つまり「本物のサービス間通信」だけを許可できる

### App Mesh での mTLS 実現

#### 1. 証明書の発行・管理
- **連携**: AWS Certificate Manager (ACM) または ACM Private CA と連携
- **配布**: サービスごとに証明書を配布

#### 2. 認証・認可
- **仲介**: App Mesh が Envoy プロキシを使って通信を仲介
- **実行**: Envoy が証明書を使って mTLS のハンドシェイクを実行
- **検証**: 証明書の有効性を検証して「このサービスは正規の相手か？」を確認

#### 3. IAM連携
- **制御**: IAMポリシーで「どのサービスがどの証明書を利用できるか」を制御
- **防止**: 権限のないサービスが証明書を使って通信することを防止

#### メリット
- **暗号化**: 通信の盗聴・改ざん防止
- **認証**: サービス間のなりすまし防止（相互認証）
- **運用**: AWSの証明書管理機能（ACM）と統合 → 運用が楽

> App Meshは、mTLSでサービス間通信を暗号化し、IAM/ACMと連携して証明書を安全に配布・管理する仕組みを提供

## App Mesh が担う4つの役割

### 1. 可視化（Observability）
- **機能**: 各マイクロサービス間の通信をトレース、モニタリング
- **統合**: CloudWatch, X-Ray, Prometheus などと統合
- **把握**: 「どのサービスが遅いか・落ちてるか」がわかる

> **役割**: モニタリングツールの役割

### 2. トラフィック制御（Traffic Routing）
- **デプロイ**: Canary リリースや Blue/Green デプロイ
- **振り分け**: トラフィックを「80%を旧バージョン、20%を新バージョン」に振り分け
- **自動化**: フェイルオーバーやリトライポリシーの自動適用

> **役割**: ロードバランサー＋リリース管理の役割

### 3. セキュリティ（Security）
- **暗号化**: サービス間通信を mTLS で暗号化
- **管理**: IAM/ACMと連携して証明書を管理し、認証・認可を実現

> **役割**: ゼロトラスト的な通信制御の役割

### 4. ポリシー適用（Policy Enforcement）
- **ルール設定**: 「このサービスはAには行けるけどBには行けない」みたいな通信ルールを設定
- **アクセス制御**: IAM と組み合わせてきめ細かいアクセス制御

> **役割**: ネットワークACLやセキュリティグループ的な役割

## まとめ

**App Mesh** は以下をまとめて担えるサービス：
- ロードバランサー
- セキュリティ制御
- 可視化ツール
- デプロイ管理

> **特徴**: 「複数の役割をこなせる」包括的なサービスメッシュソリューション