# Amazon Route 53

## DNSと名前解決

### 基本的なDNSの役割

**DNSの基本的な役割は「名前解決」** = `www.example.com` → IPアドレス に変換すること

### Route 53の拡張機能

AWS の **Route 53** は名前解決の拡張機能として**ルーティングポリシー**を持っていて、単なるIP変換以上のことが可能

**「どのIPアドレスを返すか」をただ固定するのではなく、重み付けやヘルスチェックを見て動的に切り替える**

## Route 53 のヘルスチェック

### 機能

- **Route 53 自体が HTTP/TCP/HTTPS でターゲットにリクエストを投げて監視できる機能**
- もし「**Unhealthy**」と判定されたら、そのIPを**DNS応答から外す**
- これによって「**DNSレベルでのフェイルオーバー**」が可能

## ALBとの違い

### ALBのヘルスチェック

- **ALB配下のターゲット**（EC2やECSタスク）を監視
- Unhealthyなターゲットに**トラフィックを流さない**
- **L7ロードバランシング**をしてくれる

### Route 53のヘルスチェック

- **DNSレベルで監視**し、IPアドレス自体を返すか返さないかを制御
- L7ロードバランシングではなく「**どのIPを返すか**」に限定

### 役割分担

| サービス | 役割 | 特徴 |
|----------|------|------|
| **ALB** | インスタンス単位のトラフィック制御 | 負荷分散の本命 |
| **Route 53** | DNS応答レベルでの制御 | フェイルオーバーやマルチリージョン冗長化に強い |

## DNSルーティングとは

**「DNSルーティング」= Route 53が名前解決時にどの宛先を返すかを制御すること**

- **「DNS = 単なる名前解決だけ」ではない**
- **Route 53**なら「加重・地理的・レイテンシーベース・フェイルオーバー」などの**ポリシー付き解決**ができる

## まとめ

- **ヘルスチェック**は ALB でもできるが、**Route 53自身もHTTP/TCPでヘルスチェックを持っている**
- **DNS = 名前解決** は正しい
- **Route 53のDNSルーティング** = 名前解決を拡張して、**ヘルスチェックや負荷分散を組み合わせて動的に制御する仕組み**

## フェイルオーバーポリシー

### 概要

**プライマリ（優先ターゲット）とセカンダリ（バックアップ）を定義するルーティングポリシー**

### 動作

- プライマリに対して **Route 53 ヘルスチェック**を設定
- **プライマリが Healthy** → プライマリにのみルーティング
- **プライマリが Unhealthy** → セカンダリに切り替え

### 制限事例

#### 要件
- EC2インスタンスが2台ある
- どちらかに障害が出たら、もう一方にだけ流したい
- **普段は冗長化された構成を両方で利用したい**（均等に使いたい）

#### フェイルオーバーポリシーだけだと...

- 片方を「**プライマリ**」、もう片方を「**セカンダリ**」にする
- **常にプライマリにしか流れず、セカンダリは待機専用**
- **「普段は2台を均等利用」はできない**

### 解決策: 加重ルーティングとの組み合わせ

#### 「両方均等＋障害時に片方に寄せたい」場合

1. **加重ルーティング（Weighted Routing）**を使って、2台に **50:50 で分散**
2. それぞれに **Route 53 ヘルスチェック**を設定
3. **Unhealthy な方は自動的に除外**され、残りのHealthy側だけにトラフィックを流す

> **結果**: 「通常は両方使う、障害時は片方にフェイルオーバー」が実現

## アクティブ–パッシブ（Active–Passive）

### 構成

**フェイルオーバーポリシー**を使う

### 特徴

- **プライマリ（Active）が常用**、セカンダリ（Passive）は待機
- プライマリが落ちたら**ヘルスチェックで自動的にセカンダリに切り替え**
- **典型的な DR構成**（災害対策）

> **例**: 東京リージョンを常用、障害時だけ大阪リージョンに切替

## アクティブ–アクティブ（Active–Active）

### 構成

**加重ルーティング（Weighted Routing）**や**レイテンシーベースルーティング（Latency-based Routing）**を使う

### 特徴

- **複数のリージョンやインスタンスを同時に利用**
- それぞれに **Route 53 ヘルスチェック**を設定して、Unhealthy なものは除外
- **普段は両方に振り分け、障害時は残ったHealthy側だけで稼働**

> **例**: 東京とシンガポールの両方にトラフィックを分散し、どちらか落ちたらもう一方だけ使う

## 構成比較表

| 構成 | 方法 | 普段の状態 | 障害時の挙動 | ユースケース |
|------|------|-----------|-------------|--------------|
| **アクティブ–パッシブ** | フェイルオーバーポリシー | プライマリのみ稼働 | セカンダリに切替 | DR（バックアップ専用） |
| **アクティブ–アクティブ** | 加重ルーティング or レイテンシーベース | 両方稼働 | Unhealthy除外して片方で稼働 | グローバル配信、高可用性 |

## Active–Active を実現する方法

**Route 53 の加重ルーティング（Weighted Routing）やレイテンシーベースルーティングを使えば、複数のターゲットを同時に「Active」にできる**

### 例: 加重ルーティング

1. **インスタンスAに重み50、インスタンスBに重み50** → 均等分散
2. **それぞれにヘルスチェックを設定** → 落ちた方は自動で除外

> **結果**: 普段は2台を均等利用、障害時は片方にフェイルオーバー

### 例: レイテンシーベースルーティング

1. **東京リージョンとシンガポールリージョンの両方をActiveに設定**
2. **ユーザーから近い方に応答**（レイテンシが低い方を選択）
3. **どちらかのリージョンが落ちたら、残った方に自動で切替**

Route 53 が DR でよく使われる理由

フェイルオーバーの仕組みを持っている

フェイルオーバールーティングポリシーを使えば、

プライマリ（本番環境）がヘルスチェックで落ちたら

セカンダリ（DR環境）に自動的に切り替えできる

ヘルスチェック機能

Route 53 自体が HTTP/TCP/HTTPS で監視できる

障害を検知したら DNS 応答から Unhealthy なリソースを外す

マルチリージョン構成に強い

東京リージョンと大阪リージョン（または海外リージョン）をまたいだ構成でも対応可能

「東京が落ちたら大阪に切替」という定番DR構成が実現できる

組み合わせの柔軟性

フェイルオーバーポリシー → Active–Passive（DR環境は待機）

加重ルーティング or レイテンシーベース → Active–Active（両方稼働）

Route 53 の役割

DNSベースのルーティングサービス

ユーザーからの名前解決要求に対して「どのIPアドレスを返すか」を制御する

フェイルオーバー / 加重 / レイテンシーベース / ジオロケーション などのルーティングポリシーをサポート

DR では「障害時にどのリージョンに切り替えるか」を決めるスイッチ役

 欠点：DNSキャッシュがあるため切り替えに 数十秒〜数分の遅延 が起こることもある

 Global Accelerator の役割

DNSではなく Anycast IP アドレスを使ったグローバルルーティングサービス

ユーザーは固定のグローバルIPに接続し、そこから最適なAWSリージョンのエンドポイントに転送される

Route 53 よりも高速かつシームレスに切替可能（DNSキャッシュの問題なし）

ALB / NLB / EC2 インスタンスをエンドポイントにできる

 メリット：

障害時の切替がほぼリアルタイム

ユーザーは常に同じ IP にアクセスするので、アプリ側設定がシンプル

AWS グローバルネットワークを経由するのでレイテンシも低下

Route 53 + Global Accelerator

Route 53 = 「どのDRリージョンを使うか」決定（DNSルーティング）

Global Accelerator = 「選ばれたリージョンの中で最適なエンドポイントへ超低遅延で接続」

例：東京と大阪リージョンにDR環境を用意し、Route 53でリージョン切替、GAでリージョン内の最適エンドポイントに転送

Route 53だけ

安価・シンプル

切替に多少のDNS伝播遅延があってもOKな場合（数分レベルのRTO/RPOでも許容できるシステム）

Global Accelerator

DNSキャッシュに依存せず、即時に切替したい場合

グローバルユーザーを相手にしていて、レイテンシを最小化したい場合

金融・動画配信・ゲームなど、ダウンタイムや遅延が許されないシステム

コールドスタンバイ（Cold Standby / Backup & Restore 型）

仕組み

バックアップデータを Amazon S3 に保存しておく

システムの AMI（イメージ）やスクリプトを事前に用意しておく

災害時に必要なリソース（EC2, RDS, etc.）を起動して環境を復旧

最後に Route 53 で切替

特徴

- **コスト最小**（普段はストレージ代だけ）
- **復旧に時間がかかる**（RTOは長い、RPOはバックアップ取得時点まで）
- **小規模システムやコスト重視の環境で採用**

## ウォームスタンバイ（Warm Standby）

### 仕組み

- **DR側に「最小限のスタンバイ環境」を常時稼働**
- **データは本番から常時レプリケーション**（例: RDS リードレプリカ, DynamoDB Global Tables, S3 CRR）
- **災害時は必要に応じてスケールアウトし、本番規模に拡張**
- **切替は Route 53 で迅速に可能**

### 特徴

- **コールドより復旧が早い**（RTOは短い）
- **ただしコストは高め**（スタンバイ環境を常時稼働するため）
- **ミッションクリティカルなシステムでよく使われる**

## DR戦略の位置付け

### DR戦略の代表的な4つのパターン

1. **バックアップ & リストア**（最安・復旧遅い）
2. **パイロットライト**（最小構成だけ常時稼働、必要に応じて拡張）
3. **ウォームスタンバイ**（縮小版の本番を常時稼働、拡張して復旧）
4. **マルチサイト / アクティブ–アクティブ**（両方常時稼働、切替不要）

### 戦略の関係性

- **「コールドスタンバイ」** = 「バックアップ & リストア」寄り
- **「ウォームスタンバイ」** = 「パイロットライト」と「アクティブ–アクティブ」の中間的なイメージ

### 比較

| 戦略 | コスト | 復旧速度 | 特徴 |
|------|--------|----------|------|
| **コールドスタンバイ** | 最小 | 遅い | Route 53 で素早く切替 |
| **ウォームスタンバイ** | 高め | 速い | Route 53 で素早く切替 |

## DR戦略とアクティブ–アクティブ/パッシブの対応関係

### コールドスタンバイ（Backup & Restore）

- **普段はDR環境を使わない**
- **障害時にだけ環境を立ち上げて切替**

> **対応**: アクティブ–パッシブ（パッシブ側は完全停止に近い）

### ウォームスタンバイ（Warm Standby）

- **DR環境に縮小構成を常時稼働させる**
- **障害時にスケールアップして本番化**

> **対応**: アクティブ–パッシブ寄り（パッシブ側も少し動いている）

### パイロットライト（Pilot Light）

- **DR側に最小限のインフラ**（DBだけなど）を常時稼働
- **災害時に残りを立ち上げる**

> **対応**: これもアクティブ–パッシブの一種

### マルチサイト / アクティブ–アクティブ（Multi-site / Active–Active）

- **本番とDRの両方を常時稼働**
- **普段からトラフィックを分散**

> **対応**: アクティブ–アクティブそのもの

## DR戦略とアクティブパターンのまとめ

| アクティブパターン | 対応するDR戦略 |
|-------------------|----------------|
| **アクティブ–パッシブ** | コールドスタンバイ / ウォームスタンバイ / パイロットライト |
| **アクティブ–アクティブ** | マルチサイト構成 |