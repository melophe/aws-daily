# Amazon FSx

## 概要

**AWSが提供する「フルマネージドのファイルサーバー」**

普段オンプレでよく使われる商用・オープンソースのファイルシステムを、クラウド上でそのまま使えるようにしたサービス群。

### 使用パターン

#### ① AWS内だけで使う

複数のEC2やECSタスクから同じファイルを読み書きしたいとき

**例:**
- 機械学習のトレーニングデータをFSxに置いて、複数GPUインスタンスで同時にアクセス
- HPCクラスタ（ParallelClusterなど）で中間データを共有

> この場合は **クラウド内の共有ファイルサーバー** として使うイメージ

#### ② オンプレとAWSで共有する

オンプレ側のユーザーやサーバーからも、AWS上のFSxにアクセス可能

**例:**
- オンプレのWindowsユーザーが「ネットワークドライブ」としてFSx for Windowsに接続
- オンプレのLinuxサーバーが NFS で FSx for OpenZFS や FSx for ONTAP に接続
- 通常は Direct Connect や VPN でオンプレとAWSをつなぐ

> この場合は **オンプレとAWSのハイブリッドファイルサーバー** として使うイメージ

> 名前の「for …」の後ろに、対応するファイルシステムの種類がつく

### FSxでできること

#### ファイルを保存する
- 普通のファイルサーバーみたいに使える
- EC2やオンプレPCから「ネットワークドライブ」としてマウント可能

#### ファイルを共有する
- 複数のEC2、オンプレサーバー、ユーザーが同時アクセス可能
- **例**: 研究チームが同じデータセットにアクセス、複数アプリが共通ファイルを読む

#### 高速アクセスする（種類による）
- **FSx for Lustre** → HPCやMLの巨大データを超高速にI/O
- **FSx for Windows** → WindowsのSMB共有（Active Directory連携）
- **FSx for NetApp ONTAP** → NFS/SMB/iSCSIなど多様なプロトコル

### S3 vs FSx の違い

| | 特徴 |
|---|---|
| **S3** | オブジェクトストレージ（ファイル置き場だけど、POSIX互換じゃない） |
| **FSx** | ファイルシステム（EC2やユーザーがマウントして「普通のフォルダ」として使える） |

## 主な種類

### Amazon FSx for Windows File Server

- **概要**: Windows Serverのファイルサーバーをマネージドで提供
- **プロトコル**: SMB (Server Message Block)
- **統合**: Active Directory と統合可能（NTFS ACL対応）
- **用途**: Windowsアプリやユーザーのファイル共有に最適

### Amazon FSx for Lustre

- **概要**: HPC（ハイパフォーマンスコンピューティング）や機械学習向けの超高速ファイルシステム
- **HPC環境**: 大量のデータや複雑な計算を並列処理や分散処理で超高速に実行する仕組み
- **ベース**: オープンソース Lustre ベース
- **パフォーマンス**: 数百GB/秒レベルのスループット、低レイテンシでI/O性能が高い
- **用途**: 科学技術計算や金融シミュレーション
- **S3統合**: Amazon S3と統合でき、S3上のデータをそのままLustreにマウントして高速処理可能

### Amazon FSx for NetApp ONTAP

- **概要**: NetApp ONTAP ファイルシステムをマネージドで提供
- **プロトコル**: NFS, SMB, iSCSI
- **機能**: NetAppの重複排除・圧縮・スナップショットなどをそのまま利用可能
- **用途**: オンプレのNetApp環境とのハイブリッド構成に便利

### Amazon FSx for OpenZFS

- **概要**: オープンソース ZFS ファイルシステムベース
- **プロトコル**: NFS
- **特徴**: スナップショット、コピーオンライト、効率的なバックアップに強い

## 使い分けの指針

| サービス | プロトコル | 主な用途 |
|---------|-----------|----------|
| **Windows File Server** | SMB | Windows環境向けファイル共有 |
| **Lustre** | POSIX | HPC向け高速処理 |
| **NetApp ONTAP** | NFS, SMB, iSCSI | 企業のNetApp資産をAWSへ移行 |
| **OpenZFS** | NFS | ZFSベースの柔軟なファイル管理 |

## FSx for Lustre のデプロイメントオプション

### スクラッチファイルシステムとは？

**一時的な作業用ストレージ** - 「スクラッチ（scratch）」= 「引っかき書き」「使い捨て」の意味

計算ノードがジョブを実行するときに、途中結果や中間データを一時的に保存するための高速ストレージ。HPCでは計算が終われば不要になるデータが多いので、「消えても良い」前提。

> **なぜストレージが必要？** HPCで扱うデータは数百GB〜数PB級の巨大データだから

### 1. Scratch File System（スクラッチ・ファイルシステム）

**特徴:**
- 一時的なワークロード向け
- 高スループット・低レイテンシ
- 耐久性が低い（ハードウェア障害でデータが失われる可能性あり）

**使いどころ:**
- HPCの中間データ保存
- 一度のシミュレーションや分析処理のワークスペース

### 2. Persistent File System（永続・ファイルシステム）

**特徴:**
- 高耐久（マルチAZ配置やデータ冗長化で耐障害性あり）
- データを長期保持できる
- コストはスクラッチより高め

**使いどころ:**
- 研究データや機械学習の学習データセットを長期保存
- 継続的に参照される分析用データ

## EFS vs FSx の使い分け

### EFS (Elastic File System)
- **特徴**: AWSが作った「標準の共有フォルダ」
- **対象**: Linux用の汎用NFS共有ストレージ
- **設計**: Linuxからすぐ使える、シンプル設計
- **適用**: 何もこだわらなければこれで十分

### FSx (File System for X)
- **特徴**: 特定用途に特化した「専用のファイルサーバー」
- **対象**: 特定のファイルシステムをAWSでマネージド提供するサービス群

**用途別選択:**
- WindowsのSMBが必要 → **FSx for Windows**
- 超高速I/O（HPC/ML）が必要 → **FSx for Lustre**  
- NetApp資産と統合したい → **FSx for ONTAP**
- ZFSが欲しい → **FSx for OpenZFS**

Amazon FSx for Lustreの永続的ファイルシステムは、スクラッチファイルシステムと比較してネットワークパフォーマンスが劣ります。この永続的ファイルシステムは、長期的なストレージとワークロードに特化して設計されています。ファイルサーバーは高い可用性を持ち、データはファイルシステムが存在するアベイラビリティーゾーン内で自動的に複製されます。
Amazon FSx for Windowsは、ハイパフォーマンスコンピューティングのためのストレージとしては最適化されていません。