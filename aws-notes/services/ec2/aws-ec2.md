# AWS EC2

## AMI (Amazon Machine Image)

### 概要

**EC2インスタンスを起動するためのテンプレート（イメージ）**

### AMIに含まれるもの

- **OSイメージ**（Amazon Linux, Ubuntu, Windows Server など）
- **アプリケーションやミドルウェア**（Apache, MySQL などをあらかじめ入れておける）
- **設定情報**（起動時のボリューム設定、アクセス権限など）

> **Point**: AMIがあれば**同じ構成のインスタンスを何台でも複製して起動できる**仕組み

### AMIの種類

| 種類 | 説明 | 例 |
|------|------|-----|
| **AWS提供のAMI** | Amazon Linux, Ubuntu, Windows Server などの基本OSが入ったもの | Amazon Linux 2, Ubuntu 22.04 |
| **Marketplace AMI** | サードパーティが提供する商用ソフト入りのイメージ | Red Hat, Trend Micro |
| **カスタムAMI** | 自分で作成したAMI | ミドルウェアやライブラリをあらかじめセットアップしたAMI |

### ユースケース

#### 環境の標準化
テスト用インスタンスを作ってセットアップ → AMI化 → 本番用に複製

#### 復旧・バックアップ
障害時にAMIからすぐ新しいインスタンスを立ち上げられる

#### オートスケーリング
ASGで新しいインスタンスを増やすとき、AMIをベースに起動する

### まとめ
- **AMI** = EC2インスタンスの設計図（テンプレート）
- **OSやアプリ込みで保存**できる
- **複製・スケール・復旧に便利**

## Launch Template

### 概要

**EC2インスタンスの起動設定をテンプレート化したもの**

簡単に言うと、**AMI + インスタンスタイプ + ネットワーク設定 + キーペア** などをまとめて保存した設計図

### 含まれる情報

- **AMI ID**（どのOS/イメージを使うか）
- **インスタンスタイプ**（t3.micro, m5.large など）
- **キーペア**（SSH接続用）
- **セキュリティグループ**
- **IAMロール**
- **ユーザーデータ**（起動時スクリプト）
- **タグ**
- **その他設定**

### 使いどころ

- **毎回同じ設定でインスタンスを立ち上げたいとき便利**
- **Auto Scaling Group (ASG) や EC2 Fleet のベース設定**に使う
- **設定をバージョン管理**できる（v1, v2, … と作れる）

### Launch Configuration との違い

| 項目 | Launch Configuration | Launch Template |
|------|---------------------|-----------------|
| **更新** | 更新できない（作り直しが必要） | バージョン管理できる |
| **柔軟性** | 基本機能のみ | 柔軟性が高い |
| **推奨度** | 旧式 | **現在推奨** |

### 関係性まとめ

- **AMI** = OSやソフト入りのイメージ
- **Launch Template** = インスタンス起動の設計図
- **ASG** = インスタンスを自動的に増減させるときの「ひな型」に使用

## Launch Permission

### 概要

AMIには「**このAMIを使ってEC2インスタンスを起動できる人**」を制御する設定がある

### 設定できる範囲

| 設定 | 説明 | 用途 |
|------|------|------|
| **自分のアカウントだけ** | デフォルト設定 | 個人用・機密情報あり |
| **特定のAWSアカウントに共有** | 指定したアカウントIDのみ | チーム間共有 |
| **全員に公開（public AMI）** | 誰でも使用可能 | オープンソース・公開用 |

### 具体例

#### アカウント間共有
```
自分のアカウントで作ったカスタムAMI
↓
他のチームのAWSアカウントでも使えるようにしたい
↓
Launch Permission でそのアカウントIDを追加すればOK
```

#### 公開AMI
Amazon公式AMI（Amazon Linuxなど）は **public 設定**なので誰でも使える

### 注意点

- **Launch Permission** は「AMIを起動できるかどうか」だけの制御
- 実際の起動時には、当然ながら **EC2起動権限（IAMポリシー）** も必要
- **MarketplaceのAMI** は Launch Permission が「ベンダー管理」で、自分では変更できない

### まとめ

- **Launch Permission** = AMIを誰が使えるかの権限設定
- **3つのパターン**: 個人用 / アカウント共有 / 公開
- **AMIの「配布範囲」を決める機能**

## オンデマンドインスタンスのキャパシティー予約

### オンデマンドキャパシティ予約 (On-Demand Capacity Reservations)

**EC2の特定のインスタンスタイプやAZに対してキャパシティ（枠）を予約する機能**

- 料金は**オンデマンド課金**（通常のインスタンスと同じ従量課金）
- つまり「**予約してキャパシティを確保するけど、割引はない**」仕組み

### 使用場面

**「必ずこのAZの m6i.large が使えるようにしたい」場合に便利**

- **例**: 月末やイベント時に必ずインスタンスが必要なシステム
- 通常のオンデマンドだと「キャパシティ不足で起動できない」ことがあり得るが、この予約で解決できる

### リザーブドインスタンス (RI) との違い

| 項目 | オンデマンドキャパシティ予約 | リザーブドインスタンス (RI) |
|------|------------------------------|----------------------------|
| **割引** | なし（オンデマンド料金） | 最大72%割引あり |
| **キャパシティ確保** | あり | スタンダードRIは「割引のみ」、キャパシティは保証されない |
| **柔軟性** | いつでも作成・削除できる | 1年 or 3年契約 |
| **請求** | 実際にインスタンスを起動した分だけ | 契約分は常に課金（利用しなくても） |

### Savings Plans との違い

- **Savings Plans** = 「時間単位で一定利用額をコミットすることで割引される」仕組み
- **キャパシティを確保する機能はない**

> **まとめ**: **キャパシティ確保** = キャパシティ予約、**コスト削減** = RI / Savings Plans と役割が分かれている

## EC2の詳細モニタリング (Detailed Monitoring)

### 仕組み

EC2 は CloudWatch にメトリクスを自動で送信するが、**2つのモード**がある

#### 基本モニタリング (Basic Monitoring)
- **デフォルト**
- **5分間隔**でメトリクス（CPU利用率、ネットワーク、ディスクなど）が収集される

#### 詳細モニタリング (Detailed Monitoring)
- **オプションで有効化**
- **1分間隔**でメトリクスが収集される
- よりきめ細かい監視や、スケーリングのトリガーに使いやすい

### 追加コスト

- **詳細モニタリング**: 有料オプション（CloudWatch料金として課金される）
- **基本モニタリング**: 無料

### ユースケース

#### Auto Scalingの反応を早くしたい
→ 5分単位だとスケールアウトが遅れるため、1分単位でメトリクスが欲しい

#### アプリのSLA監視
→ 細かい粒度でCPUやネットワークの使用率を可視化したい

### まとめ

**EC2の詳細モニタリング = CloudWatchメトリクスを1分間隔で収集する有料オプション**

- デフォルトは5分間隔（基本モニタリング）
- **スケーリングや監視の精度を上げたいときに有効**

### メトリクス項目について

#### 1. 出るログの「種類」は変わらない
- **標準モニタリング（5分間隔）と詳細モニタリング（1分間隔）で取れるメトリクス項目は同じ**
- **例**: CPUUtilization, NetworkIn, DiskReadOps など

> **注意**: 「ログのレベルや種類が増える」わけではない

#### 2. 違うのは「送信頻度（解像度）」
- **標準**: 5分おき
- **詳細**: 1分おき

> **特徴**: より「こまかく」監視できるようになるだけ

### 使いどころ

- **スパイクが短時間で発生するようなワークロード**
- **オートスケーリングの精度を上げたいとき**
- **SLAや運用ポリシーで細かい監視が求められるとき**