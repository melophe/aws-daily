# AWS Lambda

## 概要

サーバーを意識せずにコードを実行できる「サーバーレスコンピューティングサービス」

AWSがサーバーのプロビジョニングやスケーリング、管理をすべて担当するため、開発者は処理したいコードのみを書けばよい

---

## 特徴

### イベント駆動型
以下のイベントをトリガーに自動実行：
- S3にファイルがアップロード
- DynamoDBにデータが追加
- API Gateway経由でリクエストが到達

### サーバー管理不要
- EC2のようにインスタンスを立てて運用する必要なし
- OS管理、パッチ適用なども不要

### 自動スケーリング
- リクエスト数に応じて並列に自動でスケール
- 1秒に1リクエストでも、1秒に1万リクエストでも対応可能

### 従量課金制
- 実行時間（ミリ秒単位）と実行回数に応じて課金
- 使わなければコストはほぼゼロ

---

## よくあるユースケース

- 画像や動画のサムネイル生成（S3にアップロードされたら実行）
- APIのバックエンド処理（API Gateway + Lambda）
- IoTデバイスからのデータ処理
- サーバーレスバッチ処理
- CloudWatch Eventsでのスケジュール処理（cron代わり）

---

## Lambda Layer

### 概要
複数のLambda関数で共通して使うコードやライブラリをまとめて管理できる仕組み

「共通処理をパッケージ化して、何度もコピペせずに使い回せる場所」

### できること
- 共通のライブラリ（requests, boto3のカスタムバージョン等）をLayerに入れて共有
- 共通のユーティリティコード（ロギング処理、認証処理等）をまとめて使い回し
- デプロイパッケージを小さくする（関数ごとに同じ依存ライブラリを入れる必要がなくなる）

### メリット
- **重複削除**: 複数のLambdaに同じコードをコピーする必要がない
- **メンテナンス性向上**: バグ修正やライブラリアップデートをLayer側で行えば一気に全関数に反映
- **デプロイ効率向上**: 各Lambda関数のZIPを軽量化でき、更新も高速

### 制約
- 1つのLambda関数に最大5つまでLayerをアタッチ可能
- Layerのサイズ上限は50MB（zip圧縮後）
- バージョン管理（更新すると新しいバージョン番号が付く）

### 利用例
「共通ログ処理」をLayer化する場合：
1. logger.pyをLayerにまとめる
2. Layerを作成してLambdaにアタッチ
3. 各関数では`import logger`すれば利用可能

---

## カスタムランタイム

### 概要
AWS Lambdaには公式でサポートされているランタイム（Node.js, Python, Java, Go, .NET, Ruby等）があるが、サポート外の言語や独自の実行環境を使いたい場合に自分で用意する仕組み

### 仕組み
- Lambdaは「呼び出しイベントをJSONで渡し、処理結果をJSONで返す」仕組みが共通
- カスタムランタイムでは、このやりとりを行うランタイムAPIに対応するブートストラップ（bootstrap）実行ファイルを自分で用意
- bootstrap内で好きな言語処理系やフレームワークを呼び出せば、どんな言語でもLambda上で実行可能

### 使用場面
- **公式非対応の言語**: PHP, Rust, Swift, Erlang等
- **特定のランタイムバージョン固定**: 公式サポートが終了した古いPython/Node.jsを自分で持ち込み
- **独自フレームワークやライブラリ組み込み**: 高度にカスタマイズされた実行環境

### 作成手順
1. bootstrapファイルを作成（イベントを受け取り、アプリケーションコードを呼び出し、結果を返す処理）
2. それをZIPにまとめてLayerとしてデプロイ
3. Lambda関数にそのLayerをアタッチし、「カスタムランタイム」として指定

### 具体例：RustをLambdaで使う
1. Rustでバイナリをコンパイル
2. bootstrapにRustバイナリを呼び出す処理を記述
3. それをLayerとして登録 → Lambda関数で利用可能

---

## Lambda Invocation の種類

Lambda関数の呼び出し方には大きく分けて3種類

### 1. 同期呼び出し (Synchronous Invocation)

#### 特徴
- 呼び出したクライアントがレスポンスを待つ
- 完了まで結果を返す

#### ユースケース
- API Gateway → Lambda
- CLIからの直接呼び出し

#### 例
```bash
aws lambda invoke --function-name MyFunction response.json
```

### 2. 非同期呼び出し (Asynchronous Invocation)

#### 特徴
- 呼び出し側はすぐに応答を受け取る（結果は待たない）
- Lambdaは裏でイベントを処理し、結果をログやDLQに送信
- 処理失敗時は再試行が行われる（最大2回、合計3回実行）

#### ユースケース
- S3イベント → Lambda
- SNS → Lambda

### 3. イベントソースマッピング (Event Source Mapping)

#### 特徴
- Lambdaが自動でポーリングしてデータを処理する仕組み
- Lambdaが内部的に「同期呼び出し」するイメージ

#### 対象サービス
Kinesis, DynamoDB Streams, SQS等

#### ユースケース
メッセージキューやストリーム処理

---

## まとめ

### Lambda の特徴
- サーバーレスでイベント駆動のコード実行サービス
- 自動スケーリング、サーバー管理不要、従量課金
- 用途：ファイル処理、APIバックエンド、バッチ、IoT等幅広く活用

### 呼び出し方式の使い分け

| 方式 | 特徴 | 用途 |
|------|------|------|
| **同期呼び出し** | レスポンス待ち | API Gateway、CLI |
| **非同期呼び出し** | すぐ応答、裏で処理 | S3、SNS |
| **イベントソースマッピング** | 自動ポーリング | SQS、Kinesis、DynamoDB Streams |