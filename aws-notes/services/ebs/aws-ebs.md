# Amazon EBS (Elastic Block Store)

## 基本概要

### 利用対象
- **対応**: EC2で使うストレージ
- **制限**: ECSでは直接使えない（EC2起動タイプなら使える）

### 特徴
- **データ共有**: EBSはインスタンス間でデータ共有できない
- **冗長性**: EBSボリュームは単体でも冗長化されている
  - AZ内で自動的にレプリケート
  - ディスク障害から保護される

### 性能の制約と解決策
- **制約**: 「IOPS」や「スループット」はボリュームサイズや種類に依存
- **解決策**: より高性能が欲しいときに「複数EBSをRAIDで束ねる」手法が使われる

## EBSと組み合わせるRAIDの種類

EBSではよく次のRAIDレベルが使われます：

### 1. RAID 0（ストライピング）

#### 特徴
- 複数EBSにデータを分散して並列書き込み

#### メリット・デメリット
- **メリット**: IOPSとスループットが n倍 に向上（例: 4本で4倍速）
- **デメリット**: 耐障害性なし（1本壊れると全体アウト）

#### ユースケース
- 高性能キャッシュ領域
- 一時データ処理（例: 大規模データの並列処理）

### 2. RAID 1（ミラーリング）

#### 特徴
- 同じデータを複数EBSに複製

#### メリット・デメリット
- **メリット**: 冗長性が高い（1本壊れても生存）
- **デメリット**: 容量効率が50%（2TBで実効1TB）

#### ユースケース
- 可用性を重視するOLTP系DB

### 3. RAID 10（1+0）

#### 特徴
- RAID 0 と RAID 1 を組み合わせ（ミラーされたペアをストライピング）

#### メリット・デメリット
- **メリット**: 性能と耐障害性を両立
- **デメリット**: 容量効率は50%

#### ユースケース
- 高スループットが必要なDB（MySQL, Oracle など）

## AWS公式の推奨事項

### 推奨されるRAIDレベル
- **RAID 0**: 性能を最大化したいとき
- **RAID 1/10**: データ保護も求められるとき

### 推奨されないRAIDレベル
- **RAID 5/6**: 書き込み性能が低下し、EBSの冗長性と二重になって非効率

## 実装・運用の注意点

### 実装方法
- **OS レベルで実装**: EC2内でmdadmなどを使う

### 運用上の注意
- **RAID 0 利用時**: 「バックアップ必須」（EBSスナップショットを組み合わせる）
- **代替案**: EBSの**プロビジョンドIOPS（io1/io2）**を選べば、RAIDを使わずに高性能を得られる場合も多い

## 用途別の使い分け

| 目的 | 推奨RAID | 理由 |
|------|----------|------|
| **可用性向上・RTO短縮** | RAID 1 | 冗長性を重視 |
| **性能向上** | RAID 0 | 読み書きを高速化（ストライピング） |

## ストライピング（RAID 0）の仕組み

### ストライピングとは？

**データを「小さなブロック」に分割して、複数のディスクに並列に書き込む/読み込む方式**

> **例え**: 「1本の道に全部の車を通すんじゃなくて、複数車線に分散して同時に流す」イメージ

### 具体例: 2本のEBSをRAID 0でストライピング

#### 処理の流れ
1. **データ分割**: 書き込みたいデータ（100MB）を2分割（50MB + 50MB）
2. **並列書き込み**: ディスク1に50MB、ディスク2に50MBを同時に書き込む

#### 結果
- **書き込み速度**: 2倍速い 🚀
- **読み込み速度**: 2ディスクから並列でできるので2倍速

### ストライピングのメリット・デメリット

#### メリット
- **高速性**: IOPSとスループットが大幅に増える

#### デメリット
- **耐障害性なし**: 1本でも壊れたら全体のデータが壊れる


## EBSスナップショット

### 概要

**EBSボリュームのある時点でのデータのバックアップ**

- Amazon S3に保存される
- **増分バックアップ**（変更分のみ保存）

### 主な特徴

- **リージョン単位での保存**: 異なるAZでも利用可能
- **増分保存**: 初回は全データ、以降は変更分のみ
- **暗号化対応**: 暗号化されたボリュームは暗号化スナップショットになる
- **任意の時点でのスナップショット作成**が可能

### 用途

- **データバックアップ**
- **新しいEBSボリューム作成**: スナップショットからボリューム復元
- **AMI作成**: EC2インスタンスのイメージ作成
- **他リージョンへのコピー**: 災害対策

> **Point**: EBSでRAID 0を組んでもスナップショットで定期的にバックアップを取れば、**パフォーマンスと安全性の両方を確保**

## EBSのバックアップ方法

### 1. EBSスナップショット（基本的なバックアップ）

- ボリュームの**ポイントインタイム バックアップ**
- 手動または自動で作成可能

### 2. AWS Backup（統合バックアップサービス）

- **EBS専用ではない統合バックアップソリューション**
- EBS、RDS、EFS、DynamoDBなど複数のAWSサービスを統一管理
- バックアップポリシーによる自動化
- クロスリージョン・クロスアカウントバックアップ
- **復旧ポイント目標（RPO）** の設定
- タグベースでのリソース管理

### 3. Amazon Data Lifecycle Manager（DLM）

- **EBSスナップショットのライフサイクル管理**
- 自動作成・削除スケジュール
- **コスト最適化**（古いスナップショットの自動削除）

### 4. 手動スナップショット vs DLM

#### EBSスナップショット（手動）

- **コンソールやCLIから任意のタイミングで手動作成できる**
- 必要なら削除も手動で行う
- シンプルだが**定期バックアップや自動削除の仕組みは自分で管理しなければならない**
- **小規模で「たまにバックアップ取ればいい」程度なら十分**

#### Data Lifecycle Manager (DLM)

- **スナップショット作成・削除を自動化できるサービス**
- ルールで「毎日0時に取得」「30日後に削除」など設定可能
- つまり**手動スナップショットの"運用自動化版"**
- **中規模〜大規模運用や、バックアップポリシーが必要な環境では必須**

#### 使い分け

| 方式 | 適用場面 |
|------|----------|
| **手動** | 単発用 |
| **DLM** | 定常運用用 |

## IOPS とパフォーマンス

### IOPSとは

**「IOPS（Input/Output Operations Per Second）」** は、ストレージ装置（HDD、SSD、NVMe、クラウドストレージなど）が**1秒間に処理できる入出力（読み書き）回数**を示す性能指標

### EBSのボリュームタイプ

| ボリュームタイプ | IOPS性能 | 特徴 |
|------------------|----------|------|
| **gp3（汎用SSD）** | デフォルト3,000 IOPS<br/>最大16,000 IOPS | スループットも別途設定可能 |
| **io1/io2（プロビジョンドIOPS SSD）** | 最大64,000 IOPS<br/>（Nitroベースなら最大256,000 IOPS） | 高IOPSが必要なデータベースに向いている |

### EBSでIOPSをさらに上げる方法

#### 1. 高性能ボリュームを使う
- **io2**などの高性能ボリュームを使う

#### 2. 複数のEBSをRAID0で束ねる
- **例**: 4本のEBS（各16,000 IOPS）をRAID0にすれば、理論上64,000 IOPSが出る
- **DB系ワークロード**でよく使われる

### パフォーマンス特性まとめ

- **RAID0**: 複数ディスクでIOPSを合算できるが、耐障害性ゼロ
- **EBS**: gp3やio2で高IOPSを提供、さらにRAID0でスケール可能
- **高IOPSが必要なケース**（RDSや自前DBなど）では、**EBS io2 × RAID0の組み合わせ**

## Fast Snapshot Restore (FSR)

### 概要

**EBSスナップショットから新しいボリュームを作成するときに、すぐにフル性能で利用できるようにする機能**

### 通常の復元プロセス

- **「スナップショットから復元した直後のボリューム」** は、バックグラウンドでデータを取り出しながら読み込む仕組み（**Lazy Load**）
- **初回アクセス時に遅延（IOレイテンシ）** が発生することがある

### FSRのメリット

**FSRを有効にすると、ボリュームを作った瞬間からフルスピードでI/O可能**

### 仕組み

FSRを有効化すると、指定した **AZごとにスナップショットを事前に最適化** しておく。そのため、新しいボリュームを作ったときに「**ウォームアップなし**」で使える。

### 利用シーン

- **本番DBをスナップショットから復元**して即座に運用開始したいとき
- **DR（Disaster Recovery）でフェイルオーバー**する際に、復元を高速化したいとき  
- **テスト環境を短時間で立ち上げたいとき**

### 制約・注意点

- **有効化するのはスナップショット単位・AZ単位**
- **追加コストがかかる**（最適化を維持するための料金）
- **有効化したAZでのみ高速起動**できる

### まとめ

- **Fast Snapshot Restore** = スナップショットから作成したEBSボリュームを、すぐにフル性能で使えるようにする機能
- **デフォルトでは「遅延ロード」**だが、**FSRで「即フルスピード」**になる
- **その代わり料金は上乗せ**される

## EBSマルチアタッチ（EBS Multi-Attach）

### 概要

**ひとつのEBSボリュームを複数のEC2インスタンスに同時にアタッチできる機能**

### 通常のEBSとの違い

| 項目 | 通常のEBS | マルチアタッチ |
|------|-----------|----------------|
| **アタッチ数** | 1つのボリュームは1つのインスタンスにしかアタッチできない（排他利用） | 1つのボリュームを最大**16台のインスタンス**（同じAZ内）にアタッチ可能 |
| **アクセス** | 単一インスタンスからのみ | どのインスタンスからも読み書きできる |

### 対応しているボリュームタイプ

| ボリュームタイプ | 対応状況 |
|-----------------|----------|
| **io1 / io2（プロビジョンドIOPS SSD）** | ✅ 対応 |
| **gp3, st1, sc1** | ❌ 非対応 |

### 使いどころ

#### クラスタ型アプリケーション
**例**: Oracle RAC のように複数サーバーで1つの共有ディスクを使う場合

#### 高可用性システム
片方のEC2が落ちても、別のEC2が同じボリュームをすぐ利用できる

#### 並列分散処理
複数インスタンスが同じデータにアクセスする必要があるワークロード

### 注意点

#### ファイルシステムの制限
- **通常のファイルシステムでは同時書き込み非対応**
- **例**: ext4 や XFS は「複数インスタンスから同時書き込み」するとデータ破損する
- **解決策**: **クラスタ対応ファイルシステム**が必要
  - Oracle Cluster File System
  - GFS2  
  - Windows Server Failover Clustering

#### その他の制限
- **AZをまたいだマルチアタッチは不可**（同じAZ内限定）
- コストは通常のio1/io2と同じだが、**複雑な運用管理が必要**

### まとめ

- **EBSマルチアタッチ** = io1/io2ボリュームを複数EC2に同時接続できる機能
- **共有ストレージを必要とするクラスタ型アプリケーションに有効**
- **通常のファイルシステムではNG、クラスタ対応FSが必須**

## EBS io2 シリーズ

### io2（通常のプロビジョンドIOPS SSD）

#### 概要
**高IOPS・高耐久性が必要なワークロード向け**（RDB、SAP HANAなど）

#### 特徴
- **最大 64,000 IOPS**（Nitroインスタンスなら 256,000 IOPS）
- **耐久性 99.999%**
- **EBSマルチアタッチ対応**

### io2 Block Express

#### 概要
**io2の拡張版（次世代アーキテクチャ）**

- Nitroシステム上で動作
- 専用の**Block Expressアーキテクチャ**を利用

#### 特徴
- **最大 256,000 IOPS**（通常インスタンス）
- **最大スループット 4,000 MB/s**
- **最大ボリュームサイズ 64 TiB**
- **レイテンシがより低い**（数百マイクロ秒レベル）
- **マルチアタッチ対応**

### io2 vs io2 Block Express

| 項目 | io2 | io2 Block Express |
|------|-----|-------------------|
| **位置づけ** | 高性能SSD | io2をさらに強化した次世代バージョン |
| **性能** | 高性能 | 特にIOPS・スループット・容量で大幅に強い |
| **対象** | 一般的な高性能用途 | **ハイエンド専用** |

> **Note**: 両方「プロビジョンドIOPS SSD」カテゴリだが、Block Expressは**ハイエンド専用**という位置づけ

Auto Scaling で削除されるEC2のEBSデータを保持したいなら、DeleteOnTermination=false を設定