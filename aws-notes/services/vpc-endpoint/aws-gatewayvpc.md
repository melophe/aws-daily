# NAT Gateway vs VPC Endpoint

## NAT Gateway を使いたくない理由

### 1. コストが高い 💰
- **課金**: NAT Gateway自体に「時間単価＋通信量課金」が発生
- **特に問題**: S3 みたいに大量データをやり取りすると高くつく
- **解決策**: Gateway VPC Endpointなら追加料金なしでS3/DynamoDBにプライベート接続

### 2. セキュリティ 🔒
- **NAT Gateway**: 「外（インターネット）に出てAWSのサービスにアクセスする」形
- **リスク**: 「外に出す通信経路」が存在してしまう
- **VPC Endpoint**: 「外に出ない（AWSネットワーク内で完結）」ので安全

### 3. 構成のシンプルさ ⚡
- **NAT Gateway**: インターネットゲートウェイやルートテーブル設定が必要
- **VPC Endpoint**: 「特定サービスへのプライベートルート」を追加するだけ

## 使い分けの基本

| サービス | 用途 |
|---------|------|
| **NAT Gateway** | プライベートサブネットからインターネットに出たいときの出口 |
| **Gateway VPC Endpoint** | 特定サービス（S3/DynamoDB）だけに行きたいときの専用の近道 |

## VPC Endpoint の種類

### Gateway VPC Endpoint (S3/DynamoDB)
- **接続方式**: インターネットを経由せずにAWSバックボーン内で接続
- **セキュリティ**: 完全プライベート
- **コスト**: 追加コストなし
- **対応サービス**: S3, DynamoDB のみ

### Interface VPC Endpoint (PrivateLink)
- **接続方式**: ENI経由で通信、インターネット経由しない
- **対応範囲**: 他のAWSサービスにもプライベート接続可能
- **セキュリティ**: 完全プライベート

## 各アプローチの詳細比較

### NAT Gateway の場合

#### 配置・設定
- **配置場所**: パブリックサブネット
  - パブリックサブネット = IGW（Internet Gateway）へのルートがあるサブネット
- **関連付け**: プライベートサブネットのルートテーブルに設定
- **設定例**: `宛先: 0.0.0.0/0 → NAT Gateway`

#### 通信フロー
1. プライベートサブネットのEC2 → NAT Gateway
2. NAT Gateway → IGW経由でインターネット

> **特徴**: 「外に出る出口」として動作

### Gateway VPC Endpoint (S3 / DynamoDB) の場合

#### 配置・設定
- **配置場所**: VPC単位（サブネットには置かない）
- **関連付け**: 指定したルートテーブルに追加される
- **設定例**: `宛先: com.amazonaws.ap-northeast-1.s3 → vpce-xxxxxx`

#### 通信フロー
1. プライベートサブネットのEC2 → VPC Endpoint
2. AWS内部ネットワークを通って直接S3/DynamoDBへ

> **特徴**: インターネットもNATも不要で、完全プライベート接続

### Interface VPC Endpoint (PrivateLink) の場合

#### 配置・設定
- **配置場所**: サブネット（ENIとして作成される）
- **関連付け**: DNS解決がそのENIに向く（ルートテーブルに特別な記述は不要）

#### 通信フロー
1. EC2 → ENI（Interface Endpoint）
2. AWS内部でサービスへ接続

> **特徴**: ENIに直接アタッチされるイメージ

## 配置・関連付けまとめ

| 種類 | 配置場所 | 関連付け方法 |
|------|----------|-------------|
| **NAT Gateway** | パブリックサブネットに配置 | プライベートサブネットのルートテーブルに関連付け |
| **Gateway VPC Endpoint** | VPCに作成 | 対象ルートテーブルに関連付け |
| **Interface VPC Endpoint** | ENIがサブネットに作られる | DNSで自動的に経路振り替え |