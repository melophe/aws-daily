# AWS Auto Scaling

## 概要

**AWS Auto Scaling** は、アプリケーションやサービスのリソースを、トラフィックや負荷に応じて自動的に増減させる仕組み

### Auto Scaling の種類

- **EC2 Auto Scaling** と **DynamoDB Auto Scaling** は専用機能として存在
- それ以外のリソースは **Application Auto Scaling** を通じてスケーリング

## 対応サービス

### 1. EC2 Auto Scaling
- 最も有名な Auto Scaling
- **スケーリング対象**: EC2 インスタンスの数
- **設定方法**: CloudWatch アラームやターゲット追跡ポリシー

### 2. ECS（コンテナ）
- **利用方法**: Application Auto Scaling を通じて利用
- **スケーリング対象**: ECS サービスのタスク数
- **トリガー**: CPU使用率やリクエスト数に応じてタスク数を増減

### 3. DynamoDB
- **専用機能**: DynamoDB Auto Scaling（Application Auto Scaling に統合済み）
- **スケーリング対象**: RCU（読み取りキャパシティ）/ WCU（書き込みキャパシティ）
- **動作**: 利用率に応じてキャパシティを増減

### 4. Aurora
- **機能**: Aurora リーダーノードのオートスケーリング
- **Aurora Serverless v2**: さらに自動化が進み、キャパシティユニットが自動調整

### 5. その他 Application Auto Scaling 対応サービス

- AppStream 2.0
- EMR クラスター
- SageMaker エンドポイント
- Amazon Keyspaces (for Apache Cassandra)
- Amazon Neptune
- Custom リソース（独自の CloudWatch メトリクスに基づくスケーリング）

## 利用状況の傾向

### 最も一般的：インスタンス系
- **対象**: EC2, ECS, EKS
- **動作**: サーバーの負荷（CPU、メモリ、リクエスト数など）に応じてインスタンス台数を自動増減
- **利用頻度**: 最も一般的で利用数も多い

### よく使われる：データベース系  
- **対象**: DynamoDB, Aurora
- **特徴**: 伸び縮みするのは「性能」や「リーダー数」であってインスタンスそのものではない

### その他のリソース
- SageMaker エンドポイント（機械学習推論用のインスタンス数）
- AppStream 2.0 セッション数
- EMR クラスターのコア/タスクノード数
- Custom リソース（CloudWatch メトリクスを使って任意のスケーリング対象を制御）

> Auto Scaling は「EC2 インスタンスの数を自動調整する機能」から広がって、今では色んなサービスに拡張されている

## メリット

- **コスト最適化**: 必要な分だけのリソース利用
- **可用性向上**: 負荷が高くても自動でリソース追加
- **運用負荷軽減**: 手動でのリソース調整が不要

## スケーリングの種類

### 1. 手動スケーリング
- **操作**: 手動でインスタンスやキャパシティを変更
- **設定**: AutoScalingグループに最小値、最大値、希望値を指定して調整
- **特徴**: 自動化はされないけどシンプル

### 2. スケジュールベーススケーリング
- **動作**: 時間帯や曜日に応じてスケーリング
- **例**: アクセスが多いゴールデンタイムはインスタンスを10台、それ以外は3台
- **適用**: アクセスが多い・少ないというのが分かっているシステムに有効

### 3. 動的スケーリング

CloudWatchメトリクスをトリガーにして自動でスケーリング

#### 3-1. 単純スケーリング
- **動作**: CPU使用率 > 70％なら +1台のように動作
- **特徴**: わかりやすいけど柔軟性は低い（一つの閾値のみ）

#### 3-2. ステップスケーリング
- **ポイント**: 閾値に応じて**段階的**にスケーリング
- **例**:
  - CPU > 70％なら +2台
  - CPU > 90％なら +4台
- **メリット**: 急激なスパイクにも対応可能
- **試験対策**: 「段階的」が出たらこれ

> **スパイク**とは負荷やアクセスが急に跳ね上がること

#### 3-3. ターゲット追跡スケーリング
- **推奨度**: 最も推奨される方式
- **特徴**: 設定が簡単、常にちょうどいい数を維持
- **メリット**: 運用負荷が軽い、過剰なスケールアウトやスケールインを避けられる

### 4. 予測スケーリング（EC2専用）
- **仕組み**: 機械学習を使ってトラフィックのパターンを予測して事前にスケール
- **例**: 毎日昼12時にアクセスが急増する → 11:55に自動でスケールアウト
- **特徴**: 新しめの機能

### 用語の整理
- **スケールイン**: インスタンスを少なくする
- **スケールアウト**: インスタンスを増やす

## キャパシティ設定

手動でも自動でも**最小、最大、希望値**は必ず決める

### 最小値 (Min Capacity)
- **定義**: 絶対に下回らないリソース数
- **例**: 最低でも EC2 を 2台は維持する

### 最大値 (Max Capacity)
- **定義**: 絶対に超えない上限
- **例**: いくら増えても 10台まで

### 希望値 (Desired Capacity)
- **定義**: 初期状態や手動スケーリングでの現在値
- **例**: 最初は 4台で起動しておく

### DynamoDB の例

```
最小 WCU: 10
最大 WCU: 200
希望値: 50
```

### 特殊なケース: 自己修復機能

**設定**: 最小=1、希望=1、最大=1 の Auto Scaling グループ

- スケーリング（増減）はしない
- 代わりに**自己修復機能（Self-Healing）**として動作

## まとめ・復習

### Auto Scaling の利用状況
- **最も多い**: インスタンス系（EC2など）の利用
- **その他**: コンテナや DynamoDB などにも普通に使われる

### EC2 Auto Recovery vs Auto Scaling の比較

| 機能 | 復旧方法 | インスタンス ID | AZ 障害耐性 | 使いどころ |
|------|----------|----------------|-------------|------------|
| **EC2 Auto Recovery** | 同じインスタンスを再起動 | 変わらない | 弱い（同じ AZ 内のみ） | 単一インスタンスを安全に運用したい |
| **ASG (Min=1)** | 新しいインスタンスを起動 | 変わる | 強い（複数 AZ 対応可） | 冗長性や可用性を重視 |

### ポイント
- **EC2 Auto Recovery**: 「同じインスタンスをそのまま復活させる」
- **Auto Scaling**: 「同じインスタンスを復活させる」のではなく「新しく立ち上げ直す」

## 制約事項

### タイムアウト処理
Auto Scaling は、スケーリングが正常に行われずに24時間以上経過した場合、自動的に処理を停止する仕組みを持っている。30時間以上にわたりスケーリングが機能しなかった場合、処理は途中で停止する

### AZ 障害時の動作
特定のアベイラビリティゾーン（AZ）での新規インスタンスの起動に失敗した場合、別の AZ で起動プロセスを実行することはなく、Auto Scaling グループの設定に基づいて指定された AZ 内でインスタンスの起動を行う。したがって、Auto Scaling グループの設定で複数の AZ を指定している場合、失敗の有無にかかわらず、複数の AZ での起動を試みることになる

## Auto Scaling グループ（ASG）と AZ の関係

### ASG に複数の AZ を指定した場合

ASG は「指定された AZ の中で」EC2 を起動する

- どの AZ に置くかは ASG が自動的に判断（バランスやリソース空き状況による）

### インスタンス起動に失敗した場合

- 指定された AZ 以外に勝手に切り替えることはない
- ただし、ASG に複数の AZ が設定されていれば、結果的に複数 AZ にまたがってインスタンスが起動される

> **重要**: 「どの AZ でもいい」ではなく「ASG で設定した AZ の中から起動する」という動き

### AZ 間でのスケーリング挙動

#### スケーリングアウト時（インスタンス数増加）
- ASG は「設定済みの複数 AZ」に分散配置しようとする
- 特定の AZ でキャパ不足なら、他の AZ に振り分けられる

#### スケーリングイン時（インスタンス数削減）
- バランスを保つように各 AZ から均等に減らそうとする


## EBSデータの保持

**Auto Scaling で削除されるEC2のEBSデータを保持したいなら、DeleteOnTermination=false を設定**

## CloudWatch メトリクス vs ヘルスチェック

### CloudWatch メトリクス

**「スケールアウト / スケールインするか」を決める材料**

#### 例
- **CPU使用率が70%以上** → 台数を増やす
- **ALBのリクエスト数が多い** → タスクを増やす

### ヘルスチェック（EC2 / ALB）

**「インスタンスやタスクが生きているか」を判定する材料**

- 壊れていたら自動的に置き換える（スケーリングの数値判断には直接使わない）

### 役割の違い

- **CloudWatchメトリクス** → 「CPU80%超えたら増やす」
- **ヘルスチェック** → 「死んでいるEC2があったら、新しいEC2に置き換える」

## Auto Scaling Group のヘルスチェック

**Auto Scaling Group (ASG) は 2種類のヘルスチェックを使える**

### 1. EC2 ヘルスチェック

#### 特徴
- **デフォルトのチェック方式**
- **ASG が EC2 の状態を見て判断**

#### 例
- **ステータスチェックに失敗した**（ハード障害、OSクラッシュ）
- → 不健全とみなして自動で新しいEC2に置き換え

> **制限**: 「アプリが落ちてるけどOSは動いてる」ケースは検知できない

### 2. ELB（ALB/NLB/CLB）ヘルスチェック

#### 特徴
- **ASG の設定で「ELB ヘルスチェックを使う」に変更できる**
- **ALB が定期的に HTTP/TCP/HTTPS でインスタンスの応答を監視**

#### 例
- **OSは動いてるけど、アプリが 500 エラーを返している**
- → ALB が Unhealthy と判定 → ASG がインスタンスを置き換える

> **メリット**: 「アプリレベルの死活監視」が可能になる

## ヘルスチェック方式の推奨

### 実用性の比較

**ヘルスチェックは ELB でやる方が実用的**

| 方式 | 監視レベル | 特徴 |
|------|-----------|------|
| **EC2 ヘルスチェック** | インスタンスのハード/OSレベルのみ | 基本的な監視 |
| **ELB ヘルスチェック** | アプリケーションレベルまで監視可能 | より実用的 |

### 現場での利用

**Auto Scaling の現場運用では「ELB ヘルスチェックを有効化」がよく使われる**

### ヘルスチェックタイプの違い

- **EC2タイプ** → インスタンス死活監視レベル（OS/ハード）
- **ELBタイプ** → アプリケーションレベルまでカバーできる

### 本番環境での推奨

**本番環境では「ユーザーが使えるか」が最重要なので、ELBヘルスチェックをASGに連携させるのが普通**

### 重要な注意点

**Auto ScalingがEC2タイプのヘルスチェックを使用している場合、ELBのヘルスチェックが異常を示していても、EC2インスタンスのステータスに問題がなければ、Auto Scalingは実行されない**