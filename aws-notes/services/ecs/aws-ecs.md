# Amazon ECS (Elastic Container Service)

## 概要

### ECS とは
コンテナオーケストレーションサービス（コンテナの起動・停止・スケーリングを管理）

### 特徴
- フルマネージド: Kubernetes (EKS) のように自分で制御プレーンを管理する必要なし
- コンテナランタイム: Docker ベース

---

## 起動タイプ（どこでコンテナを動かすか）

ECSの一番重要な概念

### EC2 起動タイプ
- 実行環境: 自分のEC2クラスター上でコンテナを実行
- 特徴: 柔軟性が高いがEC2の管理コストも必要

### Fargate 起動タイプ
- 実行環境: サーバーレスでコンテナを実行
- 課金: 使った時間だけ課金（短時間ジョブや定期処理に最適）
- メリット: OSの起動不要なので高速

---

## ECS の基本構造

ECSを使用する際に出てくる用語

### Cluster
ECSタスクやサービスの論理的なグループ

### Task Definition（タスク定義）
- 概要: コンテナの「設計図」
- 設定内容: どのイメージを使うか、CPU/メモリ、環境変数などを定義

### Task（タスク）
タスク定義から実際に起動された「コンテナの実体」

### Service（サービス）
- 概要: タスクを常に指定数だけ稼働させる仕組み
- 特徴: スケーラブルで冗長性あり

### Standalone Task（スタンドアロンタスク）
単発で実行するタスク（終了したら消える）

---

## ECS サービススケジューラ

### 概要
常駐タスクを維持する仕組み

### スケジューラの種類

#### REPLICA
指定数のタスクを維持

#### DAEMON  
各インスタンスに1つずつタスク配置

### 適用範囲
- 適用: WebサーバーやAPIサーバーなど、常時稼働に向いている
- 不適用: 30分ごとのバッチ処理のような定期実行には不向き

---

## ECS とジョブ実行（バッチ用途）

### ベストプラクティス
スタンドアロンタスクをEventBridge Schedulerで定期実行

### コスト効率
Fargate: 「タスク実行中だけ課金」になるのでコスト効率が良い

### 実装例
30分おきにデータ集計 → Fargate + EventBridge + Standalone Task

---

## ECS 使い分けのポイント

### 用途別の選択指針

#### Webサービス（常時稼働が必要）
ECS Service + サービススケジューラ (REPLICA/DAEMON)

#### 定期ジョブ / バッチ処理  
ECS Standalone Task + EventBridge Scheduler

#### 短時間・不定期の処理
Lambdaで十分な場合もあるが、処理が重い/長いならECS (Fargate)

---

## タスクの実行形態

### 実行形態の分類
- サービススケジューラ = 長期稼働型（常駐系タスク）
- スタンドアロンタスク = 短期実行型（ジョブ・バッチ処理）

### サービススケジューラ = ECS サービスの仕組み
ECSの「サービス」に内蔵されている機能のことをサービススケジューラと呼ぶ

「サービススケジューラを使う」= 「ECSサービスを使う」という意味と同じ

---

## スケジュールタスク

### 定義
EventBridge (旧 CloudWatch Events) を使ってECSタスクを定期実行する機能

### 設定方法
- スケジュール指定: cron式やrate式を使って「30分ごと」「毎日1回」などを指定
- 起動対象: スタンドアロンタスク（単発タスク）が起動される

「定期ジョブ用途のECS」

### 実行フロー
1. EventBridge Schedulerでスケジュールを設定
   - 例：`rate(30 minutes)`
2. EventBridgeが指定時間ごとにECS RunTask APIを呼び出す
3. ECSがFargateタスク（またはEC2上のタスク）を起動
4. タスクが処理を終えると終了 → 課金もストップ

---

## サービススケジューラ vs スケジュールタスクの違い

| 項目 | サービススケジューラ | スケジュールタスク |
|------|---------------------|-------------------|
| **仕組み** | 常駐タスクを「落ちたら再起動して維持」 | EventBridgeで「時間ベースでRunTask」 |
| **前提** | 長期稼働が前提 | 短時間ジョブやバッチ処理に最適 |

---

## 関係性の整理

### スタンドアロンタスク (Standalone Task)
- 概要: ECSの単発タスク
- 動作: 実行したら処理して終了 → 課金も終了

### スケジュールタスク (Scheduled Task)
- 概要: EventBridge Schedulerを使ってスタンドアロンタスクを定期的に起動する仕組み
- 例: 30分ごと、1日1回、cron式等

「スケジュールタスク」= 「EventBridge Schedulerで定期的にスタンドアロンタスクを起動する」

---

## キャパシティプロバイダー

### 定義
ECSに「どのキャパシティをどの割合で使うか」を教える設定

### 機能
- ECSサービスやタスクを起動時に、自動でルールに従ってキャパシティを使い分け
- 複数のキャパシティタイプ（EC2、Fargate、Spot等）を組み合わせて最適化可能

---

## ECSでのIAMロール

ECSでは大きく2種類のIAMロールを使用

### タスク実行ロール (task execution role)

#### 用途
タスクが起動するときに必要

#### 例
- ECRからイメージをPull
- CloudWatch Logsにログを送信

### タスクロール (task role)

#### 用途
タスク内のコンテナアプリがAWSリソースにアクセスするために使用

#### 例
- S3にファイルを保存
- DynamoDBに書き込み

---

## IAMロールの適用単位

### 設定レベル
IAMロールは「タスク定義」に対して設定

### 適用範囲
「タスク定義から作られるタスク」はすべて同じロールを使用

個々の「タスク」に別のIAMロールを設定することは不可能

### 設定例

#### タスク定義 A（IAMロール: S3アクセス許可あり）
この定義から起動したタスク1, タスク2, タスク3 → 全部S3アクセス可能

#### 異なる権限が必要な場合
- タスク定義 A（S3アクセス権限）
- タスク定義 B（DynamoDBアクセス権限）
- タスク定義 C（SQSアクセス権限）

タスク定義を分けてそれぞれに適切なロールを設定

---

## IAMロール設定例

### タスク定義 A
- Task Execution Role: ecsTaskExecutionRole（ECR/Logs用）
- Task Role: MyAppTaskRole（アプリ用、S3にPut可能な権限）

このタスク定義からタスクを3つ起動すると、全てのタスクがMyAppTaskRoleを持ってS3にアクセス

---

## まとめ

### ECSの位置づけ
ECS = AWSのフルマネージドコンテナ基盤

### 主要概念

| 概念 | 説明 |
|------|------|
| **起動タイプ** | EC2 or Fargate |
| **タスク定義** | コンテナの設計図 |
| **サービススケジューラ** | 常駐タスク維持 |
| **スタンドアロンタスク** | 単発実行（定期ジョブに最適） |

### 定期実行の実装
定期実行はEventBridge Schedulerと組み合わせる

### IAMロールのポイント
- IAMロールはタスク定義に付与
- タスク単位で別ロールは不可（分けたいならタスク定義を複数作成）
- サービスを動かすときは「サービスがタスク定義を参照 → そのIAMロールを使ってタスクが動作」