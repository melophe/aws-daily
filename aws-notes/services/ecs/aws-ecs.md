# Amazon ECS (Elastic Container Service)

## 1. 概要

### ECS とは？
**コンテナオーケストレーションサービス**（コンテナの起動・停止・スケーリングを管理）

### 特徴
- **フルマネージド**: Kubernetes (EKS) のように自分で制御プレーンを管理する必要なし
- **コンテナランタイム**: Docker ベース

## 2. 起動タイプ（どこでコンテナを動かすか）

> ECS の一番大事な概念

### EC2 起動タイプ
- **実行環境**: 自分の EC2 クラスター上でコンテナを実行
- **特徴**: 柔軟性が高いが EC2 の管理コストも必要

### Fargate 起動タイプ
- **実行環境**: サーバーレスでコンテナを実行
- **課金**: 使った時間だけ課金（短時間ジョブや定期処理に最適）
- **メリット**: OS の起動不要なので速い

## 3. ECS の基本構造

> ECS を使うときに出てくる用語

### Cluster
- **概要**: ECS タスクやサービスの論理的なグループ

### Task Definition（タスク定義）
- **概要**: コンテナの「設計図」
- **設定内容**: どのイメージを使うか、CPU/メモリ、環境変数などを定義

### Task（タスク）
- **概要**: タスク定義から実際に起動された「コンテナの実体」

### Service（サービス）
- **概要**: タスクを常に指定数だけ稼働させる仕組み
- **特徴**: スケーラブルで冗長性あり

### Standalone Task（スタンドアロンタスク）
- **概要**: 単発で実行するタスク（終了したら消える）

## 4. ECS サービススケジューラ

### 概要
**常駐タスクを維持する仕組み**

### スケジューラの種類

#### REPLICA
- **機能**: 指定数のタスクを維持

#### DAEMON  
- **機能**: 各インスタンスに1つずつタスク配置

### 適用範囲
- **✅ 適用**: Webサーバーや API サーバーなど、常時稼働に向いている
- **❌ 不適用**: 30分ごとのバッチ処理みたいな定期実行には不向き

## 5. ECS とジョブ実行（バッチ用途）

### ベストプラクティス
**スタンドアロンタスクを EventBridge Scheduler で定期実行**

### コスト効率
- **Fargate**: 「タスク実行中だけ課金」になるのでコスト効率◎

### 実装例
**30分おきにデータ集計** → Fargate + EventBridge + Standalone Task

## 6. ECS を使い分けるポイント

### 用途別の選択指針

#### Webサービス（常時稼働が必要）
**→ ECS Service + サービススケジューラ (REPLICA/DAEMON)**

#### 定期ジョブ / バッチ処理  
**→ ECS Standalone Task + EventBridge Scheduler**

#### 短時間・不定期の処理
**→ Lambda で十分な場合もあるが、処理が重い/長いなら ECS (Fargate)**

## まとめ

### ECS の位置づけ
**ECS = AWS のフルマネージドコンテナ基盤**

### 主要概念

| 概念 | 説明 |
|------|------|
| **起動タイプ** | EC2 or Fargate |
| **タスク定義** | コンテナの設計図 |
| **サービススケジューラ** | 常駐タスク維持 |
| **スタンドアロンタスク** | 単発実行（定期ジョブに最適） |

### 定期実行の実装
**定期実行は EventBridge Scheduler と組み合わせる**

## 7. タスクの実行形態

### 実行形態の分類

- **サービススケジューラ** = 長期稼働型（常駐系タスク）
- **スタンドアロンタスク** = 短期実行型（ジョブ・バッチ処理）

### サービススケジューラ = ECS サービスの仕組み

ECS の「サービス」に内蔵されている機能のことを**サービススケジューラ**と呼ぶ。

> 「サービススケジューラを使う」= 「ECS サービスを使う」という意味と同じ

## 8. スケジュールタスクとは？

### 定義
**EventBridge (旧 CloudWatch Events) を使って ECS タスクを定期実行する機能**

### 設定方法
- **スケジュール指定**: cron 式や rate 式を使って「30分ごと」「毎日1回」などを指定
- **起動対象**: スタンドアロンタスク（単発タスク）が起動される

> つまり「定期ジョブ用途の ECS」

### 実行フロー

1. **EventBridge Scheduler でスケジュールを設定**
   - 例：`rate(30 minutes)`
2. **EventBridge が指定時間ごとに ECS RunTask API を呼び出す**
3. **ECS が Fargate タスク（または EC2 上のタスク）を起動**
4. **タスクが処理を終えると終了 → 課金もストップ**

## 9. サービススケジューラ vs スケジュールタスクの違い

### サービススケジューラ
- **仕組み**: 常駐タスクを「落ちたら再起動して維持」する仕組み
- **前提**: 長期稼働が前提

### スケジュールタスク  
- **仕組み**: EventBridge で「時間ベースで RunTask」する仕組み
- **適用**: 短時間ジョブやバッチ処理に最適

## 10. 関係性の整理

### スタンドアロンタスク (Standalone Task)
- **概要**: ECS の単発タスク
- **動作**: 実行したら処理して終了 → 課金も終了

### スケジュールタスク (Scheduled Task)
- **概要**: EventBridge Scheduler を使ってスタンドアロンタスクを定期的に起動する仕組み
- **例**: 30分ごと、1日1回、cron 式 etc.

### まとめ
**「スケジュールタスク」= 「EventBridge Scheduler で定期的にスタンドアロンタスクを起動する」**

## 11. キャパシティプロバイダー

### 定義
**ECS に「どのキャパシティをどの割合で使うか」を教える設定**

### 機能
- ECS サービスやタスクを起動時に、自動でルールに従ってキャパシティを使い分け
- 複数のキャパシティタイプ（EC2、Fargate、Spot など）を組み合わせて最適化可能