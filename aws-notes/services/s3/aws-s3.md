# Amazon S3

## S3クロスリージョンレプリケーション（Cross-Region Replication: CRR）

### 概要

S3バケットのオブジェクトを別リージョンのバケットに自動的に複製する機能

### 基本構成

- ソースバケットと宛先バケットを設定
- 新しくアップロード・更新されたオブジェクトが、自動で別リージョンにコピーされる
- コピーは非同期処理（リアルタイムではなく、若干の遅延あり）

### 前提条件

- ソースと宛先の両方のバケットでバージョニングが有効
- 適切なIAM権限（レプリケーション用ロール）
- レプリケーションルール設定（バケット全体か、特定プレフィックス/タグごとに制御可能）

## ユースケース

### 災害対策 (DR)
東京リージョンにあるデータを、大阪リージョンやシンガポールにコピーしてBCP対策

### グローバル配信
ユーザーに近いリージョンからアクセスさせて、レイテンシ削減

### コンプライアンス要件
データを必ず複数の地理的リージョンに保持する必要がある場合

## 重要な制約

- レプリケーションは新しいオブジェクトだけが対象
- 過去のオブジェクトは自動コピーされない（必要ならS3バッチオペレーションで対応）
- 双方向レプリケーションはできるが、ループ防止に工夫が必要
- 追加のデータ転送コストがかかる

## 同一リージョンレプリケーション（SRR: Same-Region Replication）

### 特徴

- 同じリージョン内の別バケットに複製
- マルチアカウント環境やセキュリティ隔離に使用

## S3マルチリージョンアクセスポイント

複数リージョンのバケットを束ねて、最適なリージョンにルーティングする仕組み

## 双方向レプリケーションの仕組み

### 基本原則

S3 CRRは一方向（ソース → 宛先）のみサポート

### 双方向にする方法

双方向にしたい場合は以下の2つのレプリケーション設定をそれぞれ作る必要がある：

- バケットA → バケットBのレプリケーションルール
- バケットB → バケットAのレプリケーションルール

### レプリケーションループ対策

#### 問題

双方向にすると、同じオブジェクトがA ⇔ Bで無限コピーされるリスクがある

#### 対策

- レプリケーション元のバケットID（バケットの所有者）やメタデータを利用してフィルタリング
- 「レプリケーションでコピーされたオブジェクトは再レプリケーションしない」という仕組みがS3に組み込まれている

## S3バージョニング (Versioning)

### 概要
S3バケットに保存するオブジェクトを世代管理できる機能

### 基本動作

#### バージョンID付与
バージョニングを有効化すると、オブジェクトにバージョンIDが自動で付与される

#### 新バージョン作成
同じキー（例: file.txt）にアップロードすると新しいバージョンが作成され、古いバージョンも残る

特徴：「上書き」ではなく「履歴が全部残る」状態

### 復元機能

#### 過去バージョンの復元
誤って上書きした場合でも以前のバージョンに戻せる

#### 削除からの復元
- 削除するとDelete Markerという特別なバージョンが追加されるだけ
- そのマーカーを消せば復活

### ユースケース

- 誤操作対策（上書きや削除からの保護）
- 監査対応（どの時点でどんなデータがあったか追跡可能）
- クロスリージョンレプリケーション(CRR)の前提機能
  - レプリケーションを設定するにはバージョニングが必須

### 注意点

#### 容量増加
- 古いバージョンも残り続けるため、ストレージコストが増える
- ライフサイクルルールで古いバージョンを自動削除/Glacierに移行するのが一般的

#### 設定変更の制限
バージョニングは「有効化 or 無効化」できるが、一度有効化したら完全には解除できず「一時停止（suspended）」にするだけ

---

## リクエスタ支払い機能 (Requester Pays)

### 概要
通常、S3の利用料金（データ転送料やリクエスト料）はバケット所有者が負担する。

しかし「Requester Pays」を有効にすると、バケットからデータを取得した人（リクエスタ）が料金を支払う仕組みとなる。

### 仕組み
1. S3バケット側で「Requester Pays」を有効化する
2. そのバケットからオブジェクトを取得（GET, LIST, HEAD など）するユーザーは
   - 自分のAWSアカウントで認証してアクセス
   - そのリクエスト料・データ転送料が 自分のアカウントに課金される

### ユースケース

#### 大規模データの公開配布
- 研究データ、衛星写真、オープンデータなどを誰でも使えるようにしたい
- でも配布コストはバケット所有者ではなく利用者に負担してほしい場合

#### 課金を明確に分けたい
- 共同研究や外部パートナーがデータにアクセスする際に、
- 「自分が使った分は自分で払う」ようにしたい場合

### 注意点
- 「Requester Pays」バケットは匿名アクセスできない
- 必ずAWSアカウントで認証する必要がある
- バケット所有者はストレージ料金は負担し続ける
  - 保管料はバケット所有者
  - 転送料・リクエスト料はリクエスタ
- 一般的なWebサイトホスティングには不向き

### まとめ
- リクエスタ支払い機能 = データを取得した人がリクエスト料・転送料を支払う仕組み（S3）
- バケット所有者は保存コストを払い続けるが、転送コストを利用者に転嫁できる
- 公開データ配布や外部コラボに便利

「S3のデータ転送コストを利用者に負担させられる機能」

---

## ストレージクラス分析 (S3 Storage Class Analysis)

### 概要
S3オブジェクトのアクセスパターンを分析する機能

「このデータは頻繁にアクセスされてる？ほとんどアクセスされてない？」を統計的に把握できる

結果を見て、どのストレージクラスに移行すべきか判断するためのデータを提供する

### 仕組み
1. バケットまたはプレフィックス単位で分析を有効化
2. S3がオブジェクトのアクセスパターンを収集（読み取り回数など）
3. 分析結果は CSV形式でS3に出力される
4. それをAthena, Redshift, QuickSightなどで可視化・分析できる

### ユースケース
- 「このバケットのファイルはあまりアクセスされてないから S3 Standard-IA に移そうかな？」
- 「頻繁に使うデータが実は Glacier に入っていて非効率になっていないか？」を確認したいとき
- コスト最適化の判断材料にする

### 注意点
- Storage Class Analysis自体は「自動移行しない」
- あくまで「判断材料」
- 移行はライフサイクルポリシーを別途設定する必要あり
- データの収集・分析には時間がかかる（数日〜数週間）
- 課金は「分析レポート用のS3ストレージ料金」のみ

### まとめ
- ストレージクラス分析 = S3オブジェクトのアクセスパターンを分析して、どのストレージクラスに移すべきか判断するための機能
- 自動で移行はしない（ライフサイクルルールは別に必要）
- 出力データを使ってコスト最適化の戦略を立てられる

「S3の利用状況を分析して、IAやGlacierに移す判断材料を提供してくれるツール」

## Amazon S3 Storage Lens

### 概要
S3 Storage Lensはアカウントや組織全体のS3の使用状況・アクティビティを可視化するダッシュボード。

AWS Organizationsと統合できるため、複数アカウントにまたがるS3の利用状況をまとめて分析可能。

### 主な機能

#### ストレージ使用状況の可視化
バケットごとのオブジェクト数、使用量、保存コストを集計

#### アクティビティの可視化
PUT/GETリクエスト数、エラー率などを可視化

#### 組織レベルでの分析
OUやアカウント単位でサマリを確認可能

#### 推奨事項（Insights）
- 例：「ライフサイクルポリシーを設定するとコスト削減できる」
- 「未暗号化オブジェクトが残っている」などのセキュリティ改善ポイントを提示

#### ダッシュボード
- AWSマネジメントコンソールでグラフ形式のダッシュボードが見れる
- 結果はCSV/Parquet形式でS3にエクスポートも可能

### 似たサービスとの違い

#### S3 Storage Class Analysis
- アクセス頻度を見て適切なストレージクラスに移行すべきかを分析する機能
- Storage Lensはもっと幅範囲（組織全体）をカバー

#### AWS Cost Explorer
- コスト分析全般。S3以外も対象
- Storage LensはS3に特化し、オブジェクト数やリクエスト数などS3ならではの指標を提供

### 使いどころ
- 複数アカウントでS3を使っていて「どこでどれくらい使われているか」把握したいとき
- コスト最適化をしたいとき（未使用データをGlacierへ移動など）
- セキュリティ監査（暗号化やパブリックアクセスの有無を確認）

### まとめ
- S3 Storage Lens = S3利用状況を組織・アカウント・バケット単位で可視化する分析ダッシュボード
- 特徴：メトリクス収集、推奨事項、マルチアカウント対応
- 用途：コスト削減、セキュリティ強化、運用改善

---

## IAM Access Analyzer for S3

### 概要
IAM Access Analyzer for S3はS3バケットが外部（インターネット公開や他アカウント）にアクセス可能になっていないかを検出する機能。

S3バケットのアクセス許可設定（バケットポリシーやACL）を解析して、安全性を可視化する。

### 主な機能

#### パブリックアクセスの検出
誰でも読み取りできる状態（例：Principal": "*"）を検出

#### クロスアカウントアクセスの検出
他AWSアカウントに許可が与えられているかを確認

#### 可視化ダッシュボード
バケットごとに「安全 / 公開 / クロスアカウント」などの状態を一覧表示

#### 修正アドバイス
セキュリティを強化するために推奨設定を提示

### 似た機能との違い

#### S3 Block Public Access
- 強制的に「パブリックアクセス禁止」にできる設定
- Access Analyzerは「現在どうなってるかを解析・通知する」機能

#### S3 Storage Lens
- 利用状況やコストの分析が目的
- Access Analyzerはセキュリティが目的

### 使いどころ
- 「このS3バケット、本当に外部からアクセスできないよね？」をチェックしたいとき
- セキュリティ監査で、誤って公開してしまったバケットを見つけたいとき
- 複数アカウント/複数バケットを運用しているときに、安全性を一括で確認したいとき

### まとめ
- IAM Access Analyzer for S3 = S3バケットの外部アクセス状況を解析・可視化するサービス
- 目的：セキュリティ監査、誤公開防止
- 特徴：パブリックアクセスやクロスアカウントアクセスを検出、修正推奨も提示

---

## S3 バージョニング + ライフサイクルルール

### NewerNoncurrentVersions パラメータ

S3 バージョニング + ライフサイクルルールには 「NewerNoncurrentVersions」 というパラメータがあって、これを指定すると：

- 直近の n 個だけ残す
- それより古いバージョンは自動的に削除

という動きになる

### 具体例

#### NewerNoncurrentVersions = 2
- 常に最新の 2 バージョンを残す
- 3 個目以降の古いバージョンは削除

#### NewerNoncurrentVersions = 3
- 最新の 3 バージョンを残す
- 4 個目以降の古いバージョンは削除

### 実際の動作例

オブジェクト A のバージョン履歴: v1, v2, v3, v4, v5

設定: NewerNoncurrentVersions = 2
- 残す → v4, v5
- 消す → v1, v2, v3

### 他のパラメータとの組み合わせ
- 「何日後に削除する（NoncurrentDays）」と組み合わせることも可能
- 例えば「30日経った古いバージョンは削除」などもできる

> 「直近の いくつ残すか」を指定できるのが NewerNoncurrentVersions

---

## S3 ライフサイクルポリシーのトリガーまとめ

### 1. オブジェクト作成からの日数
- オブジェクトがバケットに アップロードされた日 を起点にカウント
- 例：30日後に Standard-IA に移行、365日後に削除

### 2. 非現行バージョン（旧バージョン）になってからの日数
- バージョニング有効バケット限定
- オブジェクトが 新しいバージョンに置き換えられた日 を起点にカウント
- 例：非現行化してから30日後に Glacier Deep Archive、730日後に削除

### 3. 削除マーカーに関する日数
- バージョニング有効バケットで DELETE したときに作成される「削除マーカー」が対象
- 例：削除マーカー作成から30日後に削除マーカーを消す

### 4. マルチパートアップロード未完了オブジェクト
- マルチパートアップロードを開始したが完了しなかったオブジェクトを対象
- 例：7日後に未完了のアップロードを自動削除