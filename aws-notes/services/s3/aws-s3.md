
# Amazon S3

## S3クロスリージョンレプリケーション（Cross-Region Replication: CRR）

### 概要

**S3バケットのオブジェクトを別リージョンのバケットに自動的に複製する機能**

### 基本構成

- **ソースバケット**と**宛先バケット**を設定
- 新しくアップロード・更新されたオブジェクトが、自動で別リージョンにコピーされる
- **コピーは非同期処理**（リアルタイムではなく、若干の遅延あり）

### 前提条件

- ソースと宛先の**両方のバケットでバージョニングが有効**
- **適切な IAM 権限**（レプリケーション用ロール）
- **レプリケーションルール設定**（バケット全体か、特定プレフィックス/タグごとに制御可能）

## ユースケース

### 災害対策 (DR)
東京リージョンにあるデータを、大阪リージョンやシンガポールにコピーしてBCP対策

### グローバル配信
ユーザーに近いリージョンからアクセスさせて、レイテンシ削減

### コンプライアンス要件
データを必ず複数の地理的リージョンに保持する必要がある場合

## 重要な制約

- **レプリケーションは新しいオブジェクトだけが対象**
- 過去のオブジェクトは自動コピーされない（必要ならS3バッチオペレーションで対応）
- 双方向レプリケーションはできるが、ループ防止に工夫が必要
- **追加のデータ転送コストがかかる**

## 同一リージョンレプリケーション（SRR: Same-Region Replication）

### 特徴

- **同じリージョン内の別バケット**に複製
- **マルチアカウント環境やセキュリティ隔離**に使用

## S3マルチリージョンアクセスポイント

**複数リージョンのバケットを束ねて、最適なリージョンにルーティングする仕組み**

## 双方向レプリケーションの仕組み

### 基本原則

S3 CRR は**一方向（ソース → 宛先）のみサポート**

### 双方向にする方法

双方向にしたい場合は以下の2つのレプリケーション設定をそれぞれ作る必要がある：

- **バケットA → バケットB** のレプリケーションルール
- **バケットB → バケットA** のレプリケーションルール

### レプリケーションループ対策

#### 問題

双方向にすると、同じオブジェクトが **A ⇔ B で無限コピー**されるリスクがある

#### 対策

- **レプリケーション元のバケットID**（バケットの所有者）やメタデータを利用してフィルタリング
- **「レプリケーションでコピーされたオブジェクトは再レプリケーションしない」という仕組み**がS3に組み込まれている

## S3バージョニング (Versioning)

### 概要
**S3バケットに保存するオブジェクトを世代管理できる機能**

### 基本動作

#### バージョンID付与
バージョニングを有効化すると、オブジェクトに**バージョンID**が自動で付与される

#### 新バージョン作成
同じキー（例: file.txt）にアップロードすると**新しいバージョン**が作成され、古いバージョンも残る

> **特徴**: 「上書き」ではなく「履歴が全部残る」状態

### 復元機能

#### 過去バージョンの復元
誤って上書きした場合でも以前のバージョンに戻せる

#### 削除からの復元
- 削除すると「**Delete Marker**」という特別なバージョンが追加されるだけ
- そのマーカーを消せば復活

### ユースケース

- **誤操作対策**（上書きや削除からの保護）
- **監査対応**（どの時点でどんなデータがあったか追跡可能）
- **クロスリージョンレプリケーション (CRR) の前提機能**
  - レプリケーションを設定するにはバージョニングが必須

### 注意点

#### 容量増加
- 古いバージョンも残り続けるため、**ストレージコストが増える**
- **ライフサイクルルール**で古いバージョンを自動削除/Glacierに移行するのが一般的

#### 設定変更の制限
バージョニングは「有効化 or 無効化」できるが、一度有効化したら完全には解除できず「**一時停止（suspended）**」にするだけ