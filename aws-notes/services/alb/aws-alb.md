# AWS ALB (Application Load Balancer)

## Connection Draining（コネクション・ドレイニング）

### 概要

**ロードバランサー（特に ELB / ALB / NLB）で使われる既存接続の処理を安全に完了させてからターゲットを切り離す仕組み**

### 動作内容

ロードバランサー配下のターゲット（EC2やECSタスク）を停止・登録解除したときに：

1. **新しいリクエストは送らない**
2. **既存のリクエストは設定したタイムアウト時間までは処理を継続**
3. **タイムアウトを過ぎたら、残っている接続は強制終了**

これにより、途中のリクエストを途中で切らずに **graceful に切り替えできる**

### 設定項目

- **Connection Draining のタイムアウト値**を指定可能（例: 300秒）
- その時間内に処理が終わらなければ強制終了される

## ユースケース

### ローリングデプロイ / Blue-Greenデプロイ
新バージョンに切り替えるとき、旧インスタンスに流れているリクエストを処理しきってから外す

### スケーリングイン
Auto Scaling でインスタンスを減らすとき、途中のセッションを切らない

### メンテナンス作業
サーバーを落とす前に既存接続を整理

## まとめ

**Connection Draining = ターゲットを外すとき、既存接続を安全に処理してから切り離す仕組み**

- **新しいリクエストは送らない**
- **既存リクエストは一定時間は処理を続ける**
- **デプロイやスケーリング時の安全な切り替えに必須**

## スティッキーセッション（Sticky Session）

### 概要
**ロードバランサーが同じクライアントからのリクエストを常に同じバックエンドに送る仕組み**

### なぜ必要？

**通常の場合：**
- ALB（Application Load Balancer）やELBは**ラウンドロビン**などでリクエストを分散

**問題のケース：**
- アプリによっては「**セッション情報をサーバーのローカルメモリに保存**」している場合がある
- 別のサーバーにリクエストが飛んだ時に**セッション情報がなくなってログアウト扱い**になる

> **解決策**: 「同じユーザーはずっと同じサーバーに振り分ける」仕組みが**スティッキーセッション**

### AWSでの実装

#### Application Load Balancer (ALB)
- **Cookieベースのスティッキーセッション**（AWSALB Cookie を発行）
- **有効期限を設定可能**

### メリット / デメリット

####  メリット
- セッション管理がサーバーローカル依存でも動作する
- 特定のユーザーがログアウトされる問題を回避

####  デメリット
- **負荷分散が偏る**（あるサーバーにセッションが集中してしまう）
- **スケーリングするときにバランスが崩れる**

### 現代のベストプラクティス

> **推奨**: セッション情報を**ElastiCache (Redis)やDynamoDBに外だし**して「スティッキー不要」にするのがベストプラクティス

### まとめ

- **スティッキーセッション** = 同じクライアントを同じサーバーに固定的にルーティングする仕組み
- **AWSのALB/CLB**でCookieを使って実現可能
- **モダン構成**では**ステートレス化**（セッションを外部ストアに保存）してスティッキー不要にするのが一般的