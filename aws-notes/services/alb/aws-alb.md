# AWS ALB (Application Load Balancer)

## Connection Draining（コネクション・ドレイニング）

### 概要

**ロードバランサー（特に ELB / ALB / NLB）で使われる既存接続の処理を安全に完了させてからターゲットを切り離す仕組み**

### 動作内容

ロードバランサー配下のターゲット（EC2やECSタスク）を停止・登録解除したときに：

1. **新しいリクエストは送らない**
2. **既存のリクエストは設定したタイムアウト時間までは処理を継続**
3. **タイムアウトを過ぎたら、残っている接続は強制終了**

これにより、途中のリクエストを途中で切らずに **graceful に切り替えできる**

### 設定項目

- **Connection Draining のタイムアウト値**を指定可能（例: 300秒）
- その時間内に処理が終わらなければ強制終了される

## ユースケース

### ローリングデプロイ / Blue-Greenデプロイ
新バージョンに切り替えるとき、旧インスタンスに流れているリクエストを処理しきってから外す

### スケーリングイン
Auto Scaling でインスタンスを減らすとき、途中のセッションを切らない

### メンテナンス作業
サーバーを落とす前に既存接続を整理

## まとめ

**Connection Draining = ターゲットを外すとき、既存接続を安全に処理してから切り離す仕組み**

- **新しいリクエストは送らない**
- **既存リクエストは一定時間は処理を続ける**
- **デプロイやスケーリング時の安全な切り替えに必須**