# AWS VPC

## VPC Flow Logs

### 概要

**正式名称**: VPC Flow Logs

**VPC 内で ENI（Elastic Network Interface）を通過する通信のメタデータを記録する仕組み**

つまり「**どのIPがどのポートにいつ通信したか**」が分かるログ

### ログに含まれる情報

#### 代表的なフィールド

- **version**（バージョン）
- **account-id**（AWSアカウント）
- **interface-id**（ENI ID）
- **srcaddr / dstaddr**（送信元 / 宛先 IP）
- **srcport / dstport**（送信元 / 宛先 ポート）
- **protocol**（TCP/UDP/ICMP など）
- **action**（ACCEPT / REJECT → セキュリティグループやNACLで許可されたか拒否されたか）
- **bytes, packets**（通信量）

> **Note**: 中身は「パケットキャプチャ」ではなく、**通信のサマリ情報（メタデータ）**

### 取得できる単位

フローログは以下の単位で有効化できる：

- **VPC 単位**
- **サブネット単位**
- **ENI 単位**

### 出力先

- **CloudWatch Logs** に送って検索・可視化
- **S3 バケット**に保存して後から Athena や SIEM で解析

## 主なユースケース

### セキュリティ監査
**不審なアクセスが無いか確認**

### トラブルシューティング
**通信ができないときに「NACLで拒否されてるのか？」「そもそもパケット来てないのか？」を確認**

### ネットワークモニタリング
**トラフィック量や利用傾向を可視化**

## まとめ

- **フローログ** = VPCのネットワーク通信の記録（メタデータ）
- **通信の中身は取れず**、送信元/宛先・ポート・プロトコル・許可/拒否 などが分かる
- **出力先**: CloudWatch Logs または S3
- **セキュリティやトラブルシュートに必須**


---

## 拡張 VPC ルーティング

### 概要
Amazon Redshift の データの入出力の経路を VPC ルートテーブルで制御できる機能

通常、Redshift は S3 などと直接通信するが、拡張 VPC ルーティングを有効にすると：
- 必ず VPC のルートテーブルを経由して通信
- その結果、VPC エンドポイント / NAT / ファイアウォール / VPC Flow Logs などを適用できる

### ユースケース

#### セキュリティ強化
- Redshift → S3 の COPY/UNLOAD をインターネット経由ではなく VPCエンドポイント経由 にできる
- 監査要件で「全トラフィックをキャプチャ・ログ化したい」場合に使える

#### トラフィック制御
- Redshift → DynamoDB, Amazon EMR, などの通信も VPCルートに従わせられる

#### 監査対応
- VPC Flow Logs で通信記録を残せる（普通のRedshift直通信ではログに残らない）

### 注意点
- **デフォルトは無効**（Redshift → S3 はAWSバックボーン直通）
- **一度有効化すると無効化は不可**（クラスター作成時に指定する必要あり）
- **コスト増える可能性**（NAT Gateway経由になるとNAT利用料が発生）

### まとめ
- **拡張 VPC ルーティング = Redshift のデータ転送を VPC ルート経由に強制できる機能**
-  **セキュリティや監査目的で利用**（VPCエンドポイントやFlow Logsを使える）
-  **作成時に有効化する必要あり**（後から変更不可）

**「Redshiftのデータ転送をVPCルートで制御できるようにする機能」**