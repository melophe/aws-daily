# CloudWatch メトリクス

## 概要

**数値データ（メジャー）**を定期的に収集・記録したもの

時系列で保存されるので、グラフ化やアラーム設定が可能

### 例
- **EC2のCPU使用率（%）**
- **ディスク読み書きIOPS**
- **ネットワーク送受信量（Bytes）**
- **RDSのDB接続数**
- **Lambdaの実行回数・エラー数**

## メトリクスの構成

CloudWatchメトリクスは「名前空間・メトリクス名・ディメンション」で整理される

### 名前空間（Namespace）
メトリクスのカテゴリ

**例**: `AWS/EC2`, `AWS/RDS`, `AWS/Lambda`

### メトリクス名（Metric Name）
実際の項目

**例**: `CPUUtilization`, `NetworkIn`, `ReadIOPS`

### ディメンション（Dimension）
メトリクスを細分化する属性

**例**: EC2ならインスタンスID、EBSならボリュームID

## 標準とカスタム

### 標準メトリクス（Default Metrics）
- AWSが自動で収集するもの（EC2 CPU利用率など）
- EC2なら1分間隔（デフォルトは5分）

### カスタムメトリクス（Custom Metrics）
CloudWatch エージェントやアプリから自分で送るもの

**例**:
- メモリ使用率（EC2標準では取れない）
- アプリ内の処理時間やリクエスト数

## できること

- **グラフ化**（CloudWatchコンソールやダッシュボードで）
- **アラーム設定**（閾値を超えたら通知）
- **自動スケーリング連携**（例：CPU > 80% が5分続いたらEC2を増やす）

## CloudWatch Logs との違い

| 種類 | データ形式 | 用途 |
|------|------------|------|
| **Metrics** | 数値の時系列データ | パフォーマンス監視・アラート |
| **Logs** | テキストのログデータ | デバッグ・トラブルシューティング |

> **Note**: Logsをベースに「ERRORが出たらカウント」してメトリクス化することも可能

## Auto Scaling との連携

### 概要
Auto Scaling Group (ASG) は「どのタイミングでインスタンスを増減させるか」を判断するために CloudWatch メトリクスを参照

### 主要メトリクス

#### EC2のCPU使用率
- 80%以上が5分続いたらインスタンスを追加
- 20%以下が10分続いたらインスタンスを削除

#### ALB（ロードバランサー）のリクエスト数
- `RequestCount` / `TargetResponseTime`
- リクエストが多すぎて遅延してきたらスケールアウト

#### カスタムメトリクス
例：「キューの長さ（SQS ApproximateNumberOfMessages）」が100超えたらスケールアウト

## スケーリングの種類

ASGで使えるスケーリングの方式は CloudWatch メトリクスとセット

### ターゲット追跡スケーリング
- **例**: CPUを常に50%に保つようにインスタンス数を調整
- CloudWatch メトリクスをターゲット値に設定

### ステップスケーリング
- **例**: CPU > 70% → 1台追加、CPU > 90% → 3台追加
- CloudWatch アラームを条件にして段階的にスケール

### スケジュールスケーリング
- メトリクスではなく「時間」で制御
- **例**: 平日昼はインスタンスを増やす

## メトリクス vs ログ の詳細比較

### 1. CloudWatch メトリクス

最初から数値として管理されるデータ

**例**: CPU使用率（%）、NetworkIn（Bytes）、ディスクReadIOPS など

#### 仕組み
- 数値なので時系列グラフ化が簡単
- しきい値を決めて ASGのスケーリング条件に直接使える
- 粒度（1分/5分間隔など）で集計されて保存される

> **Point**: ASGとの相性が良いのは、メトリクスが「数値」として標準化されているから

### 2. CloudWatch Logs

テキストの生ログ

**例**: `ERROR: DB connection failed`

#### 特徴
- そのままではスケーリングに使いにくい
- **メトリクスフィルター**でメトリクス化可能

#### メトリクス化の例
- ログに "ERROR" が出た回数を数えてメトリクス化
- アクセスログから「HTTP 5xx の件数」をカウントしてメトリクス化

> **Point**: ログ = 生データ、メトリクス = 数値化された指標

### 3. 実用例の比較

#### メトリクスから直接スケール
```
CPUUtilization > 80% が5分続いたらEC2を追加
```

#### ログをメトリクス化してスケール
```
アプリログで 'Queue length: X' と出力 
↓
そのXをCloudWatchメトリクスに変換 
↓
ASGでスケーリング
```

```
NginxログでHTTP 5xxが100件超えたらスケールアウト
```

## まとめ

- **CloudWatch メトリクス** = AWSリソースやアプリの状態を数値化して時系列で保存する仕組み
- **ASG**はCloudWatchメトリクスをベースにスケーリング
- 標準メトリクス（CPU利用率など）もカスタムメトリクス（アプリ独自の指標）も使える
- 最も多いのは「**CPU利用率**」か「**ALBのリクエスト数**」

### データタイプ別の特徴

| データタイプ | 特徴 | ASG連携 |
|--------------|------|--------|
| **CloudWatch メトリクス** | もともと数値化されているデータ | 直結しやすい |
| **CloudWatch Logs** | テキストログ | メトリクスフィルターで数値化すれば使える |