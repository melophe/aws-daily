# Amazon SNS (Simple Notification Service)

## 概要

クラウド上で動作するメッセージング・通知サービス
アプリケーション間やアプリケーションから人への通知を簡単に送信可能

## 特徴

### Pub/Subモデル (Publish/Subscribe)

発行者（Publisher）がメッセージを「トピック」に送信すると、登録者（Subscriber）がそのメッセージを受け取る仕組み

#### 例
```
CloudWatch アラーム → SNS トピック → 管理者のメール・Slack・Lambda に通知
```

### 複数のプロトコルに対応

SNS はメッセージをさまざまなエンドポイントに配信できる

| プロトコル | 用途 |
|------------|------|
| **Email** | メール通知 |
| **SMS** | 携帯電話のショートメッセージ |
| **モバイルプッシュ通知** | APNs、GCM など |
| **HTTP/HTTPS エンドポイント** | Web サービスへの通知 |
| **Amazon SQS** | キューサービス連携 |
| **AWS Lambda** | サーバーレス関数の自動実行 |

### スケーラブルで高可用性

- フルマネージドなのでサーバー管理不要
- イベントが増えても自動的にスケール

## よくあるユースケース

### アラート通知
CloudWatch で異常検知 → SNS で管理者にメール/Slack 通知

### イベント駆動アーキテクチャ
アプリが SNS にイベント発行 → Lambda や SQS で処理を分散

### ユーザー通知サービス
EC サイトで「注文完了」メールや SMS 送信

### 分散システム間の連携
あるマイクロサービスの更新を SNS でブロードキャストして他サービスに伝達

## 主な機能

- **Push通知** - モバイルアプリへの通知
- **SMS** - 携帯電話への文字メッセージ
- **Email** - メール送信
- **HTTP/HTTPS** - Webサービスへの通知
- **SQS** - 他のAWSサービスとの連携

## まとめ

- イベント通知やメッセージ配信のハブ
- Pub/Subモデルで複数宛先に簡単に配信可能
- 運用管理が不要でスケーラブル

## SNS の役割

SNSはトピック（Topic）という中継地点を用意して、

1. Publisherがトピックにメッセージを送る
2. そのトピックに登録しているSubscriber全員にメッセージを配信する

```
Publisher → [ SNS トピック ] → Subscriber A (メール)
                              → Subscriber B (SMS)
                              → Subscriber C (Lambda)
```

### 用語解説
- **Publisher** = 発信者（メッセージを出す側）
- **Subscriber** = 受信者（通知を受け取る人やシステム）
- **SNS** = PublisherとSubscriberをつなぐ中継ハブ

## SNS トピック

### 概要
- メッセージを配信するための「チャンネル」のようなもの
- 1つのトピックに複数の受信者（サブスクライバー）を登録可能
- パブリッシュ・サブスクライブ（Pub/Sub）モデルの中心概念

### トピックタイプ
- **Standard**: 順序保証なし、高スループット
- **FIFO**: 順序保証あり、重複排除機能

### 基本的な流れ
1. **トピック作成**
2. **サブスクライバー追加**（SMS、Email、HTTP等）
3. **メッセージをパブリッシュ**
4. **全サブスクライバーに一斉配信**

## パブリッシュとは

### 定義
- 作成したSNSトピックに対してメッセージを送信すること
- 「投稿する」「配信する」という意味

### パブリッシュする方法
- **AWSコンソール** - ブラウザから手動送信
- **AWS CLI** - コマンドライン
- **SDK** - プログラムから自動送信
- **他のAWSサービス** - Lambda、CloudWatch等

## サブスクライブの流れ

### サブスクライブ = 事前設定

```
1. SNS トピック作成「system-alerts」
   ↓
2. 電話番号 +819012345678 を「サブスクライブ」
   ↓  
3. 確認 SMS → 承認
   ↓
4. 登録完了（事前設定完了）
   ↓
5. 後日、トピックにメッセージをパブリッシュ
   ↓
6. 登録済みの番号に自動で SMS 送信
```

## SMS 送信の2つの方法

### A. 直接送信（事前設定不要）
- その都度、電話番号を指定してSMS送信
- `PhoneNumber='+819012345678'`

### B. トピック経由（事前設定必要）
- 事前にサブスクライブ登録
- 後は`TopicArn`だけでSMS送信

---

## メッセージ配信保証

### 1. SQS宛て

- **保証**: At-least-once delivery（少なくとも1回は届く）
- SNS → SQSへの配信は信頼性が高い
- 届かなかった場合はリトライされるので、ほぼ確実にSQSに入る
- ただし「重複して届く可能性あり」なので、利用側で冪等性を考慮する必要がある

### 2. Lambda宛て

- **保証**: At-least-once delivery（少なくとも1回は呼ばれる）
- SNS → Lambdaの呼び出しはリトライされる
- 失敗が続くとDLQ（デッドレターキュー）を設定しておくのがベストプラクティス

### 3. HTTP(S)エンドポイント

- **保証**: At-least-once delivery（少なくとも1回）
- 配信失敗時はリトライあり（指数バックオフ）
- それでも失敗が続くと配信停止になる場合がある
- つまり「受け取り側が落ちてたら最悪届かない」可能性がある

### 4. Email/SMS/モバイルプッシュ通知

- **保証**: ベストエフォート（best effort）
- ネットワークやキャリア、メールプロバイダ次第で届かないこともある
- SNS側では「送った」というログは残るが、必ず相手に届いた保証はない

### 配信保証一覧

| 宛先 | 配信保証 | 備考 |
|---------|------------|------|
| **SQS** | At-least-once | 高信頼・重複の可能性あり |
| **Lambda** | At-least-once | リトライあり・DLQ推奨 |
| **HTTP(S)** | At-least-once（条件付き） | リトライ後も失敗すると届かない |
| **Email/SMS** | ベストエフォート | ネットワークや外部要因で届かない可能性あり |

---

## SNS配信保証の詳細

SNSはat least once delivery（少なくとも1回は配信）を保証する。つまり、一度トピックに届いたメッセージは必ずどこかに配送されるが、重複する可能性がある。

### サブスクライバーごとの配信保障

#### 強い配信保証あり

**Amazon SQS**
- SNS → SQS連携は少なくとも1回配送
- 配信失敗時も再試行あり
- 永続キューに入るため安全性が高い

**AWS Lambda**
- SNSからLambda呼び出しも少なくとも1回実行されるまでリトライ

#### 弱めの配信保証

**Email/SMS/HTTP(S)エンドポイント**
- 配信は試みられるが、相手側が拒否したり落ちていたら失敗
- SNSは再試行（HTTPは最大数日間リトライ）するが、最終的に届かない可能性もある

### Dead-Letter Queue (DLQ)

- SNSには配信失敗時にメッセージを退避させる仕組み（DLQ: Dead Letter Queue）がある
- サブスクライバーに配信できなかったメッセージをSQSやLambdaのDLQに保存可能
- 運用チームはDLQを監視して、失敗メッセージを再処理可能

### まとめ

- SNSは「少なくとも1回は配送される」配信保障を提供
- 強い保証が欲しいならSQSやLambdaと組み合わせる
- 配信失敗を拾いたいならDLQを設定するのがベストプラクティス