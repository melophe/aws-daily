# Amazon Redshift WLM

## WLMとは

### 概要
WLM (Workload Management) は、RedshiftクラスタにやりとりられるSQLクエリの実行キューを制御する仕組み

### 目的
- クエリを整理してリソース競合を防ぐ
- 優先度や実行順序をコントロール
- 重いクエリが軽いクエリをブロックしないようにする

---

## WLMの仕組み

### 基本動作
Redshiftにクエリが来ると、必ずWLMのキューに入る

### キュー設定による制御項目
- どのキューに入るか（ルールによる振り分け）
- 1キューあたりの同時実行数（Concurrency）
- キューの優先度（Priority）

### 待機状態
キューが満杯なら待機状態（queue wait）になり、順番が来るまで実行されない

---

## WLMの種類

### 自動WLM（Auto WLM）- デフォルト推奨
- Redshift が自動的にクエリを分類してリソース配分を最適化
- 優先度の設定も可能（high, normal, low）
- 通常はこれを使用するのがベストプラクティス

### 手動WLM（Manual WLM）
- 管理者がキューを手動で定義
- 例：BIツール用の軽いSELECTは並列8まで、ETLバッチは並列2まで
- 細かい制御は可能だが、調整コストが高い

---

## WLMの設定例

### キュー構成例

#### Queue 1: ETL処理用
- 同時実行数: 2
- 優先度: 高

#### Queue 2: BIユーザーの分析用
- 同時実行数: 8
- 優先度: 中

#### Queue 3: Ad-hoc クエリ用
- 同時実行数: 3
- 優先度: 低

### 効果
ETL が優先的にリソースを確保しつつ、BIツールや分析クエリも処理可能

---

## WLMが解決する課題

### 主要課題
- クエリの同時実行数が多すぎて、リソースが奪い合いになる
- 重いクエリが入ってきて、軽いクエリが遅延する
- ユースケースごとに実行順序をコントロールしたい

### 解決方法
キュー管理でこれらの問題を解決

---

## まとめ

Amazon Redshift WLM = クエリの実行キューを管理して、優先度・同時実行数・順序を制御する仕組み

試験で「Redshift クエリの順序・優先度を制御」と来たら → WLM が答え

Amazon Redshift には、最初から Workload Management (WLM) が組み込まれています。

新しくクラスターを作成すると、デフォルトで「自動WLM（Auto WLM）」 が有効化される