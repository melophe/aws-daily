# AWS Batch

## 概要

### AWS Batch
- **特徴**: バッチ処理専用のフルマネージドサービス
- **基盤**: コンテナ（ECS/Fargate/EC2）を使って大規模な並列処理が可能
- **用途**: HPC（ハイパフォーマンスコンピューティング）、研究計算、動画エンコード、データ分析など
- **基盤技術**: EC2 / Fargate / Spot を裏で使用
- **割引適用**: 選択したコンピュート環境により割引モデルが変わる

> AWSでバッチといえばまずこれ

## バッチ処理とは

**リアルタイムに即時処理するのではなく、「まとめて一括で処理」すること**

## AWSでのバッチ処理の選択肢

### 用途別の選択指針

- **王道**: AWS Batch（本格的なバッチ/HPC向け）
- **軽量**: Lambda + EventBridge  
- **データ分析**: EMR / Glue / Athena
- **ワークフロー型**: Step Functions

## 各サービス詳細

### 1. AWS Batch
- **特徴**: バッチ処理専用のフルマネージドサービス
- **基盤**: コンテナ（ECS/Fargate/EC2）を使って大規模な並列処理が可能
- **用途**: HPC（ハイパフォーマンスコンピューティング）、研究計算、動画エンコード、データ分析など

> AWSでバッチといえばまずこれ

### 2. Amazon EC2 Auto Scaling + EC2
- **処理方式**: 単純に EC2 上でスクリプトやジョブを実行してバッチ処理
- **コスト最適化**: Auto Scaling や Spot Instance を組み合わせると可能

### 3. Amazon ECS / AWS Fargate
- **特徴**: コンテナベースのバッチジョブ
- **スケジュール**: ECS の スケジュールドタスク 機能で「毎日1回実行」など可能
- **メリット**: サーバーレスでコンテナを立ち上げて処理できる

### 4. AWS Lambda
- **適用範囲**: 軽量なバッチ（数分以内、メモリ・CPU制約が小さい処理）に最適
- **実行方法**: EventBridge（旧CloudWatch Events）で定期実行可能
- **例**: 1時間ごとにS3のファイルを処理、毎日集計して結果を保存

### 5. Amazon EMR
- **基盤**: Hadoop/Spark クラスターを使った大規模データ処理
- **強み**: データ分析系のバッチ処理に特化

### 6. Step Functions
- **機能**: ワークフローオーケストレーション
- **連携**: LambdaやECSタスクを組み合わせて「一連のバッチ処理ジョブ」を実行

### 7. その他関連サービス

#### Amazon Glue
- **特化**: ETLバッチ処理（データ変換/加工）に特化

#### Data Pipeline
- **状況**: 今は推奨されないが一部で利用

#### Athena + S3
- **機能**: S3に溜めたデータをまとめてSQLバッチ


## AWS Batch での割引適用

### 1. リザーブドインスタンス（RI）

#### 適用条件
- Batch のコンピュート環境に **EC2 を選択**した場合

#### 制限事項
- RI は特定インスタンスタイプに縛られる
- Batch のスケジューラがインスタンスを柔軟に変更する場合、適用漏れが発生しやすい

> **評価**: あまり Batch 向きではない

### 2. Savings Plans

#### 適用条件
- Batch のコンピュート環境が **EC2 または Fargate** の場合

#### 特徴
- **Compute Savings Plans** を購入すれば、Batch が EC2/Fargate のどちらを使用しても割引適用

> **評価**: 一番相性が良い

### 3. スポットインスタンス

#### 特徴
- **AWS Batch の大きな強み**
- コンピュート環境を EC2 Spot にすれば **最大90%割引** で計算可能

#### 適合理由
- Batch はジョブをキューイングしてリトライ可能
- **中断に強い** 仕組みでスポットインスタンスを活用しやすい

> **評価**: Batch に最も相性が良い

### 割引モデル比較表

| モデル | Batch での利用可否 | 向き不向き |
|--------|-------------------|------------|
| **リザーブドインスタンス（RI）** | 使える（EC2 のみ） | 柔軟性が低く Batch 向きではない |
| **Savings Plans** | 使える（EC2 / Fargate 両方OK） | 💡 一番実用的 |
| **スポットインスタンス** | 使える（EC2 Spot） | 💡 Batch に最も相性が良い |

### 推奨選択指針

**AWS Batch はどの割引モデルでも使用可能だが、実際の選択は以下が推奨：**

- **短時間バッチ** → **スポットインスタンス**（コスト最強）
- **安定稼働 + 将来 Fargate も検討** → **Compute Savings Plans**

## AWS Batch でのスポットインスタンス活用

### AWS Batch の場合

#### コンピュート環境の選択肢
- **EC2（オンデマンド or Spot）**を選択可能
- **Spot 選択時**: 「中断されてもいいバッチ処理」に最適
- **Fargate 選択時**: オンデマンドのみ（割引は Savings Plans を使用）

### ECS + Spot の動作パターン

#### 基本動作
1. ECS クラスターに「Spot インスタンス」を含めて構成
2. タスク配置時、ECS スケジューラが Spot インスタンス上でタスクを実行
3. Spot 中断時、ECS がタスクを別のインスタンスに再配置

#### 適用用途
- バッチ処理
- スケールアウト処理

## スポットインスタンス活用方法の比較

### 1. EC2 単体 + Spot

#### 概要
- 自分で EC2 Spot インスタンスを起動・管理
- アプリやジョブを直接デプロイ（例：Apache、Nginx、独自アプリ）

#### 特徴
- **中断・再配置対応**: 自分で実装が必要
- **自動再配置**: 自前で仕組みを用意
- **リスク**: AWS Batch のような「Spot 再試行機構」なしでは業務が落ちやすい

> **評価**: 管理が重い。スポットを活かすには工夫が必要

### 2. ECS（EC2 起動タイプ）+ Spot

#### 概要
- ECS クラスターのキャパシティプロバイダーに Spot インスタンスを登録
- ECS が「どの EC2（オンデマンド or Spot）に配置するか」を調整

#### 特徴
- **自動再配置**: ECS サービス/タスクが Spot インスタンスごと消されても自動で別インスタンスに再配置
- **管理**: スケジューラやオートスケーリングを ECS が管理
- **リスク吸収**: 「Spot が中断されやすい」というリスクを ECS が吸収

> **評価**: コンテナ基盤として Spot を効率的に使用可能。実務では圧倒的にラク

### スポット活用方法比較表

| 方法 | 説明 | 向き不向き |
|------|------|------------|
| **EC2 単体 + Spot** | EC2 を直接 Spot で起動して管理 | シンプルだが中断処理を自分で対応。学習や単発実験向き |
| **ECS（EC2 起動タイプ）+ Spot** | ECS クラスターの中で Spot を活用 | 本番運用やバッチ処理など、中断再配置を ECS が吸収してくれる |