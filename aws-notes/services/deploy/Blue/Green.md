# Blue/Greenデプロイ

## Blue/GreenデプロイとConnection Drainingの関係

### Blue/Greenデプロイの構成

**Blue/Greenデプロイでは以下の構成を使用**

- **Blue** = 現行バージョン（稼働中）
- **Green** = 新バージョン（テスト済み、これから切り替え）

### 切り替え時の処理

**切り替えのときに旧バージョン（Blue）のターゲットを外す必要がある**

このときに **Connection Draining（ALBでは Deregistration Delay）** が有効になっていると：

1. **Blue に対して新しいリクエストはもう送らない**
2. **既に処理中のリクエストは一定時間（例: 300秒）許可して処理を完了**
3. **タイムアウトを過ぎたら未完了の処理は切断し、Blueを完全に外す**

> **効果**: 「ユーザーが利用中のセッションを途中でブチ切る」ことを防げる

## Connection Drainingがない場合の問題

### 問題点

- **デプロイ切り替えの瞬間に Blue が一気に外れる**
- **まだ処理中のリクエストが全部エラーで返る可能性大**
- **特に長時間処理（アップロード/DBトランザクション）のあるアプリだと致命的**

## まとめ

**Blue/Greenデプロイのときによく使われるのが Connection Draining（Deregistration Delay）**

- **ユーザーへの影響を最小化するために必須の仕組み**
- **デプロイ時だけでなく、スケーリングインやメンテナンスでも同じ効果**