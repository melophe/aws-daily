# AWS Systems Manager

## 基本概要

### Session Manager の認証

**EC2 側に IAM ロール（インスタンスプロファイル）をアタッチするのがポイント**

Session Manager は「EC2 インスタンス上の SSM Agent ↔ AWS Systems Manager サービス」と通信して動作します。

### 認証の必要性

EC2 が SSM サービスに対して「自分は認証されたインスタンスです」と名乗る必要があり、その認証に **IAM ロール** を使用します。

## 設定手順

### 実際の設定イメージ

1. **IAM でロールを新規作成**
2. **信頼ポリシー**: `ec2.amazonaws.com` を信頼するように設定
3. **ポリシー**: `AmazonSSMManagedInstanceCore` をアタッチ
4. **EC2 への適用**: 起動時にそのロールをインスタンスプロファイルとしてアタッチ
   - 起動済みインスタンスなら「IAM ロールをアタッチ/変更」から付与可能
5. **登録**: EC2 上の SSM Agent がそのロールを使って Systems Manager に登録

## IAM ロールの仕組み

### ロールの2つの要素

IAM ロールには大きく分けて2つの要素があります：

#### 1. 信頼ポリシー (Trust policy)
「このロールを誰（どのサービス）が引き受けて使えるか？」を定義

#### 2. アクセス許可ポリシー (Permission policy)
「このロールを使ったときに AWS 内で何ができるか？」を定義

### なぜ ec2.amazonaws.com を信頼するのか

- 今回作るロールは **EC2 インスタンスが引き受けるロール（インスタンスプロファイル）**
- 「このロールは EC2 サービスが使っていいよ」と宣言する必要がある
- それを指定するのが **信頼ポリシーの Principal**

### ロール構成図

```
[ IAM Role ]
   ├─ 信頼ポリシー → "EC2 がこのロールを使ってよい"
   │                 （ec2.amazonaws.com を Principal に指定）
   └─ アクセス許可ポリシー → "使ったら Systems Manager と通信できる"
                           （AmazonSSMManagedInstanceCore）
```

## ポリシーの詳細

### 信頼ポリシー (Trust policy)

#### 特徴
- ロールそのものに「誰がこのロールを引き受けられるか」を埋め込む設定
- **IAM ロール作成時に自動的に付与される**
- ユーザーが「アタッチする」という操作をするものではない

### アクセス許可ポリシー (Permission policy)

#### 特徴
- 「そのロールを使ったら何ができるか」を定義
- **ポリシーをアタッチする** 形で設定
- 今回は最低限として `AmazonSSMManagedInstanceCore` をアタッチ

## ポリシー設定の違い

| ポリシー種類 | 設定方法 | 操作 |
|-------------|----------|------|
| **信頼ポリシー** | ロール作成時に自動的についてくる | アタッチ操作は不要 |
| **アクセス許可ポリシー** | ユーザーが手動で設定 | AmazonSSMManagedInstanceCore をロールにアタッチ |

### 設定の考え方

「2つアタッチする」というよりは：
- **信頼ポリシー**: ロールの中身に最初から入れる
- **アクセス許可ポリシー**: 追加でアタッチする

## 実際の手順（AWSコンソール）

###  手順

1. **IAM ロール作成**
   - ユースケースで「EC2」を選ぶ
   - → このとき自動的に信頼ポリシーが `ec2.amazonaws.com` になる

2. **ポリシー選択**
   - ポリシー選択画面で `AmazonSSMManagedInstanceCore` を選んでアタッチ

3. **EC2 への適用**
   - 完成したロールを EC2 にアタッチ