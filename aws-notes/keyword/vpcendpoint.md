# VPCエンドポイント

## 概要

VPCの中から特定のAWSサービスへプライベートにアクセスする出入口

インターネットを経由せず、AWSバックボーンで直接接続する仕組み

---

## VPCエンドポイントの種類

### Gateway型（S3, DynamoDB用）

#### 特徴
ルートテーブルに「このサービスはVPCエンドポイント経由」と記述して使用

#### 対象サービス
- S3
- DynamoDB

### Interface型（ほとんどのサービス, PrivateLink含む）

#### 特徴
VPC内にENI（Elastic Network Interface）を作成してアクセス

#### 対象サービス
S3、DynamoDB以外のほとんどのAWSサービス

---

## アクセス方式比較

### VPCエンドポイントなしの場合

```
EC2 (VPC内) → IGW / NAT Gateway 経由 → インターネット経由 → AWSサービス
```

#### 特徴
- 通常通りアクセス可能
- パブリックIP or NAT が必要
- インターネット経由の通信

### VPCエンドポイントありの場合

```
EC2 (VPC内) → VPCエンドポイント → AWSバックボーン内で直接 → AWSサービス
```

#### 特徴
- 完全プライベート通信（パブリックIP不要）
- セキュリティ強化
- NATを経由しないためコスト削減

---

## インターネット接続方式の比較

| 方式 | 概要 | 通信経路 | セキュリティ |
|------|------|----------|------------|
| **IGW (Internet Gateway)** | VPCをインターネットに直結 | 完全にインターネット経由 | パブリック通信 |
| **NAT Gateway** | プライベートサブネットから代理接続 | NAT経由でインターネット | 見かけ上プライベート |
| **VPCエンドポイント** | AWSサービスへ直接接続 | AWSバックボーン内 | 完全プライベート |

---

## IGW と NAT Gateway の詳細

### IGW (Internet Gateway)

#### 役割
VPCをインターネットに直結する出入り口

#### 利用方法
パブリックサブネットのEC2などが自分のパブリックIPを使って直接インターネット通信

#### 通信方式
完全にインターネット経由

### NAT Gateway

#### 役割
プライベートサブネット内のEC2がインターネットに出る際に使用

#### 仕組み
- EC2にパブリックIPがなくても利用可能
- NAT Gatewayが代理で外部に接続
- NAT Gateway自身がパブリックIPを持ってIGWからインターネットに接続

#### 通信方式
見かけ上「プライベートからの通信」だが、実際はインターネットを経由

---

## プライベート通信の選択肢

インターネット経由を避けたい場合の選択肢：

### AWSサービスへの接続
- **VPCエンドポイント (Gateway型/Interface型)**: AWSサービスへ直結

### VPC間接続
- **VPC Peering**: VPC間直接接続
- **Transit Gateway**: 複数VPC間のハブ
- **PrivateLink**: 他アカウントへの直結

すべてAWSバックボーン内のプライベート通信

---

## まとめ

VPCエンドポイント = VPCから外部サービスにプライベート接続するための専用出入口

### 主要な利点
- インターネット経由を回避
- セキュリティ強化
- コスト削減（NAT料金不要）
- AWSバックボーン内での高速通信

### AWS PrivateLinkとの関係
AWS PrivateLinkは以下の2つがセットで構成：
- インターフェースVPCエンドポイント
- VPCエンドポイントサービス

NAT Gateway の通信経路

プライベートサブネットのEC2 → NAT Gateway

EC2はデフォルトルートをNAT GWに向ける

NAT Gateway → Internet Gateway (IGW)

NAT GW自身はパブリックサブネットに置かれる

パブリックIPを持っていて、IGW経由で外に出られる

IGW → インターネット or AWSサービスのパブリックエンドポイント

例えば S3のパブリックエンドポイントへアクセス

NAT Gateway = IGWを利用する前提の仕組み

NAT GWが「プライベートIPをパブリックIPに変換」する役割をして、
結局はIGWから外に出ていく