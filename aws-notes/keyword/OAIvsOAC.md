# CloudFront オリジンアクセス制御

## OAI (Origin Access Identity)

### 概要
CloudFrontの従来のオリジンアクセス制御方式（レガシー）

### 仕組み
- CloudFront専用の「仮想ユーザー」を作成
- S3バケットポリシーでそのOAIからのアクセスのみ許可
- IAMユーザーのような扱いで認証

### 設定方法
S3バケットポリシーに「この OAI からのアクセスのみ許可」を記述

### 制限事項
- CloudFrontとIAMが直結した古い設計
- 署名付きURLやCookieの新機能（Key Groupなど）との組み合わせで制約
- 管理方法が煩雑

---

## OAC (Origin Access Control)

### 概要
2022年リリースの新しいオリジンアクセス制御方式（推奨）

### 仕組み
- 署名付きリクエストによるS3アクセス
- ヘッダー情報を含めた署名でセキュリティ強化
- より柔軟な認証制御

### 利点
- OAIよりも高いセキュリティレベル
- 設定が簡単（マネジメントコンソールから容易に作成）
- 将来的にS3以外（ALB、API Gateway等）でも利用予定

### 設定方法
マネジメントコンソールから「OAC作成」で完了

---

## 比較表

| 項目 | OAI | OAC |
|------|-----|-----|
| **リリース時期** | 従来から提供 | 2022年リリース |
| **推奨度** | 非推奨 | 推奨 |
| **セキュリティ** | 基本レベル | 強化レベル |
| **設定複雑度** | 複雑 | シンプル |
| **署名方式** | IAMユーザー的 | 署名付きリクエスト |
| **新機能対応** | 制約あり | フル対応 |
| **将来対応** | S3のみ | 他サービス拡張予定 |

---

## 選択指針

### OAI
- 既存システムでの継続利用（移行コストを避けたい場合）
- レガシーシステムとの互換性が必要

### OAC
- **新規構築時の標準選択**
- セキュリティ要件が高い場合
- 将来的な機能拡張を見据えた設計

---

## まとめ

### OAI
CloudFront用の従来のユーザー認証的な仕組み（現在は非推奨傾向）

### OAC
新しい標準方式で署名付きアクセスを使用したセキュリティ強化版（今後の推奨）

**新規構築ではOAC一択がベストプラクティス**

---

## 仕組みの流れ

1. ユーザー → CloudFront (アクセス)
2. CloudFront → S3 にリクエスト送信（OAC を使って署名）
3. S3 側は「このリクエストは CloudFront OAC 経由」と判定して許可
4. 直接 S3 へアクセスしたリクエストは拒否される

---

## OAC の利点

- S3 バケットをパブリックにしなくてもよい
- CloudFront 経由アクセスのみ許可できる
- SSE-KMS と統合 → 暗号化キーの制御も可能
- OAI より柔軟・セキュア

---

## ユースケース

- 静的ウェブサイトを S3 + CloudFront で公開したい
- コンテンツを必ず CDN 経由で配信し、S3 直アクセスを防ぎたい
- 監査要件やセキュリティポリシーで「S3 をパブリックにしない」ことが求められる

S3 OAC = CloudFront と S3 の間をセキュアにつなぐ新しい仕組み

---

## OAC を使わない場合

CloudFront のオリジンに S3 バケットを指定するだけでも配信は可能

ただしその場合は、S3 側を以下のどちらかにしておかないといけない：

- バケットをパブリックアクセス許可（危険）
- 署名付きURL / 署名付きCookie を使う（ただし直アクセスを完全には防げない）

つまり「配信自体はできるけどセキュリティ的に甘い」状態になる

---

## 静的ウェブサイト + OAC の考え方

S3 の 静的ウェブサイトホスティング機能をそのまま使う場合は、バケットを パブリック公開する必要がある

でもセキュリティ的には「S3 直アクセスはさせたくない、CloudFront 経由だけで配信したい」というのがベストプラクティス

### CloudFront + OAC を組み合わせると

1. S3 は非公開（パブリックアクセス無効）
2. CloudFront が OAC を使って署名付きリクエストを発行し、S3 からオブジェクト取得
3. ユーザーは必ず CloudFront 経由でアクセス

これにより 静的Webサイトをセキュアにホストできる