# AWS CloudFormation

## CloudFormationの制限

CloudFormationテンプレートを用いて2つのAZにアプリケーションに必要なインフラストラクチャーを自動的にデプロイすることは可能だが、CloudFormationテンプレートだけではアプリケーションのデプロイと管理はできない

## 実際の運用方法

### インフラ
- CloudFormation

### アプリケーションデプロイ
他のサービスを併用する

- CodeDeploy
- Elastic Beanstalk
- CodePipeline + CodeBuild
- ECS/EKS のデプロイ機能

---

## スタック (Stack)

### 概要
CloudFormation でデプロイした一連のAWSリソースの集合

### 構成例
- VPC
- サブネット
- EC2
- RDS
- IAMロール

これらをひとまとめにしたもの

### 作成方法
テンプレート（YAML/JSON）に従って作成される

---

## スタック更新 (Stack Update)

### 概要
既存のスタックに対して、新しいテンプレートやパラメータを適用し、リソースを変更する操作

### 更新例
- EC2のインスタンスタイプを t3.micro → t3.small に変更
- セキュリティグループに新しいルールを追加
- Auto Scalingの設定を変更

### メリット
手動でリソースごとに直すのではなく、CloudFormationスタックを更新することで一括して変更管理できる

### 更新の流れ

1. 新しいテンプレートを準備（または既存テンプレートを修正）
2. CloudFormationで「スタック更新」を実行
3. CloudFormationが差分を確認し、自動的に必要な変更を適用

### 更新方法
- **インプレース更新**: リソースを壊さずに属性変更
- **リソース置換**: 必要なら新しいリソースを作って切り替え

### 注意点

#### リスク
- 更新時にリソース置換（再作成）が必要になる場合がある
- 例: RDSエンジンのメジャーバージョン変更
- サービスダウンやデータ消失リスクがある

#### 対策
変更セット (Change Set) を使用 → 適用前に差分を確認できる

### まとめ

#### 概要
スタック更新 = CloudFormationで既存のリソース構成を修正・変更すること

#### メリット
リソースを個別に操作せず、一括管理・変更できる

#### リスク管理
場合によってはリソース削除/再作成が発生する → 変更セットで検証がベストプラクティス

---

## ドリフト (Drift)

### 概要
CloudFormationのスタックで定義した状態と、実際のAWSリソースの状態がズレてしまうこと

### 発生原因

本来、リソースはCloudFormation経由で管理すべきだが、以下の操作でズレが発生する:

- 管理者がコンソールやCLIで直接リソースを編集した
- 他の自動化ツールがリソースを変更した
- テンプレート外の設定が追加された

こうした操作で「スタックに記録された設定」と「現実のリソース設定」が一致しなくなる

### ドリフトの例

#### 例1: セキュリティグループ
- CloudFormationで作ったセキュリティグループ
- コンソールで直接ルールを追加した

#### 例2: EC2インスタンス
- スタックでは t3.micro のEC2
- 手作業で t3.small に変更した

どちらも「スタックの定義」と「実際のリソース」が食い違っている状態

### ドリフト検出 (Drift Detection)

#### 機能
CloudFormationにはドリフト検出機能がある

#### 実行単位
- スタック単位
- リソース単位

#### 検出結果
- **In Sync**: テンプレート通り
- **Drifted**: ズレている
- **Not Checked / Unknown**: 検証できない

### 重要性

#### IaC一貫性の維持
- IaC（Infrastructure as Code）の一貫性を保つため
- ドリフトがあると「スタック更新時に意図しない削除・再作成」が発生する可能性
- 本番環境でのトラブルの原因になりやすい

### まとめ

#### 定義の整理
- **ドリフト (Drift)**: CloudFormationの定義と実際のリソースの不一致
- **ドリフト検出 (Drift Detection)**: 不一致を検出する仕組み（ツール）

#### ベストプラクティス
Drift Detectionを使って検出・修正する

---

## CloudFormation レジストリ

### 概要
CloudFormationがサポートするリソースタイプやモジュールを一元管理する仕組み

### 標準サポート
CloudFormationが標準で対応しているリソース:
- EC2
- S3
- RDS
- その他の主要リソース

### 拡張機能
- まだ公式でサポートされていないAWSサービス
- 独自のリソース

これらを「カスタムリソースタイプ」としてレジストリに登録して使用可能

### できること

#### AWSリソースタイプの拡張
- まだCloudFormationに標準対応していないリソースを使用可能
- 例: 新しいAWSサービスが出たときに、リソースタイプをレジストリから有効化

#### サードパーティ/独自リソースの追加
- AWS Marketplaceや社内開発チームが作ったカスタムリソースを取り込み
- 例: 会社独自のミドルウェアや監査設定を「リソースタイプ」として登録

#### モジュールやマクロの登録
- 複数リソースをまとめた再利用可能なテンプレート部品（モジュール）を管理
- テンプレートを短くシンプルにできる

### まとめ

#### CloudFormation Registryの役割
- サポートされるリソースタイプを管理するカタログ
- カスタムリソースタイプを登録すればCloudFormationで扱えるようになる

#### 対象リソース
- AWS公式リソース
- サードパーティ製リソース
- ユーザー独自のリソース

#### 定義
CloudFormationが利用できるAWSリソースタイプ、サードパーティ製リソースタイプ、独自定義のカスタムリソースタイプを登録・管理する仕組み