# Route53 フェイルオーバーと DRS の違い

## Route53 フェイルオーバー

- DNS ベースの切替
- ヘルスチェックで「プライマリが死んだらセカンダリへ」
- 使えるが、あくまで名前解決の振り分け
- 実際にサーバーやデータを立ち上げるわけではない

## AWS Elastic Disaster Recovery (DRS)

- サーバー（EC2）やストレージ（EBS/NFS）を実際に AWS 上に起動
- データを継続的にレプリケーションしておき、障害時に即座にリカバリ可能
- フェイルバック機能もあり、オンプレやプライマリリージョンに戻せる

## DRS の動作メカニズム

AWS Elastic Disaster Recovery (DRS) は、ただの「データ同期サービス」ではなく、障害が発生したときにインフラを AWS 上に立ち上げる仕組みである。

### 通常時

1. オンプレ or プライマリリージョンのサーバーにエージェントを入れる
2. DRS がブロックレベルで EBS に継続的にレプリケーション
3. この時点では AWS 側には本物の EC2 はまだ起動していない（コスト節約のため）

### フェイルオーバー発動時

1. レプリカデータから EC2 インスタンスを起動
2. サーバー群、NFS サーバー、ネットワーク構成（VPC, SG, サブネット）までランチテンプレートに従って再現
3. 数分〜十数分で環境が浮かぶ → RTO 20分以内を満たせる

### フェイルバック

プライマリ側が復旧したら、AWS からオンプレ or 元リージョンへデータを戻して再稼働

## 他サービスとの比較

| サービス | 機能 | 制約 |
|----------|------|------|
| **Route53** | トラフィック切替 | EC2やNFSを作らない |
| **EFS + DataSync** | データコピー | サーバーを自動で立てる機能はない |
| **AWS Backup** | バックアップ | RTO/RPO 20分/10分には遅すぎる |

---

## HPC (High Performance Computing)

大量の計算ノードが密に通信しながら並列処理するワークロードである。

### 要件
- 低遅延ネットワーク
- 高帯域幅通信

### AWS 対応
Elastic Fabric Adapter (EFA) を使用すると MPI 通信のような HPC 向けの低遅延通信が可能である。

### AZ 配置の考慮点
- **マルチAZ**: AZ 間通信は必ず VPC インターネット的なルーティングを経由するため、レイテンシが大きくなる
- **単一AZ内**: 内部の高速ネットワークで最小遅延を実現できる

---

## タグポリシー

Organizations レベルでタグのルールを定義できる機能である。

### 概要
- 各アカウントやリソースに「どんなキー・値でタグを付けるべきか」をガイドラインとして配布できる
- 一貫したタグ運用を組織全体に強制する／推奨する仕組み

### 機能

#### タグキーの命名ルール統一
- 例: `Environment` は OK、`Env` や `environment` は NG

#### タグ値の制約
- 例: `Environment = Production | Staging | Dev` のいずれかに限定

#### レポート機能
- 各アカウント・リソースでポリシーに準拠していないタグを可視化できる

### 制限事項
- タグポリシー自体はタグ付けを強制するわけではない
- リソース作成時に「タグがないと作れない」まではできない
- 実際の強制は Service Control Policies (SCP) や IAM ポリシー + Condition: `aws:RequestTag` で実現する

### まとめ
**タグポリシー = ガイドライン + 準拠状況の可視化ツール**

| 仕組み | 特徴 | 効果 |
|--------|------|------|
| **タグポリシー** | ガイドライン・統一ルールの可視化 | 緩め |
| **SCP + Condition** | 実際の強制 | 厳しい |

## SCP によるタグ強制

### 仕組み
- SCP はサービス・アクションを制御するガードレール
- Condition キーを使用することで細かい制御が可能
  - `aws:RequestTag`
  - `aws:TagKeys`

### 実装例

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Deny",
      "Action": "ec2:RunInstances",
      "Resource": "*",
      "Condition": {
        "Null": {
          "aws:RequestTag/Environment": "true"
        }
      }
    }
  ]
}
```

### 動作
1. `Environment` タグを付けないで `RunInstances` を実行すると `Deny` される
2. これを SCP として組織 OU に適用すれば、全アカウントで強制される

### 重要な制約
- SCP 単体では何も許可しない
- IAM ポリシーの許可があって初めて動く
- **SCP の Condition を使うと「タグがないなら強制 Deny」が可能**

### SCP の基本原則

SCP は「許可」を与えられない → あくまで「制限（Deny）」しかできない。

| 使い方 | 可否 | 理由 |
|--------|------|------|
| SCP でリソース作成を許可する | ❌ | SCP は許可しない |
| SCP でタグがない場合は拒否する | ✅ | 正しい使い方 |

### SCP のアタッチ先

- SCP は AWS Organizations の OU または アカウント にアタッチする
- OU にアタッチすると、その OU 配下のすべてのアカウントに継承される
- アカウント直下にアタッチすることも可能