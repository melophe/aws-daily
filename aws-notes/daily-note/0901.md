# AWS学習ノート - 9/01

## Lambda と SQS の連携パターン

### ① Lambda → SQS（Lambda が SQS に書き込む）

#### ユースケース
- **多いケース**: イベント駆動の分散処理

#### 例
- **API Gateway → Lambda → SQS**
  - API リクエストを受けた Lambda がメッセージを SQS に入れて、後続の非同期処理に渡す
- **ETL パイプライン**
  - Lambda が処理結果やジョブをキューに入れる

#### メリット
- 非同期化できる（Lambda は SQS に投げたらすぐ終了して良い）
- バックエンドの処理を後でまとめて並列処理できる

> Lambda → SQS のパターンはかなり多い

### ② SQS → Lambda（SQS がトリガーで Lambda が起動）

#### ユースケース
- **多いケース**: ワーカー的な使い方

#### 例
- SQS に溜まったジョブを Lambda が処理していく
- バッチ処理やメール送信、画像変換などを Lambda に任せる

#### メリット
- Lambda が自動でスケール（SQS のメッセージ数に応じて並列実行）
- バックエンドの処理を完全にイベント駆動にできる

#### 注意点
> 長時間処理や重い処理には向かないので工夫が必要（DLQ, バックオフ, バッチサイズ調整など）

## IAM 権限設定

### 1. Lambda → SQS に書き込む場合

#### 設定対象
- **Lambda 側の実行ロール** にポリシーを付与

#### 必要な権限
- **アクション**: `sqs:SendMessage`
- **リソース**: 対象のキュー ARN

```json
{
  "Effect": "Allow",
  "Action": "sqs:SendMessage",
  "Resource": "arn:aws:sqs:ap-northeast-1:123456789012:MyQueue"
}
```

> Lambda が SQS に書き込むための権限が必要

### 2. SQS → Lambda をトリガーにする場合

#### 設定対象
- **Lambda 側と SQS 側の両方** にポリシーを付与

#### (a) Lambda 実行ロール
Lambda が SQS からメッセージを処理する権限：

```json
{
  "Effect": "Allow",
  "Action": [
    "sqs:ReceiveMessage",
    "sqs:DeleteMessage",
    "sqs:GetQueueAttributes"
  ],
  "Resource": "arn:aws:sqs:ap-northeast-1:123456789012:MyQueue"
}
```

#### (b) SQS リソースポリシー
SQS が Lambda にイベントを送れるようにするため：

```json
{
  "Effect": "Allow",
  "Principal": { "Service": "lambda.amazonaws.com" },
  "Action": "sqs:SendMessage",
  "Resource": "arn:aws:sqs:ap-northeast-1:123456789012:MyQueue"
}
```

> SQS が Lambda をトリガーできるようにする許可が必要

### ✅ 権限設定まとめ

| 連携パターン | 設定内容 |
|-------------|----------|
| **Lambda → SQS** | Lambda の実行ロールに「`sqs:SendMessage`」 |
| **SQS → Lambda** | • Lambda の実行ロールに「`sqs:ReceiveMessage/DeleteMessage/GetQueueAttributes`」<br>• SQS のリソースポリシーに「`lambda.amazonaws.com` を許可」 |

## Lambda IAM ポリシーのベストプラクティス

### 基本原則

**基本的に Lambda を使うときは必ず IAM ポリシー（実行ロール）を付けるべき**

### Lambda のアクセス制御の仕組み

#### 動作原理
- Lambda は IAM ロールで AWS リソースにアクセス
- Lambda 関数自体は「どのリソースにアクセスできるか」を知らない
- 代わりに「実行ロール」を引き受けて、そのロールの権限で動作

#### 権限がない場合
ポリシーが無いと、外部サービスに一切アクセスできない

### 必要な権限の例

| アクセス先 | 必要な権限 |
|-----------|-----------|
| **S3 にファイル書き込み** | `s3:PutObject` |
| **DynamoDB に書き込み** | `dynamodb:PutItem` |
| **SQS に送信** | `sqs:SendMessage` |

> 付けていなければエラーになる

### セキュリティのベストプラクティス

#### 最小権限の原則
- **必ずつけて最小権限**にするのがベストプラクティス
- **危険**: 何も考えずに `AdministratorAccess` をつける
  - Lambda 乗っ取られたら全部のリソース操作される
- **正解**: 本当に必要なアクションだけ許可

### 推奨設定

#### 基本設定
- **最低限**: `AWSLambdaBasicExecutionRole` は付ける
- **追加**: 他の AWS リソースにアクセスするなら、その都度必要最小限のポリシーを追加

> **Lambda を使うときは必ず実行ロールを設定すべき**