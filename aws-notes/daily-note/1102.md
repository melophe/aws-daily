# Field-Level Encryption

CloudFront がリクエスト内の特定フィールドだけを公開鍵で暗号化し、そのデータはアプリ内の特定マイクロサービスだけが秘密鍵で復号できるようにする機能。

## TLSとの違い

普通の HTTPS（TLS）は、通信経路全体を暗号化する。しかし実際は、CloudFront や ALB、WAF、ログ収集などの中間層では平文が見えてしまう。

TLS は「経路の安全」は守るが、「データ内容」までは守らない。

## Field-Level Encryptionの仕組み

CloudFront が HTTP リクエスト内の"特定フィールド"だけを暗号化して、バックエンドに渡す前に機密情報を保護する仕組み。

### 例

```json
{
  "name": "Alice",
  "email": "alice@example.com",
  "creditCardNumber": "4111111111111111"
}
```

この中で `creditCardNumber` だけ暗号化したい場合、CloudFront に「Field-Level Encryption」を設定する。

### 処理フロー

1. クライアント → CloudFront: クライアントがHTTP POSTなどでデータを送信
2. CloudFrontがその中の「指定されたフィールド」（例：creditCardNumber）を検出
3. そのフィールドだけを公開鍵で暗号化
4. 暗号化されたデータをバックエンド（ALB/ECSなど）に転送

## 役割の違い

| 技術 | 役割 |
|---|---|
| TLS | 外部からの盗聴・改ざんを防ぐ |
| FLE | 内部（AWS内部サービス・中間層）での平文露出を防ぐ |

## TLS復号の仕組み

TLS（HTTPS）は「通信経路を暗号化」するプロトコル。つまり、ネットワークの途中で誰かがパケットを盗み見ても、暗号化されているから中身が読めないようにする。

TLS暗号化は"端点（End point）で復号される"仕組み：

```
[Client Browser]
    │ HTTPS通信（暗号化中）
    ▼
[CloudFront] ←ここでTLS復号（＝平文になる）
    │ HTTPS通信（再び暗号化）
    ▼
[ALB] ←ここでも復号（＝平文になる）
    │ HTTPS通信（再暗号化）
    ▼
[ECSアプリ] ←ここでやっと処理
```

TLSは「1回復号して、次に進む前に再暗号化する」という動きを繰り返す。これを「TLS termination（終端）」と呼ぶ。

### 各段階での処理

1. CloudFront が復号して、HTTPリクエスト内容を確認（キャッシュキー判定やWAFチェック、ヘッダー操作などのため）
2. 次に ALB に転送するときに、またTLSで暗号化
3. ALB でも再び復号してターゲット振り分け

**問題点:** CloudFrontやALBの内部メモリ・ログ・監視ツールでは、データは「平文」で扱われている。

## Field-Level Encryption（FLE）の利点

FLEを設定すると：

- CloudFrontがリクエストの特定フィールドだけ公開鍵で暗号化
- それ以降（CloudFront / ALB / ECSの一部）は誰も復号できない
- 最後のマイクロサービスだけが秘密鍵で復号可能

### まとめ

- **TLS**: 通信を守るが、各中間層（CloudFront・ALB）で一度復号されて平文になる
- **Field-Level Encryption（FLE）**: その平文露出すら防ぐ。データの特定フィールドは最後のECSマイクロサービスでしか復号できない

## ALBでの復号

ALB（Application Load Balancer）では、FLEの復号はできない。FLEの仕組み上、「CloudFrontが暗号化 → アプリ（ECSなど）が復号」という設計になっていて、ALBは単なる"暗号文の通過点"となる。

### なぜALBで復号できないのか

復号には「秘密鍵」が必要。

FLE の暗号化は公開鍵暗号方式（RSA）。暗号化したデータを復号するには、対応する秘密鍵が必要。

この秘密鍵はセキュリティ上、CloudFrontやALBには渡さない。復号できるのは秘密鍵を保持しているアプリケーション層（ECS, EC2など）だけ。

ALB は「L7ロードバランサー」であって「アプリケーション実行環境」ではない。

---

# DNS名の役割

DNS名は「IPを抽象化」して運用を楽にするためにある。

---

# VPCとセキュリティグループ

| 項目 | 役割 | 説明 |
|---|---|---|
| VPC | SGの「所属先」 | どのネットワーク内のSGかを決める（他のVPCでは使えない） |
| EC2（ENI） | SGの「アタッチ先」 | 通信の入口（受信・送信）を制御する実体 |

---

# なぜ実務ではサブネットを複数作るのか

## ① ネットワークの役割分離（セキュリティゾーンの分割）

実務では「どのリソースが外部と通信するか」を明確に分ける。

| サブネットの種類 | 典型的な用途 | インターネットアクセス |
|---|---|---|
| Public Subnet | ALB, Bastion Host, NAT Gateway | あり（IGW接続） |
| Private Subnet | EC2 Appサーバー, DBサーバー | なし（NAT経由のみ） |
| Isolated Subnet | RDS, Elasticache など | 完全に閉じた内部通信のみ |

## ② 高可用性（AZ分散）

AWSはアベイラビリティゾーン（AZ）ごとに独立したデータセンターを持つ。1つのAZが障害を起こしても、他AZで動作を継続する構成をとるのが実務の基本。

```
VPC (10.0.0.0/16)
├── Public Subnet 1a (10.0.1.0/24)
├── Public Subnet 1c (10.0.2.0/24)
├── Private Subnet 1a (10.0.3.0/24)
└── Private Subnet 1c (10.0.4.0/24)
```

1aと1cにEC2を分散配置（Auto ScalingやALBが両方使う）。

## ③ ネットワーク構成の柔軟性

システムが大きくなると、サブネット単位でルートテーブルやNACL（ネットワークACL）を分けて制御したくなる。

**例:**

- 管理者用サブネット（VPN接続）
- バッチ処理用サブネット
- VPC Peering専用サブネット
- 監視システム用サブネット

ネットワーク単位でポリシーを変えやすくするのが目的。
