# Message Queue (MQ)

## 概要

Message Queue（メッセージキュー）の略

- システム間で「メッセージ（データや処理依頼）」を一時的にためて、順番に配送する仕組み
- 特に「送る側と受け取る側を疎結合にする」ために使われる

---

## 代表的な実装

### RabbitMQ
- オープンソースのメッセージブローカー
- MQTT, AMQP など複数プロトコル対応

### ActiveMQ
- Apache が開発している MQ サーバー
- JMS (Java Message Service) をよく使う

### Amazon MQ
- AWS が提供する「RabbitMQ と ActiveMQ のマネージド版」
- 自分でサーバー構築・運用不要で、HA構成やスケーリングもやってくれる

---

## 基本的な動作

1. **キューイング**: 「キュー」にメッセージを入れる
2. **処理**: 受け取る側（コンシューマー）が順番に処理
3. **耐障害性**: 途中でサーバーが落ちても、キューに残っていれば復旧後に処理できる

### 利用目的
システム障害時のデータ損失を防ぐために MQ がよく使われる

---

## SQS と MQ の違い

### Amazon SQS
- シンプルなメッセージキュー（Queue モデルのみ）
- HTTP/HTTPS ベースの API
- 完全マネージド・無限にスケール
- 「送信者 → キュー → 受信者」の非同期通信に最適
- MQTT を直接話せない

### Amazon MQ
- RabbitMQ / ActiveMQ のマネージド版
- 既存システムが AMQP, STOMP, MQTT などの標準プロトコルを使っているときに便利
- 移行が簡単（オンプレ MQ → Amazon MQ）
- ただし SQS ほどスケーラブルではない

---

## MQTT プロトコル

### 概要
- **フルネーム**: Message Queuing Telemetry Transport
- IoT向けに設計された通信プロトコル
- 「軽量で省電力・低帯域でも使える」ことを目的に作られた

### 特徴

#### 軽量
- ヘッダーがすごく小さい → センサーのような低性能デバイスでもOK

#### パブリッシュ / サブスクライブ（Pub/Sub）モデル
- 送信側（Publisher）が「トピック」にデータを送る
- 受信側（Subscriber）はその「トピック」を購読して受け取る
- 送受信が疎結合になる

#### 接続の柔軟性
- 常時接続ではなくてもOK
- 途切れても再接続すればキューから受信可能

---

## IoT Core とプロトコルの関係

**AWS IoT Core は「MQTTをしゃべれるマネージドブローカー」**

### サポートプロトコル
- MQTT 3.1.1 / MQTT 5.0 をサポート
- WebSockets over MQTT も対応
- HTTP, LoRaWAN といった他のプロトコルも一部サポート（メインは MQTT）

### 接続方法
- デバイス（センサー）が MQTT を使って IoT Core に接続できる

---

## IoT Core だけで完結できる理由

### MQTT ネイティブ対応
- IoT Core が直接 MQTT を受け取れる（センサーがそのまま接続可能）

### ルールエンジンで連携
IoT Core のルールを設定すれば、受信データを自動的に以下に連携可能:
- S3 に保存
- Kinesis にストリーム
- SQS に送信
- Lambda に渡して加工

### 高可用性 & スケーラブル
- IoT Core はフルマネージドサービス → RabbitMQ のようにクラスタ運用不要

---

## Amazon MQ が必要になるケース

### 既存システムの移行
- 既存アプリケーションが RabbitMQ/ActiveMQ プロトコルを前提にしている場合
- 例: AMQP/STOMP/JMS を使ったアプリを AWS に移行したいとき

### 高度なキュー管理
- IoT Core のルールエンジンではできない高度なキュー管理をしたいとき

### 結論
「ただ MQTT を受けて S3 に流す」なら IoT Core がベスト