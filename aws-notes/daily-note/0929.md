# Message Queue (MQ)

## 概要

Message Queue（メッセージキュー）の略

- システム間で「メッセージ（データや処理依頼）」を一時的にためて、順番に配送する仕組み
- 特に「送る側と受け取る側を疎結合にする」ために使われる

---

## 代表的な実装

### RabbitMQ
- オープンソースのメッセージブローカー
- MQTT, AMQP など複数プロトコル対応

### ActiveMQ
- Apache が開発している MQ サーバー
- JMS (Java Message Service) をよく使う

### Amazon MQ
- AWS が提供する「RabbitMQ と ActiveMQ のマネージド版」
- 自分でサーバー構築・運用不要で、HA構成やスケーリングもやってくれる

---

## 基本的な動作

1. **キューイング**: 「キュー」にメッセージを入れる
2. **処理**: 受け取る側（コンシューマー）が順番に処理
3. **耐障害性**: 途中でサーバーが落ちても、キューに残っていれば復旧後に処理できる

### 利用目的
システム障害時のデータ損失を防ぐために MQ がよく使われる。

---

## SQS と MQ の違い

### Amazon SQS
- シンプルなメッセージキュー（Queue モデルのみ）
- HTTP/HTTPS ベースの API
- 完全マネージド・無限にスケール
- 「送信者 → キュー → 受信者」の非同期通信に最適
- MQTT を直接話せない

### Amazon MQ
- RabbitMQ / ActiveMQ のマネージド版
- 既存システムが AMQP, STOMP, MQTT などの標準プロトコルを使っているときに便利
- 移行が簡単（オンプレ MQ → Amazon MQ）
- ただし SQS ほどスケーラブルではない

---

## MQTT プロトコル

### 概要
- **フルネーム**: Message Queuing Telemetry Transport
- IoT向けに設計された通信プロトコル
- 「軽量で省電力・低帯域でも使える」ことを目的に作られた

### 特徴

#### 軽量
- ヘッダーがすごく小さい → センサーのような低性能デバイスでもOK

#### パブリッシュ / サブスクライブ（Pub/Sub）モデル
- 送信側（Publisher）が「トピック」にデータを送る
- 受信側（Subscriber）はその「トピック」を購読して受け取る
- 送受信が疎結合になる

#### 接続の柔軟性
- 常時接続ではなくてもOK
- 途切れても再接続すればキューから受信可能

---

## IoT Core とプロトコルの関係

**AWS IoT Core は「MQTTをしゃべれるマネージドブローカー」**

### サポートプロトコル
- MQTT 3.1.1 / MQTT 5.0 をサポート
- WebSockets over MQTT も対応
- HTTP, LoRaWAN といった他のプロトコルも一部サポート（メインは MQTT）

### 接続方法
- デバイス（センサー）が MQTT を使って IoT Core に接続できる

---

## IoT Core だけで完結できる理由

### MQTT ネイティブ対応
- IoT Core が直接 MQTT を受け取れる（センサーがそのまま接続可能）

### ルールエンジンで連携
IoT Core のルールを設定すれば、受信データを自動的に以下に連携可能:
- S3 に保存
- Kinesis にストリーム
- SQS に送信
- Lambda に渡して加工

### 高可用性 & スケーラブル
- IoT Core はフルマネージドサービス → RabbitMQ のようにクラスタ運用不要

---

## Amazon MQ が必要になるケース

### 既存システムの移行
- 既存アプリケーションが RabbitMQ/ActiveMQ プロトコルを前提にしている場合
- 例: AMQP/STOMP/JMS を使ったアプリを AWS に移行したいとき

### 高度なキュー管理
- IoT Core のルールエンジンではできない高度なキュー管理をしたいとき

### 結論
「ただ MQTT を受けて S3 に流す」なら IoT Core がベストである。

---

## Storage Gateway の3つのモード

### ファイルゲートウェイ (File Gateway)

- NFS / SMB でアクセス可能
- 裏では S3 バケットに保存
- よく使うデータはオンプレキャッシュに保持
- 「S3 をNASっぽく見せる」

### ボリュームゲートウェイ (Volume Gateway)

- iSCSI ブロックストレージとして見える
- 2つのモードがある：
  - **キャッシュ型**：S3 がプライマリ、オンプレにキャッシュ
  - **ストア型**：オンプレがプライマリ、S3 に非同期バックアップ
- 「オンプレにローカルディスクがあるように見えるけど、実態はクラウド」

### テープゲートウェイ (Tape Gateway)

- 物理テープライブラリの代わり
- バックアップアプリからは「仮想テープライブラリ」に見える
- 実際は S3 や S3 Glacier に保存
- 「レガシーなテープ運用をクラウドで代替」

---

## iSCSI とは

Internet Small Computer System Interface の略

- ストレージをネットワーク越しにローカルディスクのように見せるプロトコル
- TCP/IP の上で動作するので、普通のLANやWANでも利用可能

### ブロックストレージとは

「ファイル」単位ではなく、「ブロック（ディスクのセクタ単位）」で読み書きできるストレージ

**例：**
- EBS（EC2のディスク）
- オンプレ SAN(Storage Area Network)

OSからは「普通のディスク（/dev/sda とか C: ドライブ）」に見える

### iSCSI ブロックストレージの特徴

- ネットワーク経由だけど、アプリやOSからはローカルディスクにしか見えない
- だからデータベースやVMのディスクとして使える
- 企業のオンプレ環境では SAN の代替や拡張によく使われる

### AWS との関係

- ボリュームゲートウェイが iSCSI をしゃべる
- オンプレサーバーは「iSCSIディスクをマウント」して普通のHDDのように使える
- 実際のデータは S3 に保存 or キャッシュ

つまり「オンプレに見えるけど、裏はクラウド」の仕組みである。

---

## ファイルゲートウェイ vs ボリュームゲートウェイ

### ファイルゲートウェイ

- **提供形態**：NFS / SMB 共有
- **見え方**：アプリやユーザーからは「共有フォルダ（ファイル単位アクセス）」
- **保存先**：裏側は S3 オブジェクトストレージ
- **ユースケース**：ファイルサーバーの置き換え、S3 バックアップ

「ファイル単位のストレージ」

### ボリュームゲートウェイ

- **提供形態**：iSCSI ブロックデバイス
- **見え方**：OS からは「ローカルディスク（ブロック単位アクセス）」
- **保存先**：S3（キャッシュ型 or ストア型）
- **ユースケース**：データベースや VM のディスク拡張、オンプレのバックアップ

「ブロック単位のストレージ」

**まとめ：**
- ファイルゲートウェイ = ファイルストレージ (NFS/SMB)
- ボリュームゲートウェイ = ブロックストレージ (iSCSI)

## ローカルディスクとブロックの関係

PCやサーバーがHDD/SSDにアクセスするとき：
- ファイル単位ではなく、内部的には「ブロック単位」で読み書きする
- つまり、ローカルディスクはブロックストレージそのものである

---

## バックアップ方式の違い

### ファイルゲートウェイ
ファイル単位のバックアップ（S3 に保存 → Glacier にアーカイブ）

### ボリュームゲートウェイ
ディスク単位のバックアップ（EBS スナップショット化 → 復元も簡単）

---

## データ保存方式の違い

### ファイルゲートウェイと S3 の関係

- ファイルを書き込むと、そのまま S3 オブジェクトとして保存される
- 「ファイル名 = オブジェクトキー」になる
- だから S3 を直接見に行ってもファイルがそのまま置いてあるイメージ

### ボリュームゲートウェイと S3 の関係

- iSCSI 経由でブロックデバイスを提供

- 書き込んだデータは裏で S3 にブロック単位で保存

- さらに EBS スナップショットとしてバックアップできる

- ただし S3 上では「オブジェクトとして直接ファイルが見えるわけではない」

 - S3 はあくまで「裏の保存場所」で、ユーザーはそれを意識しない

### まとめ

ボリュームゲートウェイも S3 を使っているが、「直接 S3 を操作する」のはファイルゲートウェイだけである。

---

## AWS Backup のバックアップ頻度

### 基本制限
- **最小**: 1日1回（日次バックアップ）
- 柔軟に指定できるのは開始時間と保持期間
- **例**: 毎日 2:00 に実行、毎週日曜だけ週次バックアップ、毎年1月1日に年次バックアップ
- **高頻度**: 「1時間ごと」「5分ごと」といった高頻度は不可

### より高頻度なバックアップが必要な場合

#### EBS
Amazon Data Lifecycle Manager (DLM) で 1時間ごとの自動スナップショット

#### RDS
リードレプリカ or マルチAZ レプリケーション (RPOが数秒〜分)

#### EFS
EFS Replication (数分遅延)

#### オンプレサーバー
Elastic Disaster Recovery (RPO数秒〜分)

---

## 医療メーカー用バックアッププランの例

### ルール1（日次バックアップ）
- **スケジュール**: 毎日 2:00 UTC
- **保持期間**: 30日

### ルール2（週次バックアップ）
- **スケジュール**: 毎週日曜 3:00 UTC
- **保持期間**: 3か月

### ルール3（年次バックアップ）
- **スケジュール**: 毎年1月1日
- **保持期間**: 7年

### 共通設定
- すべてクロスリージョンコピー & KMS 暗号化

**ポイント**: こうすると「日次・週次・年次要件」を1つのプランで自動的に満たせる。

### クロスリージョンコピーの仕組み

- バックアップルールに「コピー先リージョン」を追加できる
- バックアップ作成後すぐにコピー処理が走る
- コピー先でも独立した保持期間を設定可能
- コピー時に別の KMSキー で暗号化し直すことも可能

#### 医療メーカーの例
- **プライマリ**: 東京リージョン（ap-northeast-1）でバックアップ作成
- **コピー**: 大阪リージョン（ap-northeast-3）へコピー
- **保持期間**: 東京30日、大阪90日
- **暗号化**: 両方で HIPAA 要件の暗号化を満たす（KMSキー必須）

**効果**: RPO（日次バックアップ）+ DR要件（別リージョン保管） を同時に実現