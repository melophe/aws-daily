# VPC DNSホスト名オプション

VPC内のインスタンスがDNSホスト名を取得できるようにするための設定:

## 必要な設定
- enableDnsSupport属性: "true"
- enableDnsHostnames属性: "true"

---

# BYOIP (Bring Your Own IP)

## 概要
オンプレで使っていた固定IPをAWSでも引き続き使いたい場合に使用するIPアドレスの持ち込み機能

## ROA (Route Origin Authorization)とBYOIPの関係

### ROAの役割
AWSに「このIPプレフィックスは自分のもの」と証明するための仕組み

### BYOIPでのROA使用
- BYOIPを使うときは必ずRPKI（Resource Public Key Infrastructure）に基づくROAを作成
- インターネットのルーティングで「このIPアドレスはこのAS（AWS）が正当に広告している」と証明可能

### ROAの正体
- ROAはAWSのサービスではなく、インターネットの標準仕組み（RPKIの一部）
- AWSが提供しているのではなく、IPアドレスを管理している機関（RIR: Regional Internet Registry）で作成

---

# Redshift COPY/UNLOADコマンド

## 機能概要
- **COPY**: S3 → Redshiftへのデータロード
- **UNLOAD**: Redshift → S3へのデータエクスポート

どちらも Redshiftクラスター ⇔ S3 間で通信が発生する

## VPC Flow Logs

### 機能
VPC/Subnet/ENI単位でIPレベルの通信メタデータを記録

### 取得可能な情報
- ソース/宛先IP
- ポート
- プロトコル
- 許可/拒否
- バイト数

### 取得不可能な情報
アプリケーションレベルの操作名（COPYやUNLOADなど）

## 拡張VPCルーティング (Enhanced VPC Routing)

### 機能
有効化すると、Redshift ⇔ S3間のCOPY/UNLOAD通信が必ずVPC内を経由する

### 通信経路
RedshiftクラスターのENI → S3 VPCエンドポイント or IGW

### メリット
VPC Flow Logs / VPC Endpoint Logsでトラフィック監視が可能になる

### 重要なポイント
- Flow Logsだけ有効化しても不十分（通信がVPC外ならログに出ない）
- Enhanced VPC Routingを有効化 → COPY/UNLOAD通信がVPC内を経由 → Flow Logsで監視可能

---

# ASGとAZの関係

## 基本動作
- ASG作成時に「利用するサブネット」を指定
- そのサブネットが属するAZにインスタンスが配置される
- ASGは指定した複数サブネットに、できるだけ均等にインスタンスを分散する

## 具体例1

### 設定例
- VPCに3つのサブネットを作成: ap-northeast-1a, 1c, 1d
- ASGで「1a, 1c」を選択

### 結果
起動するインスタンスは1aと1cに分散配置される

## 制限事項
- 「次のインスタンスは絶対にap-northeast-1aに置きたい」みたいな細かい制御は不可
- AWSが自動的に分散する


---

## 具体例2: ALBと組み合わせたマルチAZ構成

### VPC設定
- 東京リージョン（ap-northeast-1）にVPC作成
- VPC CIDR: 10.0.0.0/16

### サブネット構成
複数AZに分けてサブネット作成:
- 10.0.1.0/24 → ap-northeast-1a
- 10.0.2.0/24 → ap-northeast-1c
- 10.0.3.0/24 → ap-northeast-1d

（AWSアカウントによって利用できるAZ名は少し違う場合あり）

### ASG設定と結果
- ASGに上のサブネットを指定
- Auto ScalingがEC2を1a, 1c, 1dに自動分散して配置
- それぞれのインスタンスがALBのターゲットグループに自動登録される

### ALBの制限
ALBは単一のVPC内での使用が求められる

---

# AWSマルチキャスト

## VPCの制限
AWS上でマルチキャストを使うのは特殊な要件で、通常のVPCではマルチキャストはサポートされていない

### VPCサポート範囲
- **サポート**: ユニキャスト、ブロードキャスト
- **サポート外**: マルチキャスト

## 解決方法
AWS Transit Gatewayのマルチキャスト機能を利用する

### Transit Gatewayの役割
VPCやオンプレ環境を接続するハブ

---

# Customer Gateway (CGW)

## 概要
オンプレミス側のVPN装置をAWS上で表すリソース

## 使用目的
AWSとオンプレのSite-to-Site VPN接続を作るときに必要

## 接続構成
- **オンプレ側のVPN窓口**: CGWをAWSに登録
- **AWS側のVPN窓口**: VGW（Virtual Private Gateway）やTransit Gatewayと接続

## オンプレ環境の実際の機器
### 対象機器
- Ciscoルーター
- Fortigateなどのファイアウォール
- StrongSwanみたいなソフトウェアVPN

これらをAWS上では「Customer Gatewayリソース」として登録して扱う

## AWS側の対応リソース

### Virtual Private Gateway (VGW)
VPCにアタッチして、VPNのAWS側の入り口

### Transit Gateway (TGW)
複数VPCやオンプレをまとめて接続できるハブ

## 接続構成
CGW（オンプレ） ↔ VGW/TGW（AWS）でSite-to-Site VPNが張られる

## Site-to-Site VPNの場合

### オンプレ側: Customer Gateway (CGW)
- オンプレにあるルーター/ファイアウォール
- AWSに「Customer Gatewayリソース」として登録（パブリックIP必須）

### AWS側: Virtual Private Gateway (VGW) または Transit Gateway (TGW)

### 接続方式
CGW ↔ VGW/TGW でIPsec VPNトンネルを構築

---

## Direct Connectの場合

### オンプレ側: ルーター（DXルーター）
物理的にはオンプレ側の装置だが、AWSでは「CGWリソース」とは呼ばない

### AWS側: Direct Connectロケーション（DXルーター, AWS側のインフラ）

### 接続方式
プライベート仮想インターフェイス (VIF) 経由でVPCと接続

### ハイブリッド冗長化
「Direct Connect + VPNを組み合わせてハイブリッド冗長化する（DX + VPN over CGW）」ケースでは、CGWも一緒に使う

## まとめ

### CGWの役割
- オンプレ側のVPN装置を表すリソース
- AWSに登録するのはVPN接続のときだけ

### 使い分け
- **Direct Connect単体**: CGWは不要
- **DXとVPNの組み合わせ**: CGWも使用

# AWS Storage Gateway モード

## File Gateway
- オンプレからSMB/NFSでアクセス
- 実体はS3に保存される
- アプリからは普通のファイルサーバに見える
- 移行ではなく「S3を裏で使うファイル共有」

## Volume Gateway
- iSCSIデバイスとして利用可能
- バックアップやDRに使える（スナップショットはEBS互換）

## Tape Gateway
- 物理テープを仮想化してS3 Glacierに保存
- 既存のバックアップソフトに「テープ装置」として見せる

---

# AWS データ移行サービス比較

## DataSync

### 適用ケース
- オンライン転送（ネットワーク経由）で移行したい
- 数十TB〜数百TB程度のデータ量（回線が太ければもっといける）
- 継続的な差分同期や自動スケジュールも使いたい

### 対応プロトコル
SMB / NFS / HDFS / S3 / EFS / FSx

### 特徴
- 転送中は圧縮＋暗号化
- 差分転送OK（初回フルコピー＋以後は更新分だけ）
- VPCやオンプレにエージェントをデプロイして利用

## Snowball Edge / Snowmobile

### 適用ケース
- ネットワーク帯域がボトルネックで、オンラインでは現実的に移行できない
- 100TB〜数PB超のデータ量
- 移行先がS3（Snowballデバイスは基本S3エンドポイント扱い）
- Snowmobileはエクサバイト級（データセンター丸ごと移行みたいな超巨大案件）

### 特徴
- 物理デバイス（Snowball Edge: 80TB〜210TB/台）をAWSから配送
- データをローカルでコピー → 送り返すとAWSに取り込まれる
- オフライン転送なので回線品質に依存しない

---

## 使い分け基準

### 判断フロー

#### 回線で間に合うか？
- **Yes** → DataSync
- **No** → Snowball

#### データ量は？
- 数十〜数百TB（ネットで可能） → DataSync
- 100TB〜PB級でネットじゃ無理 → Snowball Edge
- 数十PB〜EB級 → Snowmobile

### 覚え方
- 「ネットで転送できるならDataSync、ネットじゃ無理ならSnowball」
- 「100TB超えて帯域不足ならSnowball Edge、それ以上ならSnowmobile」