# AWS 各サービスのモニタリングとインスタンスタイプ

## RDS モニタリング機能

### CloudWatch 基本モニタリング

#### 粒度
5分間隔（有料オプションで1分間隔）

#### 取得可能なメトリクス
- CPU使用率
- DB接続数
- ストレージ使用量
- 読み取り/書き込みIOPS

#### 特徴
- 無料で標準提供
- 基本的なリソース利用状況を把握

#### 制限事項
- メモリやプロセス単位の詳細情報は取得不可

### 拡張モニタリング (Enhanced Monitoring)

#### 粒度
1秒〜1分間隔

#### 取得可能なメトリクス
- CPU使用率（コア単位）
- メモリ利用状況（空き、キャッシュ、スワップ）
- ディスクI/Oの詳細（レイテンシ・スループット）
- プロセス単位のリソース使用状況

#### 特徴
- OSレベルの詳細情報を取得（EC2のtopやiostat相当）
- データはCloudWatch Logsに送信

#### 制限事項
- CloudWatch Logsの利用料が発生

#### 利用場面
CPUやメモリをどのプロセス・スレッドが使用しているかを特定したい場合

### Performance Insights

#### 粒度
秒〜分レベル

#### 取得可能なメトリクス
- DB負荷（AAS: Average Active Sessions）
- 上位SQLステートメント
- 待機イベント（ロック待ち、I/O待ち等）

#### 特徴
- SQLレベルでボトルネックとなるクエリを特定可能
- 7日分の履歴は無料、最大24か月まで保存可能（有料）

#### 制限事項
- OSレベルのCPU/メモリ使用状況は把握不可

#### 利用場面
どのSQLがリソースを消費しているかを特定したい場合

---

## モニタリング機能比較表

| 用途 | 推奨機能 |
|------|----------|
| 基本的な監視 | CloudWatch 基本モニタリング |
| プロセス/スレッド単位のリソース分析 | 拡張モニタリング |
| SQL ボトルネック特定 | Performance Insights |

---

## RDS 関連

### インスタンスタイプ
CPUやメモリなど、インスタンスの性能を決定する要素

### ストレージタイプ
データの保存方式（Aurora スタンダード / I/O最適化、EBS SSD/HDD等）

### モニタリング機能の選択指針
- 拡張モニタリング：OSレベルの詳細なメトリクス（CPUプロセス、スレッド、メモリ利用状況）
- Performance Insights：SQLボトルネック分析
- CloudWatch標準モニタリング：基本的なCPUやメモリメトリクス

RDSでは「拡張モニタリング」と「Performance Insights」を使い分ける

---

## EC2 関連

### インスタンスタイプ
性能（vCPU、メモリ）を決定する要素

### ストレージタイプ
EBS（SSD/HDD）を選択

### モニタリング
- 標準モニタリング：5分粒度
- 詳細モニタリング：1分粒度（課金対象）
- CloudWatchエージェント：より詳細なメトリクス（プロセス/メモリ使用状況など）

注意点：
- 詳細モニタリング = 粒度を細かくするのみ
- 情報を増やすにはCloudWatchエージェントが必要

---

## API Gateway 関連

### キャッシュ
- API Gatewayがレスポンスをキャッシュし、同一リクエストではバックエンドを呼ばず即座にレスポンス
- TTL（有効期限）設定可能（0〜3600秒）
- 静的・変更頻度の低いデータに有効（ユーザー名、マスターデータ等）
- 頻繁に変わるデータ（日付・残高等）には不適切

### スロットリング

#### サーバー側スロットリング
API全体のリクエスト数を制限してバックエンド保護

#### クライアント側スロットリング（使用量プラン）
APIキーごとに以下を設定：
- Rate（毎秒リクエスト数）
- Burst（瞬間的リクエスト数）
- Quota（期間あたりの総リクエスト数）

### 使用量プラン (Usage Plan)
APIキーを使用してクライアント毎のアクセス制御が可能
「このクライアントは毎秒○回まで」「月○万リクエストまで」といった制御

### WAF
- API GatewayにWAFを設定することで、SQLインジェクションやXSS、IP制限等を入口で防御
- POSTのリクエストボディも検査可能
- API Gatewayが最初の入口となるため、WAF設置ポイントとして有効

### ステージ
- APIのバージョンや環境を分離（dev, stg, prod等）
- ステージごとにスロットリングやキャッシュ設定を個別に変更可能

---

## CloudFront アクセス制御

### 署名付きURL
CloudFrontが発行する一時的に有効な特別なURLを使用してアクセス制御

#### URL形式

##### 通常のURL
```
https://daaaaaa.cloudfront.net/video/movie.mp4
```

##### 署名付きURL
```
https://daaaaaaa.cloudfront.net/video/movie.mp4?Expires=1699999999&Signature=xxxxxx&Key-Pair-Id=APKA123456789
```

クエリパラメータが追加されるためURLが変更される

### 署名付きCookie
CloudFrontに認証済みクライアントであることを示すCookieを送信

#### 特徴
- Cookieが有効な間は通常のURL（/video/movie.mp4）を変更せずにアクセス可能
- 複数のオブジェクトに一度に適用可能（URLを個別変更不要）

### アクセス制御比較

| 方式 | URL変更 | 適用範囲 |
|------|---------|----------|
| 署名付きURL | あり（クエリ付き一時URL） | 単一オブジェクト |
| 署名付きCookie | なし（元URL維持） | 複数オブジェクト |

---

## Auto Scaling メトリクス

### ApproximateNumberOfMessages

#### 概要
Amazon SQSのメトリクス

#### 機能
- キューに蓄積されているメッセージ数を表示
- 正確な数値ではなく近似値（approximate）

### Auto Scaling ポリシー

#### 通常のターゲット追跡ポリシー
基本的にはEC2のCPU使用率を指標として使用

例：CPU使用率を50%に維持するようにスケール

#### SQSメトリクスを指標にする場合
CPUではなくSQSメトリクス（ApproximateNumberOfMessages）をターゲットに設定

##### 設定例
「1インスタンスあたり5メッセージを処理できるようにスケール」

##### 計算方法
CloudWatchメトリクスで `ApproximateNumberOfMessages / インスタンス数` を算出

##### 結果
SQSの蓄積状況に応じてEC2台数が自動調整される

---

## 各サービスのポイント

### RDS
拡張モニタリングでOSレベル、Performance InsightsでSQLレベルの監視

### EC2
詳細モニタリングは粒度向上のみ、詳細情報取得にはCloudWatchエージェント

### API Gateway
- キャッシュ：同一リクエストのレスポンス保持
- スロットリング：トラフィック制御（全体またはクライアント単位）
- 使用量プラン：APIキー単位での制限設定
- WAF：入口でリクエスト内容検査
- ステージ：環境ごとの設定切り替え

### CloudFront
- 署名付きURL：個別オブジェクトの一時的アクセス制御
- 署名付きCookie：複数オブジェクトのアクセス制御

### Auto Scaling
- 標準：CPU使用率ベース
- SQS連携：メッセージ蓄積量ベースでのスケール制御

---

## S3 Transfer Acceleration

### 概要
S3バケットに対するアップロード/ダウンロードを高速化する機能

### 仕組み
CloudFrontの エッジロケーション を経由してS3に届ける仕組み

### 効果
遠隔地からS3へ直接アップロードするより高速化

### ユースケース
- 世界中のユーザーがアップロードするアプリ
- 例：海外支社から日本リージョンのS3へアップロード
- データ移行というより日常的にグローバルからS3にアクセスするアプリに有効

---

## 署名付きURL（Presigned URL）の使い方

### 2つの主要な使用パターン

#### 1. 特別アクセス用（ダウンロード系）
- 管理者やアプリがこのユーザーだけに一時的にオブジェクトを見せたい時に発行
- 例：有料会員だけ動画をダウンロード可能
- URLは有効期限つきで、時間が切れたらアクセス不可
- 特別にアクセスさせるための使い方

#### 2. 安全にアップロードさせる用（アップロード系）
- ユーザーにS3へ直接アップロードさせたい時に発行
- 例：写真投稿アプリ、動画アップロードサービス
- 署名付きURLを発行してユーザーに渡すと、EC2を経由せずに直接S3にアップロード可能
- アップロード可能なオブジェクト名やサイズ、期限も制御可能
- スケーラブルに処理するための使い方

### 共通点
- どちらもS3バケットのポリシーを直接公開しないで済む
- 有効期限つきなのでセキュリティ的にも安心
- 管理者が権限を委譲する一時的な方法

---

## VPCエンドポイント構成要素の関係性

### VPCエンドポイントサービス

#### 概要
提供側が作成するもの

#### 機能
自分のサービス（通常NLB配下）をPrivateLinkで公開する宣言

### Interface型VPCエンドポイント

#### 概要
利用側が作成するもの

#### 機能
提供されたVPCエンドポイントサービスに接続するドア

ENIが作成され、そこから提供側のサービスへプライベートに接続

### Gateway型VPCエンドポイント

#### 対象サービス
S3 / DynamoDB専用

#### 制限事項
VPCエンドポイントサービスには使用不可

PrivateLink経由の「サービス提供/利用」は全てInterface型で実装

---

## PrivateLink の仕組み

### 概要
PrivateLinkは技術の名前

VPCエンドポイントサービス（提供側）とInterface型VPCエンドポイント（利用側）の2つが組み合わさって動作する仕組み

### 実装例

#### 提供側の設定
1. 自分のVPCにあるアプリをNLBの背後に配置
2. それをVPCエンドポイントサービスとして公開
3. 「このサービスをPrivateLinkで提供する」と宣言

#### 利用側の設定
1. 自分のVPCにInterface型VPCエンドポイントを作成
2. そのENIが提供側のNLB（VPCエンドポイントサービス）に直結

#### 結果
- 利用者側は「AWSのSQSやS3のように」DNS名でアクセス可能
- インターネットを経由せず、AWSバックボーン内でプライベート通信

---

## PrivateLink と Interface型の関係

### PrivateLink
全体の仕組みの名前

#### 構成要素
- 提供側: VPCエンドポイントサービスを作成
- 利用側: Interface型VPCエンドポイントを作成

この2つが組み合わさって「PrivateLink」が成立

### Interface型VPCエンドポイント
PrivateLinkを使用する際に利用側が必ず作成するもの

「PrivateLinkを利用する」＝「利用側はInterface型を作成する」が常に成立

---

## VPCエンドポイント種類別比較

### PrivateLink対応

#### Interface型VPCエンドポイント
- PrivateLinkの構成要素
- VPCエンドポイントサービスとの組み合わせで動作

### PrivateLink非対応

#### Gateway型VPCエンドポイント（S3 / DynamoDB専用）
- ルートテーブル経由で直接接続する方式
- ENI作成なし
- 他アカウントへのサービス公開機能なし
- PrivateLinkとは呼ばない

---

## まとめ

PrivateLink = Interface型VPCエンドポイント + VPCエンドポイントサービスの仕組み

Gateway型VPCエンドポイントは別の技術でPrivateLinkには含まれない

---

## OSI参照モデル プロトコル解説

### L7（アプリケーション層）で使用するプロトコル例

アプリケーション層ではアプリの機能に特化したプロトコルが動作

#### 主要プロトコル
- HTTP (80/TCP)
- HTTPS (443/TCP)
- SMTP (25/TCP, メール送信)
- IMAP (143/TCP), IMAPS (993/TCP), POP3 (110/TCP)
- FTP (21/TCP), SFTP (22/TCP)
- DNS (53/UDP または TCP)
- SNMP (161/UDP)
- RDP (3389/TCP)
- MQTT (IoTでよく使用, TCP/1883, TLS/8883)

**L7はアプリケーションごとのプロトコルがメイン**
それらは下のL4（TCP/UDP）を使用して通信

---

## TCP と L7 の関係

### TCP の位置づけ
TCP は L4（トランスポート層） のプロトコル

「TCPがL7で使用される」という表現は正確ではない

### 実際の関係
L7のアプリケーションプロトコルは、ほとんどTCPの上に構築されている

#### 例
- HTTP/HTTPS = TCPを使用して通信
- SMTP/IMAP/POP3 = TCPの上で動作
- FTP/SSH = TCPの上で動作

**TCPは土台（L4）、その上でL7プロトコルが動作**

---

## プロトコル詳細比較

### TCP (Transmission Control Protocol)

#### プロトコル種別
トランスポート層 (L4)

#### 役割
- コネクションの確立（3ウェイハンドシェイク）
- データの分割と再構成
- パケット順序の保証・再送制御
- 使用アプリ: HTTP, HTTPS, SMTP, FTP, SSH などの土台

**TCP = 信頼性のあるデータ輸送のルール**

### HTTP (HyperText Transfer Protocol)

#### プロトコル種別
アプリケーション層 (L7)

#### 役割
- WebブラウザとWebサーバー間でデータ（リクエスト/レスポンス）をやり取りするためのルール
- 例: GET /index.html HTTP/1.1
- 使用アプリ: Webサイト、API 通信 など

**HTTP = Web通信のやり取りルール**

### TCPとHTTPの関係
- TCPが 下層の信頼性ある輸送レイヤー
- HTTPは その上に乗るアプリ層のルール