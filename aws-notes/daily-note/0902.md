# AWS学習ノート - 9/02

## Lambda と HTTP 呼び出し

### 要件
Lambda + DynamoDB を HTTP 経由で呼び出したい

### 方法比較
| 方法 | 評価 | 特徴 |
|------|------|------|
| **API Gateway** | ✅ | フル機能（認証・ルーティング・ステージ・レート制御）を提供 |
| **Lambda Function URL** | ✅ | シンプルに Lambda に HTTPS URL を付与 |
| **S3/CloudFront 単体** | ❌ | 不可 |

### 選択指針
- **業務アプリ** → API Gateway
- **シンプルなケース** → Lambda Function URL

## Lambda Function URL

### 概要
API Gateway を通さず直接 Lambda を呼び出せる仕組み

### 認証タイプ
| タイプ | 特徴 | セキュリティ |
|--------|------|-------------|
| **AWS_IAM** | IAM 認証必須 | セキュア |
| **NONE** | 誰でもアクセス可能 | パブリック公開、注意必要 |

### 用途
- 簡易API
- Webhook受け取り
- 小規模アプリ

> **注意**: 本格業務アプリに直接使用はリスクあり。API Gateway 推奨

## ユーザー設定保存のDB選択

### 要件
- **データサイズ**: 1ユーザー ≈ 10KB
- **ユーザー数**: 数万人規模
- **ユーザーセッションで即参照** → 低レイテンシ必須

### 候補比較
| DB | 評価 | 特徴 |
|----|------|------|
| **DynamoDB** | ✅ ベスト | Key-Value 型、高速・スケーラブル、運用不要 |
| **RDS** | ⚠️ | リレーショナルだがスケール/レイテンシ不利 |
| **ElastiCache** | ⚠️ | キャッシュ用途（単独利用は不可、DynamoDBと併用可） |
| **S3** | ❌ | 遅いので不向き |

### 結論
**DynamoDB が最適**

## ユーザーセッションの重要性

### ポイント
- ユーザーがアプリを使用時、毎回設定をすぐ参照する必要
- **「即レスポンス」「低レイテンシ」が最重要**

> これが DynamoDB を選ぶ最大の理由

## DynamoDB のパーティションキー

### 定義
**パーティションキー** = データの一意識別子 + 物理保存場所の決定キー

### 設定例
```
Partition Key = UserID
Value = { "theme": "dark", "lang": "ja" }
```

### 拡張
ソートキーを組み合わせれば 1ユーザー内で複数設定を管理可能

## RDS vs DynamoDB 比較

### DynamoDB の強み
- **低レイテンシ**（ミリ秒で応答）
- **高いスケーラビリティ**（自動で数万人以上処理可能）
- **運用不要**（サーバーレス）
- **Key-Value モデル**がユーザー設定に最適

### RDS の適用場面
JOIN やリレーションが必要な場合は強いが、今回のケースでは不要

## DNS レコード基礎

### レコードタイプ
| レコード | 機能 |
|----------|------|
| **A レコード** | ホスト名 → IPv4 アドレス |
| **AAAA レコード** | ホスト名 → IPv6 アドレス |

> AAAA は IPv6 用

## Route 53 + CloudFront 連携

### 独自ドメイン設定
- CloudFront に独自ドメインを当てる場合は、Route 53 に **Alias A レコード** を作成
- **普通の A レコードに IP を直書き不可**（CloudFront は固定 IP を持たないため）
- 代わりに CloudFront のドメイン（例: `d123456abcdef8.cloudfront.net`）を Alias に設定

## Alias A レコード

### 概要
**Route 53 独自の A レコード拡張**

### 特徴
- IP ではなく **AWS リソースのドメイン名** を指定可能

### メリット
- **CloudFront/ALB/S3** などの動的リソースを使用可能
- **ルートドメイン**（example.com）にも設定可能
- **追加料金なし**

## CloudFront と Alias の設定方法

### 手順
1. **CloudFront ディストリビューション作成** → `d123456abcdef8.cloudfront.net` が割り当て
2. **Route 53 で Alias A レコード作成** → ターゲットにこの CloudFront ドメインを指定

### 設定例
```
cdn.example.com → A (Alias) → d123456abcdef8.cloudfront.net
```

## 学習まとめ

### 重要ポイント
1. **Lambda HTTP公開** → API Gateway or Function URL
2. **Function URL** → 簡易的な直アクセス（IAM/NONE 認証）
3. **DB選択** → DynamoDB（低レイテンシ・スケーラブル）
4. **セッション処理** → 即時参照がポイント
5. **パーティションキー** → データ一意化 & 分散保存の基準
6. **RDS vs DynamoDB** → Key-Value & 高速性重視で DynamoDB
7. **DNS** → A = IPv4, AAAA = IPv6
8. **Route 53 Alias** → CloudFront などの AWS リソースを直接指定する特別な A レコード
9. **CloudFront 紐付け** → `d123456abcdef8.cloudfront.net` を Route 53 の Alias A レコードに指定