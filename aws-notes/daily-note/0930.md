# VPC ピアリングの仕組み

## 基本概念

VPC ピアリングは L3（IP レベル）での相互ルーティング

### ルート設定要件

両方の VPC で相手 VPC の CIDR をルートテーブルに追加して経路を広報する必要がある

### 設定例

VPC A (172.30.0.0/16) から VPC B (10.55.0.0/16) へ通信する場合:

- **VPC A のルートテーブル**: 宛先 10.55.0.0/16 → ピアリング
- **VPC B のルートテーブル**: 宛先 172.30.0.0/16 → ピアリング

相手 VPC 全体の CIDR を丸ごと経路に登録する必要がある

---

## Site-to-Site VPN

### 特徴

- インターネットを経由
- 通常の VPN トンネル（IPsec）で暗号化
- 基盤は「インターネット回線」

### メリット・デメリット

- 専用線を引くよりは安い
- 帯域やレイテンシに制約がある

---

## VPC Peering

### 特徴

- AWS の内部バックボーンを使用
- インターネット経由しない
- リージョンが違っても「クロスリージョン VPC ピアリング」が可能
- 通信は AWS グローバルネットワーク内で流れる

---

## PrivateLink との比較

### 特徴

- AWS 内部ネットワークで完結
- CIDR 広告は不要
- 「サービスエンドポイント単位」で接続可能

### セキュリティ要件

単一ポート限定、最小構成、インターネット不使用

---

## OAC（Origin Access Control）の流れ

### OAC作成プロセス

1. CloudFrontで「OACを作成」→ ID付きのOACが生成される
2. このOACは CloudFront に自動で紐づけられる
   - 「このディストリビューションがS3にアクセスするときは、このOACを使う」状態になる

### 設定手順

S3バケットポリシーに対して「このOACからのアクセスを許可」を記述

### CloudFront用OACを許可する場合のポリシー例

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Service": "cloudfront.amazonaws.com"
      },
      "Action": "s3:GetObject",
      "Resource": "arn:aws:s3:::your-bucket-name/*",
      "Condition": {
        "StringEquals": {
          "AWS:SourceArn": "arn:aws:cloudfront::<account-id>:distribution/<distribution-id>"
        }
      }
    }
  ]
}
```

### ポリシーの構成要素

- **Principal**: CloudFront サービス
- **Condition**: AWS:SourceArn を指定して、特定のCloudFrontディストリビューションからのリクエストだけ許可

### 効果

「S3の中身は直接URLでアクセスできないけど、CloudFront経由ならOK」になる

### まとめ

- OACは「CloudFrontがS3へ安全にアクセスするための鍵」
- OACは対象バケットを選ぶだけで作成OK（CloudFrontが署名処理を自動でやる）
- S3バケットポリシーに「このOACからのアクセス許可」を追加すれば完成