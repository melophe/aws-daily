# AWS ParallelCluster

## 概要

AWS が提供する**ハイパフォーマンスコンピューティング（HPC）クラスターの自動構築・管理ツール**

- **オープンソース**（Python製のCLIツール）
- HPC環境を簡単にデプロイできるように設計
- 数学シミュレーション、金融リスク計算、ゲノム解析、機械学習の分散トレーニングなど、密結合型ワークロードに最適

## 主な特徴

### 簡単なクラスター構築
- 設定ファイル（YAML）を書くだけで、数分でHPCクラスターを作成可能
- 計算ノード数やインスタンスタイプ、ストレージ、ネットワークなどを定義

### スケーラビリティ
- ジョブ数に応じて計算ノードを自動スケール
- 使わないときはノードを自動停止してコスト削減

### Elastic Fabric Adapter (EFA) 対応
- MPI（Message Passing Interface）を利用するアプリケーションに必要な**低レイテンシ・高帯域幅通信**を実現
- 従来のEthernetより高速なインターコネクトを提供

### 統合されたジョブスケジューラ
- Slurm, AWS Batch などのジョブスケジューラを選択可能
- HPCワークロードの投入・管理が容易

### AWSサービス連携
- Amazon FSx for Lustre（高性能並列ファイルシステム）やAmazon S3と簡単に統合
- 機械学習や金融データ処理でよく使う大規模データも効率的に扱える

## 利用例

### 研究機関や金融機関での大規模シミュレーション・不正検出モデルの分散学習

- **管理ノード（Master Node）**: クラスターの制御
- **計算ノード（Compute Nodes）**: 自動的にスケーリングしてジョブを実行
- EFA で低遅延通信、FSx for Lustre で高速ファイルアクセス

## メリット

| メリット | 説明 |
|----------|------|
| **HPC専用最適化** | 構築ツールが最適化済み → 運用オーバーヘッド削減 |
| **EFA対応** | MPI通信が高速 → HPC/MLワークロードに最適 |
| **スケーラブル** | 必要なときだけ計算資源を利用でコスト効率的 |

> **まとめ**: AWS ParallelCluster は「AWS上でHPCクラスターを楽に構築・運用できるマネージドツール」

# EFA（Elastic Fabric Adapter）

## 概要

EFA（Elastic Fabric Adapter）は、AWS が提供する**EC2向けのネットワークインターフェイス**で、特に**ハイパフォーマンスコンピューティング（HPC）**や**機械学習の分散トレーニング**に最適化

通常の EC2 インスタンスに標準で付いている ENI（Elastic Network Interface）よりも、**低レイテンシ・高スループット・高効率な通信**が可能

## 特徴

### 低レイテンシ通信
- HPC アプリは「MPI（Message Passing Interface）」のようにノード間で頻繁に通信
- EFA は通常の TCP ではなく、OS カーネルをバイパスする **RDMA（Remote Direct Memory Access）ベースの通信**を実現
- ミリ秒単位でなく**マイクロ秒単位の遅延**に

### 高スループット
- **数百 Gbps 級の高帯域**を提供
- AI/ML 分散学習（例: TensorFlow, PyTorch Horovod）や大規模シミュレーションでも通信がボトルネックになりにくい

### スケーラビリティ
- **数千ノード規模**までスケール可能
- 大規模 HPC クラスターや金融リスク分析モデルの分散処理に適している

### 既存アプリ対応
- MPI（OpenMPI, Intel MPI など）や NCCL（NVIDIA Collective Communications Library）などが EFA に対応済み
- 既存の HPC アプリを大きく修正せずに性能向上が期待できる

## 適用分野

### HPC 分野
流体力学シミュレーション、気象予測、分子動力学、金融リスク計算

### 機械学習分野
- GPU クラスターでの分散ディープラーニング（数百 GPU 規模）
- Amazon SageMaker でも内部的に EFA が使われるケースがある

## まとめ

- **EFA** = EC2 用の HPC/ML 向け高速ネットワークインターフェイス
- RDMA を使った低レイテンシ通信が可能
- MPI や分散ディープラーニングの効率が飛躍的に向上
- AWS ParallelCluster と組み合わせると本領発揮

# AWS ParallelCluster と EFA の関係

## AWS ParallelCluster の要点

- HPC クラスターを簡単に構築・管理できるツール
- 設定ファイルを書くだけで、マスター・計算ノード・ストレージを自動構築
- Slurm などのジョブスケジューラも組み込める
- スケーリングも自動なので、運用オーバーヘッドを大幅に削減できる

> **要するに**：「HPC クラスター自動組み立てキット」

## EFA (Elastic Fabric Adapter) の要点

- EC2 用の特別なネットワークインターフェイス
- RDMA（Remote Direct Memory Access）を使って、超低レイテンシ & 高スループット通信を実現
- MPI や分散ディープラーニングの通信性能が大幅に向上

> **要するに**：「HPC 専用のハイスピード通信ケーブル」

## 両者の関係

ParallelCluster で HPC クラスターを構築するときに、EFA を有効化することで高速なノード間通信が可能になる

| サービス | 役割 |
|----------|------|
| **ParallelCluster** | HPC クラスター全体を自動で用意してくれる仕組み |
| **EFA** | そのクラスター内で使う特別速いネットワーク |

# その他の AWS 学習ポイント

## Auto Scaling の制約

### タイムアウト処理
Auto Scaling は、スケーリングが正常に行われずに24時間以上経過した場合、自動的に処理を停止する仕組みを持っている。30時間以上にわたりスケーリングが機能しなかった場合、処理は途中で停止する

### AZ 障害時の動作
特定のアベイラビリティゾーン（AZ）での新規インスタンスの起動に失敗した場合、別の AZ で起動プロセスを実行することはなく、Auto Scaling グループの設定に基づいて指定された AZ 内でインスタンスの起動を行う。したがって、Auto Scaling グループの設定で複数の AZ を指定している場合、失敗の有無にかかわらず、複数の AZ での起動を試みることになる

## DynamoDB Streams 詳細

### 概要
DynamoDB テーブルで発生した**データ変更イベント（書き込み・更新・削除）**を時系列でキャプチャして、他のサービスやアプリケーションに通知・連携できる機能

### 変更イベントの取得

#### 基本動作
PutItem / UpdateItem / DeleteItem が発生すると、ストリームに「レコード」が流れる

#### レコードに含まれる情報
- **変更前のデータ**（Old Image）
- **変更後のデータ**（New Image）
- **操作タイプ**（INSERT / MODIFY / REMOVE）

### 他サービスへの通知・連携
DynamoDB Streams 単体では通知を直接送るわけではなく、イベントソースとして他サービスが購読する形になる

#### AWS Lambda
- Streams をトリガーにしてリアルタイム処理
- **例**: テーブル更新があったら別のテーブルに反映、S3にログ保存

#### Amazon Kinesis Data Streams
- より複雑なストリーム処理や外部システム連携

#### Amazon OpenSearch Service
- データ更新を検索インデックスに即時反映

### 典型的なユースケース

#### 監査ログ
誰がいつどのデータを更新したかを保存

#### 非同期処理
注文データが入ったら在庫を更新、通知メール送信など

#### 複数テーブル同期
User テーブルの更新を Profile テーブルに即反映

#### イベント駆動アーキテクチャ
DynamoDB の変更をトリガーに他の AWS サービスを動かす

## S3 の整合性

S3 は強い整合性モデルを利用しているため、反映に誤差が生じることはない

## ハイブリッド接続構成

### 基本構成
Direct Connect + Site-to-Site VPN を両方使うハイブリッド構成が多い

| 接続方式 | 役割 | 特徴 |
|----------|------|------|
| **Direct Connect** | メインの専用線 | 安定・高速 |
| **VPN** | バックアップ回線 | Direct Connect 障害時に自動フェイルオーバー |

> **この組み合わせを「ハイブリッド接続（Hybrid Connectivity）」と呼ぶ**

### 詳細
- **Direct Connect** → オンプレから AWS へのメイン回線（専用線・高品質）
- **Site-to-Site VPN** → オンプレから AWS へのインターネット VPN（安価・即日利用可）

### ベストプラクティス
実際の設計では、Direct Connect をメイン、VPN をバックアップにするのがベストプラクティス

## セキュリティ関連

### IPsec
VPN 接続で使用される暗号化プロトコル

### S3 外部アクセス制限
S3 の URL が外部からアクセスできないようにと言われた場合、署名付き Cookie や署名付き URL はアクセス期間を制限することが可能だが、その期間中は外部でリンクを利用することができるため、要件に合致しない場合がある

# DynamoDB トランザクション FAQ

## 基本的な疑問

### Q: トランザクションって何？

**A**: DynamoDB で複数の Put/Update/Delete を1つの ACID トランザクションとして実行できる機能

- **最大25件の操作**をまとめて扱える
- 金融システム、在庫管理、個人情報削除ワークフローに便利

### Q: 削除してから書き込みってできる？

**A**: できる

- `TransactWriteItems` で Delete ＋ Put をまとめて定義可能
- **成功すれば**削除→書き込みが確実に実行される
- **失敗すれば**ロールバック