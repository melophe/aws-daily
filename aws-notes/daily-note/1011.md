# Amazon DocumentDBとは？

Amazonが提供する、MongoDB互換のマネージドドキュメントデータベースサービスです。
つまり、「MongoDBをAWSが管理・運用してくれるサービス」です。

## MongoDBとの関係

| 比較項目 | MongoDB（オープンソース） | Amazon DocumentDB |
|---------|------------------------|-------------------|
| 提供形態 | 自分でEC2などにインストールして運用 | AWSがフルマネージドで運用 |
| 互換性 | 本家 | MongoDB互換API（アプリ側のコードはほぼそのまま動く） |
| 運用 | 手動でバックアップ、監視、フェイルオーバー | 自動バックアップ・フェイルオーバーあり |
| 可用性 | シングル構成になりやすい | マルチAZ構成が標準 |
| スケーリング | 手動で設定 | 自動スケール対応 |

```
┌───────────────────────────┐
│   アプリケーション層 (ECS / EC2など)   │
└───────────────────────────┘
               │
               ▼
┌───────────────────────────┐
│  Amazon DocumentDB クラスター  │
│  ┌────────────┬────────────┐  │
│  │プライマリ  │ レプリカ1  │  │
│  │(書き込み)  │(読み取り)  │  │
│  └────────────┴────────────┘  │
│   │自動同期＆マルチAZ構成│      │
└───────────────────────────┘
```

- **プライマリ（Primary）**：書き込み用
- **レプリカ（Replica）**：読み取り専用の複製
- **マルチAZ構成**：各AZに自動で分散配置
  - 1つのAZがダウンしても自動フェイルオーバーしてサービス継続

## AWS DMS（Database Migration Service）

DMS（Database Migration Service）は、既存のMongoDBからDocumentDBへのデータ移行を簡単に行えるサービスです。

- 稼働中のMongoDBを止めずに移行（最小ダウンタイム）
- 一時的に「両方稼働してデータ同期」も可能

### DMSとは？

AWS Database Migration Service (DMS) は、データベースをほぼ止めずに移行（または同期）できるサービスです。

つまり、

**「既存DBを動かしたまま、別のDBにデータをリアルタイムでコピーできる」**

というのが最大の強みです。

### DMSでできること（主な用途）

#### ① データベースの移行（Migration）

いちばん基本的な使い方です。

| 目的 | 例 | 内容 |
|------|----|----|
| 同種DBへの移行（同種間移行） | MySQL → RDS for MySQL | バージョンアップやクラウド移行など |
| 異種DB間の移行（異種間移行） | Oracle → PostgreSQL | 異なるDBエンジンへ移行（データ変換も可能） |
| NoSQLから移行 | MongoDB → DocumentDB / DynamoDB | JSON形式DBのクラウド移行 |

#### ② データの継続的レプリケーション（Replication）

DMSは「一回きりの移行」だけでなく、「常時同期」もできる！

| 用途 | 例 |
|------|----|
| 災害対策（DR） | 東京リージョン → 大阪リージョンへリアルタイム同期 |
| データ分析 | 本番DB（RDS）→ Redshift（DWH）へ継続的に転送 |
| 異環境間の連携 | オンプレのDB → AWS上のDBへ同期 |

### 対応しているデータベース

| ソース（移行元） | ターゲット（移行先） |
|----------------|-------------------|
| Oracle | RDS, Aurora, Redshift, S3 |
| MySQL / MariaDB | RDS, Aurora, S3 |
| PostgreSQL | RDS, Aurora, Redshift |
| SQL Server | RDS, S3 |
| MongoDB / DynamoDB | DocumentDB, S3 |
| さらに... | 任意のJDBC対応DB、オンプレDBもOK |

### 異種間移行（heterogeneous migration）

| 移行元 | 移行先 | 説明 |
|--------|-------|------|
| Oracle | Aurora MySQL / PostgreSQL | SQL構文や関数が違うため変換が必要 |
| SQL Server | MySQL / PostgreSQL | データ型やストアドの違いあり |
| MongoDB | DynamoDB / DocumentDB | データ構造そのものが違う（JSON vs Key-Value） |

| 区分 | 例 | 特徴 |
|------|----|----|
| ✅ 同種間移行 | Oracle → RDS for Oracle / MySQL → RDS for MySQL | コード修正ほぼ不要・簡単 |
| ⚠️ 異種間移行 | Oracle → Aurora / SQL Server → PostgreSQL | スキーマ変換・コード修正が必要 |

この場合は **AWS SCT (Schema Conversion Tool)** を使ってテーブル構造やSQLを変換します。

### DMSのアーキテクチャ

DMSを使うときは、**AWS上にDMS専用のEC2っぽいインスタンス（レプリケーションインスタンス）**が作られ、その中でデータ移行処理（コピー・変換・同期）が行われます。

```
┌──────────────┐    ┌────────────────────────┐    ┌──────────────┐
│   ソースDB    │─▶  │レプリケーションインスタンス│─▶  │ターゲットDB   │
│ (例: Oracle) │    │ (AWS DMSが作成・管理)   │    │(例: RDS, S3) │
└──────────────┘    └────────────────────────┘    └──────────────┘
```

レプリケーションインスタンスが中心的な役割を担います。

DMSは、このインスタンス内で以下の処理を行います：

| 処理内容 | 説明 |
|---------|------|
| データ抽出（Extract） | ソースDBからデータを読み取る |
| データ変換（Transform） | 必要に応じてデータ形式を変換 |
| データロード（Load） | ターゲットDBにデータをロード |
| 継続的レプリケーション（CDC） | 変更をリアルタイム反映する |

### DMSの3つの構成要素

| 要素 | 役割 |
|------|------|
| ソースエンドポイント | データの移行元DB（例：Oracle、MySQLなど） |
| ターゲットエンドポイント | データの移行先DB（例：RDS、Auroraなど） |
| レプリケーションインスタンス | 実際に移行処理を実行する「DMSの本体」 |

### インスタンス作成時に指定する主な設定

| 項目 | 内容 |
|------|------|
| インスタンスタイプ | dms.t3.medium / dms.r5.large など（移行規模に応じて選択） |
| ストレージ容量 | 一時データを保存する領域（例：50〜500GB） |
| VPC/サブネット/セキュリティグループ | ソース・ターゲットDBに接続できるネットワーク設定 |
| マルチAZオプション | 高可用性を求める場合は有効化可能 |

この「レプリケーションインスタンス」は、内部的にはEC2のような仮想サーバーです（ただしユーザーが直接ログインはできません）。

DMSコンソール上で「起動中」「停止中」「CPU使用率」なども確認できます。

## 異種間移行の進め方

異種間移行（heterogeneous migration） はDMSだけでは不十分。
必ず **SCT（AWS Schema Conversion Tool）＋DMS** のセットで行うのが基本です。

### 異種間移行の流れ

```
┌────────────┐
│Oracle (Source)│
└──────┬─────┘
       │
       │ ① SCTでスキーマ変換
       ▼
┌────────────────────┐
│Aurora MySQL用スキーマ生成│
└──────┬─────────┘
       │
       │ ② DMSでデータ移行・同期
       ▼
┌────────────┐
│Aurora MySQL │
└────────────┘
```

### MongoDB → Amazon DocumentDB

MongoDB → Amazon DocumentDB は、**「同種間移行（homogeneous migration）」**に分類

Amazon DocumentDB は、**「MongoDB互換APIを持つAWSマネージドデータベース」**

## Application Load Balancer（ALB）について

「複数AZに配置したALBのターゲットとして登録する」＝ ALBは1つ、ただし複数AZに跨って動作している。

✅ **ALB（Application Load Balancer）は特定のAZに属していません。**

代わりに、複数のAZにまたがって動作できる「リージョン単位のサービス」です。

ALBを作成するとき、AWSコンソールでこういう画面が出ます：

> 「サブネットを選択してください（少なくとも2つのAZを選択することを推奨）」

ここで選ぶサブネットが、ALBの各AZでトラフィックを受け付けるエントリーポイント（ENI＝Elastic Network Interface）になります。

```
東京リージョン（ap-northeast-1）
┌────────────────────────────┐
│ AZ-1a                      │
│   ├─ ALB用ENI（入口①）      │
│   └─ ECSタスク（Fargate）   │
│                            │
│ AZ-1c                      │
│   ├─ ALB用ENI（入口②）      │
│   └─ ECSタスク（Fargate）   │
└────────────────────────────┘
      ▲
      │
Application Load Balancer
（リージョンレベルで動作）
```

## DMSの移行方式

### (1) Full Load（フルロード）← 既存データを丸ごとコピー
### (2) CDC（Change Data Capture）← その後に発生する更新を追跡

---

### ① フルロード（Full Load）

**目的：**

ソースDBにある既存データをターゲットDBに一括で移す。

**イメージ：**

たとえば、オンプレDBに「users」テーブルがあるとします。

| user_id | name  | email           |
|---------|-------|-----------------|
| 1       | Alice | a@example.com   |

```
On-Prem DB  →  Aurora PostgreSQL
(全件コピー)   (まだ同期されてない)
```

フルロード中は「スナップショットコピー」に近い感じです。

---

### ② CDC（Change Data Capture）

**目的：**

フルロード完了後に、ソースDBで発生する更新（INSERT / UPDATE / DELETE）をリアルタイムで追跡・転送する。

**仕組み：**

DMSはソースDBの**トランザクションログ（例：binlog, redo logなど）**を監視します。

そこで検出された変更をターゲットDBに即時反映します。

たとえば：

| 操作   | user_id | name              |
|--------|---------|-------------------|
| UPDATE | 2       | "Bob" → "Bobby"   |
| INSERT | 4       | "Dave"            |

```
ソースDB (オンプレ)
    ├─ INSERT / UPDATE / DELETE を検出
    ▼
AWS DMS (CDC)
    ▼
ターゲットDB (Aurora PostgreSQL)
```

こうして「移行後もデータがズレない状態」を保てるようになります。

---

### 2つを組み合わせる理由

- フルロードだけだと、コピー中に更新されたデータが反映されない
- CDCだけだと、既存データが移行されない

→ **だから両方を組み合わせて使います** ✅

---

### 流れまとめ

| フェーズ | 説明 |
|---------|------|
| ① フルロード | ソースDBの全データを一括コピー |
| ② CDC開始 | フルロード完了後、更新ログをリアルタイム反映 |
| ③ 同期完了 | CDCのラグ（遅延）がゼロになったらアプリ切替（カットオーバー） |

---

### カットオーバー（切り替え）

CDCによる同期が追いついたら（＝差分ゼロになったら）アプリを新しいDBに切り替えます。

これが「最小ダウンタイム移行」の仕組みです。

## Snowball + DMSの組み合わせ

Snowballは「最初の大量データ転送」に使い、DMSはその後の「差分同期（CDC）」に使うのがベスト

### Oracle → Redshiftへの移行例

1. Snowballで初回の40TB分をS3に取り込み
2. その後、DMSでCDC（変更データキャプチャ）を走らせて差分だけネットワーク経由で同期
3. 最後にカットオーバー

→ **これで大容量移行＋最小ダウンタイムを両立**

```
(1) 初回フルロード：Snowball Edge
      ↓
(2) 差分同期：AWS DMS（CDC）
```

### 移行の流れ

1. Snowballで**初回データ（数TB〜数十TB）**をS3に物理搬送
2. AWS側にデータを取り込んだあと
3. DMSを起動して、「Snowball搬送後に発生した変更データ（CDC）」だけを追跡して同期
4. 更新がゼロ（ラグが0）になったタイミングでカットオーバー（切替）

## その他の重要概念

### Bring Your Own License（BYOL：ライセンス持ち込み）

既に持っているソフトウェアのライセンスを、そのままAWS環境でも使う方式。

### ワークロードを分離する

目的別に処理を分けます：

#### ① 書き込み専用（トランザクション系）
→ Aurora/MySQL の **プライマリインスタンス**

#### ② 読み取り専用（集計・分析系）
→ Aurora/MySQL の **リードレプリカ**

## AWS SCT（Schema Conversion Tool）

### SCTの全体フェーズ

SCTは「異種間移行（例：Oracle → Aurora PostgreSQL）」などで使うツールで、ざっくり分けると以下の3フェーズに分かれています：

| フェーズ | 内容 | 目的 |
|---------|------|------|
| ① アセスメント（Assessment） | 現行DBのスキーマを分析し、ターゲットDBに変換できる部分とできない部分をレポート化 | 移行難易度の把握 |
| ② スキーマ変換（Schema Conversion） | 変換可能な部分を自動変換し、変換不可能な部分（ストアド・関数など）は手動修正提案 | スキーマをターゲット用に整備 |
| ③ データ移行（Data Migration） | AWS DMSと連携して、実際のデータを移行（CDC含む） | 実データの移行 |

### SQL dumpとは？

データベースの中身（スキーマ＋データ）を、SQL文の形で書き出したテキストファイルのこと。

#### DMSとの違い

| 比較項目 | SQL dump | AWS DMS |
|---------|----------|---------|
| 移行方式 | 一括転送（静的） | 継続的（リアルタイム） |
| 停止時間 | 長い（dump → import中は止まる） | 短い（CDCで同期） |
| 速度 | データ量による | 並列・差分対応で速い |
| 自動化 | 手動 | 自動化可能 |
| 適用対象 | 小〜中規模DB | 中〜大規模・本番環境 |

dumpはシンプルで手軽だけど、停止時間（ダウンタイム）が必要。リアルタイム移行には向きません。

## Route 53の ALIASレコード

Route 53の **ALIASレコード**は、AWS内部のサービス（例: ELB、CloudFront、S3、RDS/Aurora など）に名前で直接紐づけられる特別なAレコードの拡張版です。

つまり、こう設定できます：

| 項目 | 値の例 |
|------|--------|
| レコードタイプ | A – ALIAS |
| ドメイン名 | db.example.internal |
| ターゲット | mydb.cluster-abcdefghij.ap-northeast-1.rds.amazonaws.com (Aurora クラスターのエンドポイント) |

これを設定すると：

- Auroraのフェイルオーバーが発生しても
  → Route 53は自動で新しいIPに追従する
- DNS解決は常に最新のAuroraクラスターを指す
- TTLの管理もAWS側で最適化される

## ネットワーク制約について

### 「インターネット回線のみ」とは

問題文に出てくるこの文言は、ネットワーク経由でAWSへデータ転送できる経路が"インターネットしかない"という意味です。

つまり：

- 専用線（AWS Direct Connect）なし
- VPNもなし
- 帯域は〜〜まで

という制約の中では、「ネットワーク経由で大量転送」は不可能だということを示しています。

**だからDMSやDataSyncでは無理**

- DMSはデータベース間のオンライン転送を行うため、通信帯域がボトルネックになります
- DataSyncも「回線を使ってS3やEFSに送る」仕組み

## SCT Data Extraction Agent

AWS SCT（Schema Conversion Tool）には、「データ抽出エージェント（SCT Data Extraction Agent）」という機能があって、Snowball Edgeにデータを書き出す役割も担えます。

### SCTの2つのモード

| モード | 主な目的 |
|--------|---------|
| スキーマ変換モード | テーブル構造やSQL文をターゲットDBに合わせて変換する（Oracle → PostgreSQLなど） |
| データ抽出モード（Data Extraction Agent） | オンプレDBのデータそのものをSnowball Edgeに書き出して転送する |

### Data Extraction Agentの仕組み

この「抽出エージェント（Extraction Agent）」は、オンプレ側にインストールして次のように動きます：

1. オンプレDB（Oracle, SQL Server, etc）に接続
2. データをローカル経由でSnowball Edgeに書き込み
3. SnowballをAWSに物理搬送
4. AWS側でSnowball → S3へデータを自動転送
5. SCTまたはDMSでS3上のデータをターゲットDBにロード

つまり、帯域制約（ネットワーク遅い）環境でも大容量DBを移行できるという仕組みです。

### なぜSCTエージェントを使うのか？

この機能は「ネットワークを使えない環境でのオフラインデータ移行」を想定して追加されたものです。

| 比較 | 通常の移行 | Snowball連携（SCTエージェント） |
|------|-----------|------------------------------|
| 転送経路 | ネットワーク経由 | 物理デバイス（Snowball Edge） |
| 帯域制約 | あり（遅い） | なし（ローカル書き込み） |
| データ量 | 小～中規模 | 数十TB～PB級 |
| 停止時間 | 長くなる可能性 | 短縮可能（事前搬送） |

```
オンプレDB
   ↓
SCT Data Extraction Agent
   ↓
Snowball Edge (Storage Optimized)
   ↓（物理輸送）
AWS データセンター
   ↓
S3に自動インポート
   ↓
Redshift / Aurora / RDSへロード（DMSまたはCOPYコマンド）
```

### Snowball Edge "Storage Optimized"とは？

- 約80TB～100TBクラスのローカルストレージを搭載
- 大容量データ転送やDWH移行向け
- SCTとネイティブ連携できる
- 転送完了後、自動でS3へアップロード

**重要：**SCTのData Extraction Agentは、ネットワーク経由で動けないDMSの代替ツール。つまり、「DMSっぽい仕事をオフラインでやる」ものです。

---

## まとめ：重要ポイント

### 1. 単一障害点（SPOF）とは？

**単一障害点（Single Point of Failure）**＝一箇所壊れたら全体が止まる構成のこと。

例）1台しかないDBサーバ、単一EC2など。

「単一障害点をなくす」とは、→ **冗長化（Multi-AZ, Auto Scaling, ELBなど）**を使って、どこかが壊れても他が引き継ぐ構成にすること。

### 2. Amazon DocumentDBとは？

- MongoDB互換のフルマネージドDB
  → MongoDBのドライバやコマンドがそのまま使える
- マルチAZ構成対応＋自動フェイルオーバーあり
- MongoDB→DocumentDB は「同種移行（同系DB）」扱い（SCT不要）
- AWS DMSで移行可能（CDC対応）

### 3. AWS DMS（Database Migration Service）

DB移行専用サービス。→ オンプレ → AWS / AWS間 / 異種間、どれでもOK。

#### 主なモード

| モード | 説明 |
|--------|------|
| フルロード | 最初に全データコピー |
| CDC（Change Data Capture） | その後の変更をリアルタイム同期 |
| 継続レプリケーション | 長期間リアルタイム複製（ほぼ同期DB化） |

### 9. Route 53のALIASレコード

Auroraのエンドポイントは固定IPじゃない（フェイルオーバーで変わる）。

なので、普通のAレコードではなく **ALIASレコード**を使う。

| 比較項目 | Aレコード | ALIASレコード |
|---------|----------|--------------|
| 値 | 固定IP | AWSリソース名（例: RDS/Aurora/ELB） |
| 追従性 | 手動更新必要 | 自動で新IPに追従 |
| 料金 | 課金あり | 無料（内部解決） |

```
DMS → Aurora Primary → Aurora Storage → Aurora Replica
```

### 11. カットオーバーの流れ（DMS + Route53）

1. DMSでオンプレ→Auroraをリアルタイム同期（CDC）
2. Lag（レプリケーション遅延）が0になったら、
3. Route53の `db.example.internal` レコードを Aurora に切替
4. 数秒でアプリが新DBを参照し始める
5. 同期確認後、DMSタスク停止

👉 **アプリの設定変更なしで無停止移行が完了**

### 12. SQL Dumpとは？

DBを「SQL文（CREATE / INSERT）」形式で書き出したファイル。

例：`mysqldump -u root -p mydb > backup.sql`

- スキーマ＋データのバックアップが取れる
- ただしフルロードなので**ダウンタイムが必要**（リアルタイムではない）
- DMSはこのSQL dumpの"自動＋リアルタイム版"みたいなもの

### 13. DataSyncやDirect Connectが不適なケース

- 帯域が低い（50Mbps）場合、DataSyncやDMSは非現実的
- Direct Connectは工事・開通に数週間かかるので「10日以内」は不可能
- よってこの場合は **Snowball Edge 一択**

### 14. BYOLとは？

**Bring Your Own License（ライセンス持ち込み）**

例：OracleやSQL Serverの既存ライセンスをAWS上でも継続利用するモデル。

EC2やRDSで「自分のライセンスを使う」設定が可能（コスト最適化）。

### 15. ワークロード分離

「書き込み系」と「分析系」を分ける設計。

→ Auroraのリードレプリカを利用して、書き込みはPrimary・集計はReplicaで処理。

ロック競合を防ぎ、SLAを守る。

#### 典型例：

```
DMS → Aurora (Primary) ← API書き込み
           ↓
    Aurora Replica ← 集計分析
```
