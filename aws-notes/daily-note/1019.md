# Memcached と Redis の機能比較

## セキュリティ・暗号化機能

| 機能項目 | Memcached | Redis |
|---------|-----------|-------|
| 通信の暗号化（TLS） | ❌ 標準サポートなし（フォーク版で対応可） | ✅ 標準サポート（Redis 6以降） |
| 認証機能 | △ SASL認証のみ | ✅ ACLやパスワード認証あり |
| 保存時の暗号化（At Rest） | ❌ なし | ✅ Enterprise版などで対応可 |

## データ構造・機能

| 機能項目 | Memcached | Redis |
|---------|-----------|-------|
| データ型 | 🔹 文字列（Key-Valueのみ） | 🔹 文字列・リスト・セット・ハッシュ・ソート済みセット など多彩 |
| 並び替え・ランキング処理 | ❌ 不可（アプリ側で対応） | ✅ ZADD, ZRANGE, ZREVRANGE などで可能 |
| スクリプト実行（Lua等） | ❌ 不可 | ✅ EVAL コマンドで可能 |
| 永続化（データ保存） | ❌ なし（完全な揮発メモリ） | ✅ RDB・AOF・スナップショット対応 |

## 用途別の使い分け

| 用途・目的 | 推奨 |
|-----------|------|
| 単純なキャッシュ（例：セッション・HTML） | 🟢 Memcached |
| ランキング・スコア順処理 | 🟢 Redis |
| 暗号化通信が必要な環境 | 🟢 Redis |
| データ永続化や高機能な構造操作 | 🟢 Redis |

---

# ステートレス vs ステートフル

## ステートレス（stateless）

サーバーが「セッションや状態（state）」を保持しない。

- 各リクエストは独立しており、どのサーバーに送っても同じ結果になる

## ステートフル（stateful）

サーバーが何らかの状態やデータを保持している。

- 例：ユーザーのログイン状態、キャッシュデータ、カウンタ値などをメモリに持つ

## Redis / Memcached の立ち位置

| 項目 | Redis | Memcached |
|-----|-------|-----------|
| データ保持方式 | インメモリ（永続化も可能） | インメモリ（永続化なし） |
| クラスタ構成 | レプリケーションやシャーディングあり | シャーディング中心（単純） |
| 状態保持の有無 | あり（キーと値を保持） | あり（キーと値を保持） |

---

# ALB（Application Load Balancer）

## ALB は「VPC 内に存在する」リソース

ALB は VPC（Virtual Private Cloud）内に作成されるロードバランサー。

その中で、複数のサブネット（＝AZ単位）にまたがって配置される。

つまり、「VPCの外にある」わけではない。

```
┌──────────────────────────────┐
│           VPC (10.0.0.0/16)             │
│                                          │
│   ┌────────────┐   ┌────────────┐   │
│   │  Subnet(AZ-a) │   │  Subnet(AZ-c) │   │
│   │   (Public)     │   │   (Public)     │   │
│   │     ┌──────────────┐   │
│   │     │  ALB (ENI)     │ ← ALBはVPC内に配置
│   │     └──────────────┘   │
│   │        │        │        │
│   │     EC2-1    EC2-2      │
│   │  (Private Subnet)       │
│   └────────────┘   └────────────┘
└──────────────────────────────┘
```

## AZとの関係

ALBを作成する際、2つ以上のサブネット（通常は異なるAZのもの）を指定する。

これにより、ALBは各サブネットに ENI（Elastic Network Interface）＝ネットワークインターフェイス を作成し、各AZに「入り口」を持つ。

その結果、AZ障害が発生しても他のAZのALBエンドポイントが生き残り、可用性が確保される。

→ つまり「ALBは複数AZにまたがるが、VPCの中にある」が正確な表現

## ALB の特性まとめ

| 項目 | 説明 |
|-----|------|
| 所属 | ALB は必ず VPC に属する |
| 配置 | 複数の AZ のサブネットにまたがる（高可用性） |
| ネットワークIF | 各AZのサブネットに ENI が作られる |
| パブリック性 | 「Public（外部アクセス可）」または「Internal（VPC内限定）」を選択できる |

## ヘルスチェックパスの設定

ALB（Application Load Balancer）は、ターゲットグループ単位でヘルスチェックのパスを自由に指定できる。

### 設定例

- `/`
- `/health`
- `/api/status`
- `/custom/check?deep=true`

### 設定場所と単位

ALB自体にはヘルスチェック機能があるが、実際の設定は **ターゲットグループごと** に行う。

つまり：

- ALB → 複数ターゲットグループを持つ
- 各ターゲットグループ → 自分専用のヘルスチェック設定を持つ

### 例

| ターゲットグループ名 | 対応するサービス | ヘルスチェックパス |
|------------------|----------------|------------------|
| tg-web | Webサーバー | /health |
| tg-api | APIサーバー | /api/ping |

---

# CloudFormation vs Service Catalog

## 基本的な関係

- CloudFormation は「構築のためのエンジン」
- Service Catalog は「構築テンプレートを安全に配る仕組み」

## 違い

| 項目 | CloudFormation | Service Catalog |
|-----|---------------|-----------------|
| 役割 | インフラ構築ツール（テンプレート実行エンジン） | 標準テンプレートを配布・制御する仕組み |
| 操作対象 | 開発者・インフラ担当者 | 一般ユーザー・非技術者も含む |
| 実行単位 | Stack（1テンプレート） | Product（複数テンプレートやポートフォリオ） |
| 権限制御 | ユーザーごとにCloudFormation操作権限を設定 | 管理者が「提供できる構成」を定義して安全に公開 |
| GUI操作性 | テンプレート構築に詳しい人向け | ワンクリック構築向けの簡易UI |
| 想定規模 | チーム・プロジェクト単位 | 組織全体・部門単位の配布 |

## CloudFormation

YAML / JSONで「VPC, EC2, S3」などをテンプレート化。

スタックを作成すると、定義通りにAWSリソースが自動で立ち上がる。

例えるなら「AWSの設計図＋施工ロボット」。

### 特徴

- 強力・柔軟・エンジニア向け
- だがテンプレート作成・権限管理は難しい
- 間違えるとリソースを壊すリスクあり

## Service Catalog

CloudFormationを中に使っているが、そのテンプレートをGUIで「安全に配布・実行」できる仕組み。

管理者が「Product（テンプレート）」を用意し、ユーザーは「Launch」ボタンを押すだけで構築可能。

### 特徴

- CloudFormationのラッパー（上位レイヤー）
- 非技術者でも使える「セルフサービス構築環境」
- IAMやポリシーで「使っていいテンプレート」を制御できる

## アーキテクチャ図

```
┌──────────────────────┐
│ AWS Service Catalog │  ← 管理者が「配布」する層
│  ├── Product（CFnテンプレート）     │
│  └── Portfolio（Productの集合）      │
└──────────────────────┘
              ↓（内部で実行）
┌──────────────────────┐
│ AWS CloudFormation   │  ← 実際に構築を「実行」する層
│  ├── Stack（テンプレート単位）       │
│  └── StackSet（複数アカウント適用） │
└──────────────────────┘
```

## Service Catalog は「CloudFormationのラッパー」

```
[ユーザー] ─ GUI操作（Launch）
     ↓
[AWS Service Catalog]
     ├── Product（CloudFormationテンプレートを内部に持つ）
     ├── Portfolio（複数Productをまとめる）
     └── 実行時にCloudFormationを呼び出す
             ↓
[CloudFormation]
     ├── Stackを作成
     ├── 指定されたExecutionRoleで実行
     └── AWSリソースを構築（EC2, VPCなど）
```

Service Catalogは「CloudFormationを安全に呼び出す仕組み」であり、実際にリソースを作っているのはCloudFormation。

---

# CloudFormation Execution Role

## 実行の流れ

```
あなた（User）
   │
   ├─ CloudFormationスタック作成要求
   ↓
CloudFormationサービス
   │
   ├─ 指定された IAMロールを一時的にAssume（引き受け）
   ↓
   └─ そのロールの権限でリソースを作成（EC2, VPCなど）
```

指定するロールを「CloudFormation 実行ロール（Execution Role）」と呼ぶ。

## CloudFormation Execution Role の詳細

| 項目 | 内容 |
|-----|------|
| 名前 | CloudFormation Execution Role |
| タイプ | IAMロール（サービスプリンシパル：cloudformation.amazonaws.com） |
| 目的 | CloudFormationがAWSリソースを作成・更新・削除できるようにする |
| 指定方法 | スタック作成画面の「アクセス許可 - オプション」でロールを選択 |

## 権限の「二段構え」

CloudFormationでは、「スタックを作る人の権限」と「リソースを実際に作る権限」を分けられる。

| フェーズ | 使われる権限 | 主な操作 |
|---------|------------|---------|
| スタックの作成・更新 | 強めのIAM権限（ユーザー or ロール） | CloudFormationスタックを起動する |
| リソースの構築（EC2, VPCなど） | CloudFormationがAssumeする「実行ロール」 | AWS APIを呼び出してリソースを作る |

### 運用のポイント

- **構築時**: CloudFormationが強い権限で一気に構築
- **運用時**: 人間は安全な権限範囲で管理
