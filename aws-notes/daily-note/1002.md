# EC2 Instance Role

EC2 Instance Role は1つだけ付けられる。そのロールに「S3アクセス用」「DynamoDBアクセス用」「SSMアクセス用」など複数のポリシーをまとめて付与すればよい。

---

## クロスアカウントロールの仕組み

### 基本概念

アカウントA にいるユーザー（またはIAMロール）が、アカウントB のリソースにアクセスしたい場合:

1. **アカウントB 側**で「このロールをアカウントAから引き受けられるようにする（信頼ポリシー）」を設定
2. **アカウントAのユーザー**がSTSの AssumeRole API を実行
3. **STSが一時的な認証情報を発行**し、ユーザーはその認証情報を使ってアカウントBのリソースにアクセス可能

### 例（アカウントAからアカウントBのS3にアクセス）

#### 1. アカウントB側（リソースがある方）

IAMロールを作って、信頼ポリシーでアカウントAを許可:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "AWS": "arn:aws:iam::111122223333:root"   // アカウントAのID
      },
      "Action": "sts:AssumeRole"
    }
  ]
}
```

このロールに「S3読み取り」などの権限ポリシーを付与

#### 2. アカウントA側（アクセスする方）

ユーザーは AssumeRole を実行:

```bash
aws sts assume-role \
  --role-arn arn:aws:iam::444455556666:role/CrossAccountS3ReadRole \
  --role-session-name TestSession
```

返ってくるのは一時的なキー:

```json
{
  "Credentials": {
    "AccessKeyId": "ASIA...",
    "SecretAccessKey": "abcd1234...",
    "SessionToken": "....",
    "Expiration": "2025-10-02T12:34:56Z"
  }
}
```

これを環境変数にセットすれば、アカウントBのS3にアクセス可能

### ポイント整理

- **信頼ポリシー（誰がAssumeできるか）** と **アクセス許可ポリシー（何ができるか）** の両方が必要
- クロスアカウントでは、アカウント間で「ロールを借りる」イメージ
- STSが一時的に認証情報を発行するので、セキュリティ的に安全

クロスアカウントロールは「自分のアカウントのユーザー/ロールが、別アカウントにあるIAMロールをSTS経由で一時的に引き受けてリソースにアクセスする仕組み」

---

## IAM 明示的なDenyは最優先

Allow と Deny が両方マッチした場合 → **Deny が優先される**

---

## IAM ベストプラクティス

### 最小権限の原則 (Least Privilege)

- 必要な操作だけを許可
- 「フルアクセスを全部許す」よりも、細かく必要なActionやResourceだけを指定する方が安全

### Access Advisor

- そのIAMユーザーやロールがどのサービスをいつ使ったかを確認できる機能
- 実際に使っていない権限を削るときに役立つ

### Access Analyzer

外部アカウントに共有されているリソース（例: 他アカウントからアクセス可能なS3バケット）がないかをチェックするツール

---

## Access Advisor詳細

### 概要

- **公式名称**: IAM Access Advisor
- IAMユーザーやIAMロールの詳細画面に表示されるタブで使用可能
- そのユーザー／ロールがどのAWSサービスにアクセスできるポリシーを持っているか、そして最後にそのサービスを使ったのはいつかが分かる

### 具体的にできること

- あるユーザーが「S3フルアクセス」と「DynamoDBフルアクセス」を持っていたとしても、実際に使っているのがS3だけなら「DynamoDBは使われていない」と表示される
- これを見れば「不要な権限を外す」判断ができる
- 最小権限の原則（least privilege）を実現するのに便利

### 制限事項

- **サービス単位の情報しか分からない**
  - 例: 「S3を最後に使ったのは1週間前」と出るが、どのS3バケットにアクセスしたかまでは分からない
- CloudTrailと併用すれば「どの操作をしたか」まで確認可能

---

## IAM Access Analyzer

### 概要

AWSアカウント内のリソースが「外部からアクセス可能になっていないか」を検出する機能

2019年にリリースされた比較的新しい機能で、IAMの中の機能として提供

### 何ができる？

Access Analyzerは、以下のような「外部アクセス可能なリソース」を自動的に検出:

#### S3バケット
- 誰でもアクセス可能 (Principal = *)
- 他アカウントからアクセス可能

#### IAMロール
- 別アカウントや外部IDプロバイダにAssumeRoleされる設定がある

#### KMSキー
- 他アカウントに利用される可能性がある

#### その他
- Lambda関数、SQSキュー、Secrets Managerシークレット など

要するに「セキュリティ的に危ない公開設定」を見つけてくれる監査機能

### 動作の仕組み

- Access Analyzerは数理論理 (Automated Reasoning) を使ってポリシーを解析
- リソースポリシーを解析して「外部エンティティにアクセス権があるか？」をチェック
- 結果は「Findings（検出結果）」として表示

### Access Advisor vs Access Analyzer

#### Access Advisor
- 「ユーザーやロールがどのサービスを実際に使ったか」を可視化
- 不要な権限を削るのに役立つ

#### Access Analyzer
- 「リソースが外部に晒されていないか」を解析
- セキュリティ監査・外部アクセスの検出に役立つ

## Resource-based Policy

### 概要

IAMユーザーやIAMロールに付ける「アイデンティティベースポリシー」と違って、**リソース側に直接設定するポリシー**

「このリソースに対して、誰（Principal）がどんな操作をできるか」をリソース自身が管理する仕組み

### シナリオ

- **アカウントA**: DynamoDBテーブルを持っている
- **アカウントB**: S3バケットを持っている
- **やりたいこと**: アカウントAのユーザーが DynamoDB をスキャンして、そのデータをアカウントBの S3 バケットに保存したい

### 選択肢の比較

#### ① IAM Role を使う場合

1. アカウントBで「クロスアカウント用のロール」を作成し、アカウントAにAssumeを許可
2. アカウントAのユーザーはそのロールを引き受け、一時的にアカウントBの権限を得てS3に書き込む
3. **問題**: DynamoDBはアカウントAにあるので、AssumeRole中はAの権限を失い → DynamoDBに直接アクセスできない
4. **解決方法**: 「一時的にロールを切り替えて、Bに出力する処理」を別ステップに分ける必要がある

**ポイント**: Roleは「切り替え」方式なので、元のDynamoDB操作とBのS3書き込みを同じセッションでやるのは難しい

#### ② Resource-based Policy を使う場合

1. アカウントBのS3バケットポリシーに「アカウントAのユーザーを許可する」設定を書く
2. アカウントAのユーザーは自分の権限（DynamoDBへのアクセス権）を維持したまま、BのS3にも書き込める
3. 1つの処理で「DynamoDBスキャン → S3書き込み」ができる

**ポイント**: Resource-based Policyは「追加」方式なので、両方の操作を同時に行える

### まとめ

#### IAM Role (切り替え)
- 片方の権限にスイッチ
- 役割を完全に切り替えて別アカウントの作業をするときに便利

#### Resource-based Policy (追加)
- 元の権限を維持しつつリソース側が受け入れる
- 「自分のアカウントの操作もしつつ、別アカウントのリソースも触りたい」場合に有効

## IAMポリシーの種類

両者は別の設定欄で管理される

### Identity-based Policy

- 「ユーザー／ロール／グループ」に直接アタッチするポリシー
- ここで「S3 フルアクセス」「EC2 読み取り専用」などを付ける
- 実際にその人が**何をできるか**を定義

### Permission Boundary

- ユーザー／ロールの作成時に「アクセス許可の境界」という別欄で設定
- ここで「最大でも S3 関連しか触れない」といった**上限フィルター**をかける
- あくまで制限なので、Boundary だけでは権限は与えられない