# Kubernetes Secrets と KMS

## 概要
Kubernetes SecretsはEKS（AWSのマネージドKubernetes）に限らず、Kubernetesそのものの標準機能。

## Kubernetes Secrets と KMS の関係

### Kubernetes Secrets
- Kubernetes標準の「シークレットをetcdに保存してPodにマウントできる仕組み」
- そのままだとBase64エンコードされるだけで暗号化されない
- セキュリティ要件が厳しい環境では「暗号化して保存されていないのは問題」とされる

### EKS + KMSによる暗号化
- EKSはオプションでKubernetes Secretsを保存するetcdをKMSで暗号化可能
- Kubernetes Secretsを使いつつ、KMSでセキュアにするのが正解
- 「KMSを直接使う」のではなく、「Kubernetes SecretsをKMSで守る」イメージ

---

# クエリ処理
クエリ処理といえばAmazon Managed Service for Apache Flink

---

# IAMポリシー vs SCP

## IAMポリシーとは

- **目的**：ユーザーやロールに「権限を付与する」もの
- **適用範囲**：そのアカウント内のIAMユーザー/IAMロール
- **イメージ**：「この人はS3の一覧を見てもいいよ」と直接権限をあげる

## SCP（Service Control Policy）とは

- **目的**：OUやアカウント全体に対して「使える権限の上限（ガードレール）を定める」もの
- **適用範囲**：AWS Organizations配下のアカウント

### 特徴
- SCPだけでは権限は与えられない
- IAMポリシーで許可されていても、SCPで禁止されていれば使えない
- 逆にSCPで許可されていても、IAMポリシーで許可されてなければ使えない

**まとめ**：
- IAMポリシー = 個人に権限を渡す
- SCP = 組織の上限を決める

## SCP例

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "ec2:*",
        "IAM:*",
        "cloudwatch:*"
      ],
      "Resource": "*"
    }
  ]
}
```

### 結果
このOU配下のアカウントは：
- EC2とIAMとCloudWatchだけ「上限として使える」
- それ以外のサービス（S3, RDS, Lambda等）はSCPで拒否される

**重要**：SCPは権限付与の『天井』を設定するだけ。実際の権限はIAMポリシーで設定する。